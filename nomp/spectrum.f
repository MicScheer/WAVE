*CMZ :          04/07/2023  11.46.46  by  Michael Scheer
*CMZ :  4.01/03 01/07/2023  10.08.32  by  Michael Scheer
*CMZ :  4.01/02 14/05/2023  13.25.57  by  Michael Scheer
*CMZ :  4.01/00 05/12/2022  10.23.29  by  Michael Scheer
*CMZ :  4.00/17 15/11/2022  10.09.14  by  Michael Scheer
*CMZ :  4.00/15 31/05/2022  09.04.28  by  Michael Scheer
*CMZ :  4.00/13 07/12/2021  18.47.10  by  Michael Scheer
*CMZ :  4.00/11 15/06/2021  12.33.13  by  Michael Scheer
*CMZ :  4.00/10 03/09/2020  13.24.08  by  Michael Scheer
*CMZ :  4.00/07 26/06/2020  10.05.00  by  Michael Scheer
*CMZ :  4.00/05 29/11/2019  17.42.27  by  Michael Scheer
*CMZ :  4.00/04 27/08/2019  11.49.27  by  Michael Scheer
*CMZ :  3.08/01 03/04/2019  16.22.16  by  Michael Scheer
*CMZ :  3.07/01 29/03/2019  15.08.52  by  Michael Scheer
*CMZ :  3.07/00 14/03/2019  15.32.16  by  Michael Scheer
*CMZ :  3.06/00 19/02/2019  11.45.45  by  Michael Scheer
*CMZ :  3.05/14 28/09/2018  12.28.08  by  Michael Scheer
*CMZ :  3.05/10 13/08/2018  14.40.26  by  Michael Scheer
*CMZ :  3.05/06 17/07/2018  11.15.17  by  Michael Scheer
*CMZ :  3.05/03 17/05/2018  08.46.21  by  Michael Scheer
*CMZ :  3.05/02 09/05/2018  12.55.31  by  Michael Scheer
*CMZ :  3.03/02 04/05/2018  13.55.11  by  Michael Scheer
*CMZ :  3.03/01 12/11/2015  10.13.14  by  Michael Scheer
*CMZ :  3.02/07 22/06/2015  15.01.50  by  Michael Scheer
*CMZ :  3.02/06 15/04/2015  12.01.22  by  Michael Scheer
*CMZ :  3.02/03 07/11/2014  17.09.23  by  Michael Scheer
*CMZ :  3.02/00 18/09/2014  15.43.00  by  Michael Scheer
*CMZ :  3.01/00 03/07/2013  15.42.09  by  Michael Scheer
*CMZ :  3.00/00 11/03/2013  15.12.11  by  Michael Scheer
*CMZ :  2.70/12 01/03/2013  16.28.24  by  Michael Scheer
*CMZ :  2.70/11 21/02/2013  10.24.53  by  Michael Scheer
*CMZ :  2.70/05 02/01/2013  14.04.56  by  Michael Scheer
*CMZ :  2.70/04 21/12/2012  12.38.11  by  Michael Scheer
*CMZ :  2.69/00 30/10/2012  14.15.43  by  Michael Scheer
*CMZ :  2.68/05 18/10/2012  14.25.09  by  Michael Scheer
*CMZ :  2.68/02 05/07/2012  11.19.57  by  Michael Scheer
*CMZ :  2.68/01 29/05/2012  09.43.05  by  Michael Scheer
*CMZ :  2.68/00 25/05/2012  16.32.34  by  Michael Scheer
*CMZ :  2.67/04 11/05/2012  15.40.01  by  Michael Scheer
*CMZ :  2.66/18 02/12/2010  14.59.07  by  Michael Scheer
*CMZ :  2.66/16 22/11/2010  14.01.42  by  Michael Scheer
*CMZ :  2.66/13 18/06/2010  14.17.37  by  Michael Scheer
*CMZ :  2.66/09 12/05/2010  13.34.28  by  Michael Scheer
*CMZ :  2.66/08 15/03/2010  15.14.36  by  Michael Scheer
*CMZ :  2.66/07 10/03/2010  09.03.13  by  Michael Scheer
*CMZ :  2.66/06 24/02/2010  17.11.25  by  Michael Scheer
*CMZ :  2.66/04 18/11/2009  10.22.04  by  Michael Scheer
*CMZ :  2.66/03 12/11/2009  16.27.11  by  Michael Scheer
*CMZ :  2.66/00 23/10/2009  09.19.41  by  Michael Scheer
*CMZ :  2.65/03 02/10/2009  13.09.16  by  Michael Scheer
*CMZ :  2.65/02 29/09/2009  12.00.20  by  Michael Scheer
*CMZ :  2.64/07 17/09/2009  15.40.31  by  Michael Scheer
*CMZ :  2.64/06 15/09/2009  15.08.58  by  Michael Scheer
*CMZ :  2.64/05 14/09/2009  15.19.42  by  Michael Scheer
*CMZ :  2.64/01 19/08/2009  08.45.04  by  Michael Scheer
*CMZ :  2.64/00 14/08/2009  14.25.09  by  Michael Scheer
*CMZ :  2.63/05 12/08/2009  08.49.28  by  Michael Scheer
*CMZ :  2.62/03 16/07/2007  12.15.22  by  Michael Scheer
*CMZ :  2.62/02 16/07/2007  07.31.52  by  Michael Scheer
*CMZ :  2.61/01 15/03/2007  11.13.54  by  Michael Scheer
*CMZ :  2.57/04 01/02/2006  12.28.09  by  Michael Scheer
*CMZ :  2.57/01 22/11/2005  13.07.59  by  Michael Scheer
*CMZ :  2.56/01 17/10/2005  14.36.43  by  Michael Scheer
*CMZ :  2.56/00 17/10/2005  13.26.33  by  Michael Scheer
*CMZ :  2.54/05 26/05/2005  08.07.59  by  Michael Scheer
*CMZ :  2.53/05 17/02/2005  14.00.32  by  Michael Scheer
*CMZ :  2.52/16 19/01/2005  10.32.23  by  Michael Scheer
*CMZ :  2.52/13 10/12/2004  10.43.51  by  Michael Scheer
*CMZ :  2.52/11 08/12/2004  13.11.32  by  Michael Scheer
*CMZ :  2.52/10 05/11/2004  15.45.33  by  Michael Scheer
*CMZ :  2.52/01 30/06/2004  16.42.15  by  Michael Scheer
*CMZ :  2.52/00 29/06/2004  11.53.01  by  Michael Scheer
*CMZ :  2.51/02 22/06/2004  09.06.04  by  Michael Scheer
*CMZ :  2.51/01 17/06/2004  11.33.47  by  Michael Scheer
*CMZ :  2.51/00 26/05/2004  15.54.25  by  Michael Scheer
*CMZ :  2.50/02 30/04/2004  15.27.49  by  Michael Scheer
*CMZ :  2.50/00 29/04/2004  17.07.16  by  Michael Scheer
*CMZ :  2.49/00 22/03/2004  13.30.23  by  Michael Scheer
*CMZ :  2.47/09 20/05/2003  14.31.10  by  Michael Scheer
*CMZ :  2.47/05 25/03/2003  12.09.15  by  Michael Scheer
*CMZ :  2.47/01 10/03/2003  11.54.47  by  Michael Scheer
*CMZ :  2.46/02 07/03/2003  11.02.34  by  Michael Scheer
*CMZ :  2.44/01 21/11/2002  16.45.47  by  Michael Scheer
*CMZ :  2.44/00 15/11/2002  18.31.22  by  Michael Scheer
*CMZ :  2.41/11 21/08/2002  11.23.26  by  Michael Scheer
*CMZ :  2.41/09 14/08/2002  17.20.18  by  Michael Scheer
*CMZ :  2.41/07 31/05/2002  16.37.13  by  Michael Scheer
*CMZ :  2.38/00 12/12/2001  18.21.12  by  Michael Scheer
*CMZ :  2.35/02 30/10/2001  17.06.49  by  Michael Scheer
*CMZ :  2.34/09 26/09/2001  17.14.17  by  Michael Scheer
*CMZ :  2.34/00 11/05/2001  17.06.33  by  Michael Scheer
*CMZ :  2.33/04 04/05/2001  11.31.09  by  Michael Scheer
*CMZ :  2.33/01 03/05/2001  13.48.25  by  Michael Scheer
*CMZ :  2.33/00 03/05/2001  10.49.22  by  Michael Scheer
*CMZ :  2.31/01 25/04/2001  14.38.57  by  Michael Scheer
*CMZ :  2.31/00 24/04/2001  11.16.55  by  Michael Scheer
*CMZ :  2.30/01 12/04/2001  12.43.20  by  Michael Scheer
*CMZ :  2.20/11 11/04/2001  13.15.39  by  Michael Scheer
*CMZ :  2.20/10 04/04/2001  16.52.12  by  Michael Scheer
*CMZ :  2.20/09 03/04/2001  14.51.24  by  Michael Scheer
*CMZ :  2.20/04 09/03/2001  19.13.21  by  Michael Scheer
*CMZ :  2.20/03 23/02/2001  14.46.53  by  Michael Scheer
*CMZ :  2.20/01 19/02/2001  10.53.35  by  Michael Scheer
*CMZ :  2.17/00 06/11/2000  17.32.34  by  Michael Scheer
*CMZ :  2.16/08 01/11/2000  18.52.39  by  Michael Scheer
*CMZ :  2.16/07 17/10/2000  11.06.19  by  Michael Scheer
*CMZ :  2.16/06 28/08/2000  16.04.39  by  Michael Scheer
*CMZ :  2.16/05 02/08/2000  13.56.30  by  Michael Scheer
*CMZ :  2.16/04 20/07/2000  15.20.32  by  Michael Scheer
*CMZ :  2.16/03 16/06/2000  14.59.25  by  Michael Scheer
*CMZ :  2.16/01 15/06/2000  16.12.25  by  Michael Scheer
*CMZ :  2.16/00 13/06/2000  14.00.28  by  Michael Scheer
*CMZ :  2.15/00 06/05/2000  11.15.11  by  Michael Scheer
*CMZ :  2.13/10 06/04/2000  13.55.09  by  Michael Scheer
*CMZ :  2.13/08 28/02/2000  10.59.59  by  Michael Scheer
*CMZ :  2.13/07 17/02/2000  15.11.13  by  Michael Scheer
*CMZ :  2.13/04 21/01/2000  14.49.57  by  Michael Scheer
*CMZ :  2.13/03 18/01/2000  17.58.11  by  Michael Scheer
*CMZ :  2.13/02 14/12/99  16.47.46  by  Michael Scheer
*CMZ :  2.13/00 02/12/99  13.19.08  by  Michael Scheer
*CMZ :  2.12/04 20/08/99  11.42.59  by  Michael Scheer
*CMZ :  2.12/03 08/07/99  10.46.11  by  Michael Scheer
*CMZ :  2.12/02 15/06/99  16.10.08  by  Michael Scheer
*CMZ :  2.12/01 14/06/99  15.26.07  by  Michael Scheer
*CMZ :  2.12/00 03/06/99  15.38.11  by  Michael Scheer
*CMZ :  2.11/01 18/05/99  10.04.01  by  Michael Scheer
*CMZ :  2.11/00 12/05/99  11.35.36  by  Michael Scheer
*CMZ :  2.10/01 19/03/99  11.45.33  by  Michael Scheer
*CMZ :  2.02/00 12/02/99  16.13.41  by  Michael Scheer
*CMZ :  2.00/00 06/01/99  11.58.17  by  Michael Scheer
*CMZ :  1.04/03 11/12/98  16.35.36  by  Michael Scheer
*CMZ :  1.04/02 11/12/98  11.35.23  by  Michael Scheer
*CMZ :  1.04/01 11/12/98  11.21.18  by  Michael Scheer
*CMZ :  1.04/00 05/10/98  15.04.38  by  Michael Scheer
*CMZ :  1.03/06 25/09/98  11.00.44  by  Michael Scheer
*CMZ :  1.03/03 24/02/98  12.03.00  by  Michael Scheer
*CMZ :  1.03/02 18/02/98  16.56.26  by  Michael Scheer
*CMZ :  1.03/01 16/01/98  16.52.08  by  Michael Scheer
*CMZ :  1.02/03 16/01/98  10.58.48  by  Michael Scheer
*CMZ :  1.00/00 05/08/97  15.02.55  by  Michael Scheer
*CMZ : 00.02/05 25/03/97  13.44.31  by  Michael Scheer
*CMZ : 00.02/04 26/02/97  12.24.14  by  Michael Scheer
*CMZ : 00.02/03 16/01/97  11.07.55  by  Michael Scheer
*CMZ : 00.02/02 15/01/97  13.14.58  by  Michael Scheer
*CMZ : 00.01/12 04/11/96  11.52.18  by  Michael Scheer
*CMZ : 00.01/10 16/07/96  15.25.52  by  Michael Scheer
*CMZ : 00.01/09 01/09/95  13.05.18  by  Michael Scheer
*CMZ : 00.01/08 22/06/95  18.18.43  by  Michael Scheer
*CMZ : 00.01/07 24/02/95  11.21.39  by  Michael Scheer
*CMZ : 00.01/06 02/02/95  19.03.32  by  Michael Scheer
*CMZ : 00.01/05 31/01/95  15.35.41  by  Michael Scheer
*CMZ : 00.01/04 26/01/95  16.20.02  by  Michael Scheer
*CMZ : 00.01/02 18/11/94  18.37.44  by  Michael Scheer
*CMZ : 00.00/07 25/05/94  16.45.07  by  Michael Scheer
*CMZ : 00.00/05 29/04/94  20.07.34  by  Michael Scheer
*CMZ : 00.00/04 29/04/94  17.54.43  by  Michael Scheer
*CMZ : 00.00/00 28/04/94  16.11.39  by  Michael Scheer
*-- Author : Michael Scheer
      SUBROUTINE SPECTRUM
*KEEP,gplhint.
!******************************************************************************
!
!      Copyright 2013 Helmholtz-Zentrum Berlin (HZB)
!      Hahn-Meitner-Platz 1
!      D-14109 Berlin
!      Germany
!
!      Author Michael Scheer, Michael.Scheer@Helmholtz-Berlin.de
!
! -----------------------------------------------------------------------
!
!    This program is free software: you can redistribute it and/or modify
!    it under the terms of the GNU General Public License as published by
!    the Free Software Foundation, either version 3 of the License, or
!    (at your option) any later version.
!
!    This program is distributed in the hope that it will be useful,
!    but WITHOUT ANY WARRANTY; without even the implied warranty of
!    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
!    GNU General Public License for more details.
!
!    You should have received a copy (wave_gpl.txt) of the GNU General Public
!    License along with this program.
!    If not, see <http://www.gnu.org/licenses/>.
!
!    Dieses Programm ist Freie Software: Sie koennen es unter den Bedingungen
!    der GNU General Public License, wie von der Free Software Foundation,
!    Version 3 der Lizenz oder (nach Ihrer Option) jeder spaeteren
!    veroeffentlichten Version, weiterverbreiten und/oder modifizieren.
!
!    Dieses Programm wird in der Hoffnung, dass es nuetzlich sein wird, aber
!    OHNE JEDE GEWAEHRLEISTUNG, bereitgestellt; sogar ohne die implizite
!    Gewaehrleistung der MARKTFAEHIGKEIT oder EIGNUNG FueR EINEN BESTIMMTEN ZWECK.
!    Siehe die GNU General Public License fuer weitere Details.
!
!    Sie sollten eine Kopie (wave_gpl.txt) der GNU General Public License
!    zusammen mit diesem Programm erhalten haben. Wenn nicht,
!    siehe <http://www.gnu.org/licenses/>.
!
!******************************************************************************
*KEND.

C--- MAIN ROUTINE TO CALCULATE SYNCHROTRON RADIATION SPECTRA

*KEEP,trackf90u.
      include 'trackf90u.cmn'
*KEEP,spectf90u.
      include 'spectf90u.cmn'
*KEEP,sourcef90u.
      include 'sourcef90u.cmn'
*KEEP,observf90u.
      include 'observf90u.cmn'
*KEEP,reargf90u.
      include 'reargf90u.cmn'
*KEEP,wfoldf90u.
      include 'wfoldf90u.cmn'
*KEEP,afreqf90u.
      include 'afreqf90u.cmn'
*KEEP,amplif90u.
      include 'amplif90u.cmn'
*KEND.

      use clustermod
      use bunchmod
      use ompmod
      use uradphasemod
      !use waveenv

      IMPLICIT NONE

*KEEP,cmpara.
      include 'cmpara.cmn'
*KEEP,contrl.
      include 'contrl.cmn'
*KEEP,myfiles.
      include 'myfiles.cmn'
*KEEP,track.
      include 'track.cmn'
*KEEP,optic.
      include 'optic.cmn'
*KEEP,sourcef90.
      include 'sourcef90.cmn'
*KEEP,freqs.
      include 'freqs.cmn'
*KEEP,observf90.
      include 'observf90.cmn'
*KEEP,spect.
      include 'spect.cmn'
*KEEP,specdip.
      include 'specdip.cmn'
*KEEP,colli.
      include 'colli.cmn'
*KEEP,wfoldf90.
      include 'wfoldf90.cmn'
*KEEP,depola.
      include 'depola.cmn'
*KEEP,wusem.
      include 'wusem.cmn'
*KEEP,ampli.
      include 'ampli.cmn'
*KEEP,uservar.
      include 'uservar.cmn'
*KEEP,phycon.
      include 'phycon.cmn'
*KEEP,primkin.
      include 'primkin.cmn'
*KEEP,datetime.
      include 'datetime.cmn'
*KEEP,debugwave.
      include 'debugwave.cmn'
*KEEP,waveenv.
      include 'waveenv.cmn'
*KEND.

      INTEGER ISOUR,IS,IFR,IO,IX,IC,JC,IZ,IY,IFREQ,IOBSV,IBUFF
      INTEGER ICEN,ISTO,MSADD,IFAIL,I,ISTOK
      INTEGER NTOTIN,NTOT2IN,IREP,ipino,ibuncho,ihbuncho,mbuncho,meinbuncho

      REAL*4 POL,rr(2)
      REAL*4 THERAY,PHIRAY,RAY,ZRAY,YRAY,DRAY,RAY1,RAY2,RAY3,RAY1N,RAY2N,RAY3N

      DOUBLE PRECISION ENEDOSMX,S1,S2,S3,S4,DUM1,DUM2,RMS
      DOUBLE PRECISION WSNOBFR1(NDFREQP),WSNOBFR2(NDFREQP),SPECBUFF(NDFREQP)

      WRITE(LUNGFO,*)
      WRITE(LUNGFO,*)'     SPECTRUM'
      WRITE(LUNGFO,*)'     ==========='
      WRITE(LUNGFO,*)

      ipino=ipin
      ibuncho=ibunch
      mbuncho=nbunch
      meinbuncho=neinbunch
      ihbuncho=ihbunch
      if (kampli.ne.0) then
        ibunch=0
        ihbunch=0
      endif

      if (ispecmode.ne.3.and.ispecmode.ne.1.and.ispecmode.ne.2) then
        write(6,*)
     &    '*** ERROR IN SPECTRUM: ISPECMODE must be 1, 2, or 3***'
        write(LUNGFO,*)
     &    '*** ERROR IN SPECTRUM: ISPECMODE must be 1, 2, or 3***'
        stop '*** PROGRAM WAVE ABORTED ***'
      endif

      if (ipin.eq.3.and.ispecmode.ne.1.and.ispecmode.ne.2) then
        write(LUNGFO,*)
     &    '*** ERROR IN SPECTRUM: For IPIN=3, ISPECMODE must be 1 or 2 ***'
        write(6,*)
     &    '*** ERROR IN SPECTRUM: For IPIN=3, ISPECMODE must be 1 or 2 ***'
        stop
      endif

      IF (ISPECDIP.GT.0.and.ibrill.ne.0) THEN
        write(6,*)'*** WARNING IN SPECTRUM: ISPECDIP.gt.0 and IBRILL.ne.0'
        write(6,*)'*** IBRILL SET TO ZERO ***'
        write(LUNGFO,*)'*** WARNING IN SPECTRUM: ISPECDIP.gt.0 and IBRILL.ne.0'
        write(lungfo,*)'*** IBRILL SET TO ZERO ***'
        IBRILL=0
      endif

      IF (ISPECDIP.GT.0.and.ifold.ne.0) THEN
        write(6,*)'*** WARNING IN SPECTRUM: ISPECDIP.gt.0 and IFOLD.ne.0'
        write(6,*)'*** IFOLD SET TO ZERO ***'
        write(LUNGFO,*)'*** WARNING IN SPECTRUM: ISPECDIP.gt.0 and IFOLD.ne.0'
        write(lungfo,*)'*** IFOLD SET TO ZERO ***'
        ifold=0
        ihfold=0
      endif

      IF (ISPECDIP.GT.0.and.IEFOLD.ne.0) THEN
        write(6,*)'*** WARNING IN SPECTRUM: ISPECDIP.gt.0 and IEFOLD.ne.0'
        write(6,*)'*** IEFOLD SET TO ZERO ***'
        write(LUNGFO,*)'*** WARNING IN SPECTRUM: ISPECDIP.gt.0 and IEFOLD.ne.0'
        write(lungfo,*)'*** IEFOLD SET TO ZERO ***'
        IEFOLD=0
      endif

      IF (ISPECDIP.eq.2.and.if1dim.eq.0) THEN
        write(LUNGFO,*)'*** WARNING IN SPECTRUM: ISPECDIP.eq.2 and IF1DIM.eq.0'
        write(LUNGFO,*)'*** IF1DIM SET TO ONE ***'
        write(6,*)'*** WARNING IN SPECTRUM: ISPECDIP.eq.2 and IF1DIM.eq.0'
        write(6,*)'*** IF1DIM SET TO ONE ***'
        If1dim=1
      endif

      IF (ISPECMODE.gt.2.and.mpinr.ne.0) THEN
        WRITE(LUNGFO,*)' '
        WRITE(LUNGFO,*)
     &    '*** WARNING IN SPECTRUM: ISPECMODE .gt. 2 .and. MPINR .ne. 0'
        WRITE(LUNGFO,*)'*** MPINR will be ignored and set to zero'
        WRITE(LUNGFO,*)' '
        WRITE(6,*)' '
        WRITE(6,*)
     &    '*** WARNING IN SPECTRUM: ISPECMODE .gt. 2 .and. MPINR .ne. 0'
        WRITE(6,*)'*** MPINR will be ignored and set to zero'
        WRITE(6,*)' '
c        mpinr=0
      endif
c 20150622{
c      IF (IFREQ2P.EQ.0.AND.ISPECMODE.LT.3) THEN
c
c        WRITE(LUNGFO,*)
c     &    '*** WARNING IN SPECTRUM: Option IFREQ2P=0 NOT available for ISPECMODE<3'
c        WRITE(LUNGFO,*)
c     &    '*** ISPECMODE set to 3'
c        WRITE(LUNGFO,*)''
c
c        WRITE(6,*)
c     &    '*** WARNING IN SPECTRUM: Option IFREQ2P=0 NOT available for ISPECMODE<3'
c        WRITE(6,*)
c     &    '*** ISPECMODE set to 3'
c        WRITE(6,*)''
c
c        ISPECMODE=3
c
c 20150622}      ENDIF

      IF (ibunch.ne.0) THEN
        write(lungfo,*)'      Bunch parameters:'
        write(lungfo,*)'      mode IUBUNCH:                    ',IUBUNCH
        write(lungfo,*)'      number of bunches NBUNCH:        ',NBUNCH
        write(lungfo,*)'      number of e- per bunch NEINBUNCH:',NEINBUNCH
        write(lungfo,*)'      bunch length [m]: BUNCHLEN:      ',BUNCHLEN
        write(lungfo,*)'      bunch charge [C]: BUNCHCHARGE:   ',BUNCHCHARGE
        WRITE(lungfo,*)''
        WRITE(lungfo,*)''
      endif

      IF (ISPECDIP.LE.0) THEN

        WRITE(LUNGFO,*)
     &    '     Start and end of points [m] of integration for spectrum'
        WRITE(LUNGFO,*)'     calculations (XIANF,XIEND):'
     &    ,SNGL(XIANF),SNGL(XIEND)
        WRITE(LUNGFO,*)

        IF ((XIANF.NE.XSTART.OR.XIEND.NE.XSTOP)
     &      .AND.XIANF.NE.-1.D30.AND.XIEND.NE.1.D30) THEN
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      ' *** Start or end of points (XIANF,XIEND) of integration differ'
          WRITE(LUNGFO,*)
     &      ' *** from XSTART or XSTOP respectively'
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
          WRITE(6,*)
          WRITE(6,*)
     &      ' *** Start or end of points (XIANF,XIEND) of integration differ'
          WRITE(6,*)
     &      ' *** from XSTART or XSTOP respectively'
          WRITE(6,*)
          WRITE(6,*)
        ENDIF

      ENDIF !ISPECDIP.LE.0

      IF (IWFILINT.GT.0) THEN
        OPEN(UNIT=LUNINT,FILE=FILEINT)
      ENDIF !IWFILINT

C--- NEW VERSION OF TRACKS REQUIRES IMAGSPLN

      IF (ISPECMODE.EQ.3) IMAGSPLN=-999

C----   FREQUENCES TO BE TREATED

      CALL RFILFR

C--- NOW WE ARE DEALING WITH PHOTON ENERGIES

C260194  IF (IUNIT.NE.0) CALL CONVUN

C---  DEFAULTS FOR WGWINFC

      if (pinr.eq.-9999.) pinr=max(pinw,pinh)/2.0d0
      if (pinr.eq.9999.) pinr=sqrt(pinw*pinh/pi1)
      IF (WGWINFC.EQ.9999.AND.IUNDULATOR.EQ.0) CALL SETWGWIN

C---  DEFAULTS FOR PINCEN

      IOBSV_A=1
      IOBSVZ_A=1
      IOBSVY_A=1

      ALLOCATE(OBSV(3,IOBSV_A))
      ALLOCATE(OBSVY(IOBSVY_A))
      ALLOCATE(OBSVZ(IOBSVZ_A))

      IF (IPIN.NE.0) THEN
        CALL PINCENIN
      ENDIF

      IF (OBS1X.EQ.-9999.) OBS1X=PINCEN(1)
      IF (aperX.EQ.-9999.) aperx=PINCEN(1)

      if (ipin.eq.0.and.obs1x.le.xstop) then
        write(6,*)
     &    '*** Error: OBS1X (x of observation point) must be bigger than XSTOP'
        write(6,*)
     &    '*** Please check input file'
        write(6,*)
     &    '*** Program WAVE aborted ***'
        stop
      else if (ipin.ne.0.and.pincen(1).le.xstop) then
        write(6,*)
     &    '*** Error: PINCEN(1) (x of pinhole) must be bigger than XSTOP'
        write(6,*)
     &    '*** Please check input file'
        write(6,*)
     &    '*** Program WAVE aborted ***'
        stop
      endif

      IF (OBS1y.EQ.-9999.) then
        OBS1y=ySTART+VyIN/VXIN*(OBS1X-XSTART)
      else IF (obs1y.EQ.-8888.) THEN
        obs1y=yoffstr+yslopetr*obs1x
      else IF (obs1y.EQ.-9000.) THEN
        obs1y=0.0d0
        do i=1,nco
          obs1y=obs1y+
     &      wtra(2,1,i)+wtra(2,2,i)/wtra(1,2,i)*(PINCEN(1)-wtra(1,1,i))
        enddo
        obs1y=obs1y/nco
      ENDIF

      IF (OBS1Z.EQ.-9999.) then
        OBS1Z=ZSTART+VZIN/VXIN*(OBS1X-XSTART)
      else IF (obs1z.EQ.-8888.) THEN
        obs1z=zoffstr+zslopetr*obs1x
      else IF (obs1z.EQ.-9000.) THEN
        obs1z=0.0d0
        do i=1,nco
          obs1z=obs1z+
     &      wtra(3,1,i)+wtra(3,2,i)/wtra(1,2,i)*(PINCEN(1)-wtra(1,1,i))
        enddo
        obs1z=obs1z/nco
      ENDIF

      IF (IPIN.EQ.0) PINCEN(1)=OBS1X

C---  SOURCES OF LIGHT. SOURCES ARE READ OR DEFINED BY COLLIMATOR

      IF (CX1.EQ.9999.) THEN
        IF (IRFILOB.NE.0) THEN
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '*** DEFAULT FOR CX1 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
          WRITE(LUNGFO,*)'*** CHECK INPUT FILE ***'
          WRITE(LUNGFO,*)
          WRITE(6,*)
          WRITE(6,*)
     &      '*** DEFAULT FOR CX1 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
          WRITE(6,*)'*** CHECK INPUT FILE ***'
          WRITE(6,*)
          STOP '*** PROGRAM WAVE ABORTED ***'
        ENDIF
        IF (IPIN.NE.0) THEN
          CX1=PINCEN(1)-0.00001
        ELSE
          CX1=OBS1X-0.00001
        ENDIF
      ENDIF

      IF (CX2.EQ.9999.) THEN
        IF (IRFILOB.NE.0) THEN
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '*** DEFAULT FOR CX2 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
          WRITE(LUNGFO,*)'*** CHECK INPUT FILE ***'
          WRITE(LUNGFO,*)
          WRITE(6,*)
          WRITE(6,*)
     &      '*** DEFAULT FOR CX2 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
          WRITE(6,*)'*** CHECK INPUT FILE ***'
          WRITE(6,*)
          STOP '*** PROGRAM WAVE ABORTED ***'
        ENDIF
        IF (IPIN.NE.0) THEN
          CX2=PINCEN(1)
        ELSE
          CX2=OBS1X
        ENDIF
      ENDIF

      IF (CY1.EQ.9999.) THEN
        IF (IRFILOB.NE.0) THEN
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '*** DEFAULT FOR CY1 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
          WRITE(LUNGFO,*)'*** CHECK INPUT FILE ***'
          WRITE(LUNGFO,*)
          WRITE(6,*)
          WRITE(6,*)
     &      '*** DEFAULT FOR CY1 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
          WRITE(6,*)'*** CHECK INPUT FILE ***'
          WRITE(6,*)
          STOP '*** PROGRAM WAVE ABORTED ***'
        ENDIF
        IF (IPIN.NE.0) THEN
          CY1=PINCEN(2)
        ELSE
          CY1=OBS1Y
        ENDIF
      ENDIF !CY1

       IF (CY2.EQ.9999.) THEN
         IF (IRFILOB.NE.0) THEN
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
     &       '*** DEFAULT FOR CY2 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(LUNGFO,*)'*** CHECK INPUT FILE ***'
           WRITE(LUNGFO,*)
           WRITE(6,*)
           WRITE(6,*)
     &       '*** DEFAULT FOR CY2 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(6,*)'*** CHECK INPUT FILE ***'
           WRITE(6,*)
           STOP '*** PROGRAM WAVE ABORTED ***'
         ENDIF
         IF (IPIN.NE.0) THEN
           CY2=PINCEN(2)
         ELSE
           CY2=OBS1Y
         ENDIF
       ENDIF !CY2

       IF (CZ1.EQ.9999.) THEN
         IF (IRFILOB.NE.0) THEN
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
     &       '*** DEFAULT FOR CZ1 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(LUNGFO,*)'*** CHECK INPUT FILE ***'
           WRITE(LUNGFO,*)
           WRITE(6,*)
           WRITE(6,*)
     &       '*** DEFAULT FOR CZ1 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(6,*)'*** CHECK INPUT FILE ***'
           WRITE(6,*)
           STOP '*** PROGRAM WAVE ABORTED ***'
         ENDIF
         IF (IPIN.NE.0) THEN
           CZ1=PINCEN(3)
         ELSE
           CZ1=OBS1Z
         ENDIF
       ENDIF !CZ1

       IF (CZ2.EQ.9999.) THEN
         IF (IRFILOB.NE.0) THEN
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
     &       '*** DEFAULT FOR CZ2 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(LUNGFO,*)'*** CHECK INPUT FILE ***'
           WRITE(LUNGFO,*)
           WRITE(6,*)
           WRITE(6,*)
     &       '*** DEFAULT FOR CZ2 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(6,*)'*** CHECK INPUT FILE ***'
           WRITE(6,*)
           STOP '*** PROGRAM WAVE ABORTED ***'
         ENDIF
         IF (IPIN.NE.0) THEN
           CZ2=PINCEN(3)
         ELSE
           CZ2=OBS1Z
         ENDIF
       ENDIF !CZ2

       IF (WID1.EQ.9999.) THEN
         IF (IRFILOB.NE.0) THEN
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
     &       '*** DEFAULT FOR WID1 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(LUNGFO,*)'*** CHECK INPUT FILE ***'
           WRITE(LUNGFO,*)
           WRITE(6,*)
           WRITE(6,*)
     &       '*** DEFAULT FOR WID1 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(6,*)'*** CHECK INPUT FILE ***'
           WRITE(6,*)
           STOP '*** PROGRAM WAVE ABORTED ***'
         ENDIF
         IF (IPIN.NE.0) THEN
           WID1=PINW+4.*PINW/MPINZ
         ELSE
           WID1=0.001
         ENDIF
       ENDIF !WID1

       IF (WID2.EQ.9999.) THEN
         IF (IRFILOB.NE.0) THEN
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
     &       '*** DEFAULT FOR WID2 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(LUNGFO,*)'*** CHECK INPUT FILE ***'
           WRITE(LUNGFO,*)
           WRITE(6,*)
           WRITE(6,*)
     &       '*** DEFAULT FOR WID2 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(6,*)'*** CHECK INPUT FILE ***'
           WRITE(6,*)
           STOP '*** PROGRAM WAVE ABORTED ***'
         ENDIF
         IF (IPIN.NE.0) THEN
           WID2=PINW+4.*PINW/MPINZ
         ELSE
           WID2=0.001
         ENDIF
       ENDIF !WID2

       IF (HIG1.EQ.9999.) THEN
         IF (IRFILOB.NE.0) THEN
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
     &       '*** DEFAULT FOR HIG1 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(LUNGFO,*)'*** CHECK INPUT FILE ***'
           WRITE(LUNGFO,*)
           WRITE(6,*)
           WRITE(6,*)
     &       '*** DEFAULT FOR HIG1 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(6,*)'*** CHECK INPUT FILE ***'
           WRITE(6,*)
           STOP '*** PROGRAM WAVE ABORTED ***'
         ENDIF
         IF (IPIN.NE.0) THEN
           HIG1=PINH+4.*PINH/MPINY
         ELSE
           HIG1=0.001
         ENDIF
       ENDIF !HIG1

       IF (HIG2.EQ.9999.) THEN
         IF (IRFILOB.NE.0) THEN
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
     &       '*** DEFAULT FOR HIG2 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(LUNGFO,*)'*** CHECK INPUT FILE ***'
           WRITE(LUNGFO,*)
           WRITE(6,*)
           WRITE(6,*)
     &       '*** DEFAULT FOR HIG2 NOT ALLOWED SINCE FLAG IRFILOB IS SET ***'
           WRITE(6,*)'*** CHECK INPUT FILE ***'
           WRITE(6,*)
           STOP '*** PROGRAM WAVE ABORTED ***'
         ENDIF
         IF (IPIN.NE.0) THEN
           HIG2=PINH+4.*PINH/MPINY
         ELSE
           HIG2=0.001
         ENDIF
       ENDIF !HIG2

       IF(IRFILL0.NE.0) THEN
         CALL RFILL0
       ELSE IF (ISPECDIP.LE.0) THEN
         CALL WFILL0
       ELSE IF (ISPECDIP.GT.0) THEN
         NSOURCE=NDIP
       ENDIF

       if (nsource.gt.1.and.ibrill.ne.0) then
         write(6,*) "*** Warning: More then one source. This is not compatible with IBRILL=1"
         write(6,*) "*** IBRILL is set to zero!"
         write(LUNGFO,*) "*** Warning: More then one source. This is not compatible with IBRILL=1"
         write(LUNGFO,*) "*** IBRILL is set to zero!"
         ibrill=0
       endif

       if (nsource.gt.1.and.kampli.ne.0) then
         write(6,*) "*** Error: More then one source. This is not compatible with KAMPLI"
         stop "*** Program WAVE aborted ***"
       endif

       ALLOCATE(IPOISOU(NSOURCE))

       IF (ISPECDIP.LE.0) THEN

C        SOURCEE,SOUREA... ARE ALLOCATED IN RFILL0/WFILL0

         ALLOCATE(IWARNROI(NROIA,NSOURCE))
         ALLOCATE(IPOIROI(NROIA+1))
         ALLOCATE(IZTOT(NSOURCE))
         ALLOCATE(ECSOUR(4,NSOURCE))
         ALLOCATE(ECMAX(NSOURCE))

         DO I=1,NSOURCE
           ECSOUR(1,I)=0.0d0
           ECSOUR(2,I)=0.0d0
           ECSOUR(3,I)=0.0d0
           ECSOUR(4,I)=0.0d0
           ECMAX(I)=0.0d0
         ENDDO

C--- HISTOGRAMS OF MINITRAJECTORIES OF SOURCES

         IF (IHTRACKM.NE.0) CALL HSOURCE

C---- COHERENCE OF SOURCES

         CALL COHEREN

       ENDIF   !ISPECDIP.LE.0

C----   OBSERVATION POINTS TO BE TREATED

       IF (IPIN.NE.0) THEN

         if (ipin.eq.3) then
           call pinin3
         else
           CALL PININ
         endif

       ELSE !ipin

         MPINR=0

         IF (IFOLD.EQ.2) THEN

           CALL WSIGFOL

           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)'     Horizontal emittance EPS0H [m-rad]:',EPS0H
           WRITE(LUNGFO,*)'     Vertical emittance EPS0V [m-rad]:  ',EPS0V
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)'     Number of sigmas for horiz. folding:'
           WRITE(LUNGFO,*)'     ',(SNGL(DGSIGZ(IS)),IS=1,NSOURCE)
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)'     Number of sigmas for vert. folding:'
           WRITE(LUNGFO,*)'     ',(SNGL(DGSIGY(IS)),IS=1,NSOURCE)
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)'     Sigmas of sources for horiz. folding:'
           WRITE(LUNGFO,*)'     ',(SNGL(WSIGZ(IS)),IS=1,NSOURCE)
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)'     Sigmas of sources for vert. folding:'
           WRITE(LUNGFO,*)'     ',(SNGL(WSIGY(IS)),IS=1,NSOURCE)
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)'     Sigmas of horizontal beam size and divergence:'
           WRITE(LUNGFO,*)
     &       '     (if not zero, sigmas for folding are calculated from these values)'
           WRITE(LUNGFO,*)'     ',(SNGL(BSIGZ(IS)),SNGL(BSIGZP(IS)),IS=1,NSOURCE)
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)'     Sigmas of vertical beam size and divergence:'
           WRITE(LUNGFO,*)
     &       '     (if not zero, sigmas for folding are calculated from these values)'
           WRITE(LUNGFO,*)'     ',(SNGL(BSIGY(IS)),SNGL(BSIGYP(IS)),IS=1,NSOURCE)
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)

           IF (ISTOKES.NE.0) THEN
             WRITE(LUNGFO,*)
     &         '     Sigmas for folding of components of STOKES vector:'
             WRITE(LUNGFO,*)
     &         '     ',SNGL(WSIGZ(ISIGSTO)),SNGL(WSIGY(ISIGSTO))
           ENDIF !ISTOKES

           WRITE(LUNGFO,*)

         ENDIF !IFOLD.EQ.2

         ICBRILL=1
         CALL RFILOB
         IF (IRFILOB.NE.0.AND.IPBRILL.NE.0) THEN
           ICBRILL=IPBRILL
           IF (ICBRILL.GT.NOBSV) THEN
             WRITE(LUNGFO,*)'*** ERROR IN SPECTRUM: BAD SELECTED POINT ***'
             WRITE(LUNGFO,*)'*** CHECK INPUT IPBRILL IN WAVE.IN'
             WRITE(6,*)'*** ERROR IN SPECTRUM: BAD SELECTED POINT ***'
             WRITE(6,*)'*** CHECK INPUT IPBRILL IN WAVE.IN'
             STOP
           ENDIF
         ENDIF
       ENDIF !ipin

       IF (NOBSVZ.GT.NDOBSVZP) THEN
         WRITE(6,*)'*** DIMENSION ERROR IN SPECTRUM FOR NDOBSVZP ***'
         WRITE(6,*)'DIMENSION IS: ',NDOBSVZP
         WRITE(6,*)'CALCULATION REQUIRES: ',NOBSVZ
         WRITE(6,*)'*** CHANGE PARAMETER NDOBSVZP IN CMPARA.CMN***'
         WRITE(6,*)'*** PROGRAM WAVE ABORTED ***'
         STOP
       ENDIF   !(NOBSVZ.GT.NDOBSVZP)

       IF (NOBSVY.GT.NDOBSVYP) THEN
         WRITE(6,*)'*** DIMENSION ERROR IN SPECTRUM FOR NDOBSVYP ***'
         WRITE(6,*)'DIMENSION IS: ',NDOBSVYP
         WRITE(6,*)'CALCULATION REQUIRES: ',NOBSVY
         WRITE(6,*)'*** CHANGE PARAMETER NDOBSVYP IN CMPARA.CMN***'
         WRITE(6,*)'*** PROGRAM WAVE ABORTED ***'
         STOP
         IF (NOBSV.GT.NDOBSVP) THEN
           WRITE(6,*)'*** DIMENSION ERROR IN SPECTRUM FOR NDOBSVP ***'
           WRITE(6,*)'DIMENSION IS: ',NDOBSVP
           WRITE(6,*)'CALCULATION REQUIRES: ',NOBSV
           WRITE(6,*)'*** CHANGE PARAMETER NDOBSVP IN CMPARA.CMN***'
           WRITE(6,*)'*** PROGRAM WAVE ABORTED ***'
           STOP
         ENDIF !(NOBSV.GT.NDOBSVP)
       ENDIF   !(NOBSVY.GT.NDOBSVYP)

       ALLOCATE(schwingercen(4,nobsv,nsource))
       ALLOCATE(SPEC(NSOURCE*NOBSV*NFREQ))
       spec=0.0d0

      IF (MPINR.NE.0) THEN
        ALLOCATE(SPECRPHI(NSOURCE*NOBSVRPHI*NFREQ))
        SPECRPHI=0.0D0
      ENDIF

      ALLOCATE(SPECI(NSOURCE*NOBSV))
      ALLOCATE(SPECIV(NSOURCE*NOBSV))
      ALLOCATE(SPECPOW(NSOURCE*NOBSV))
      if (ifold.ne.0) then
        ALLOCATE(SPECPOWF(NSOURCE*NOBSV))
        ALLOCATE(SPECPOWTF(NOBSV))
      endif
      IF (MPINR.GT.0) THEN
        ALLOCATE(SPECPOWRPHI(NSOURCE*NOBSVRPHI))
        SPECPOWRPHI=0.0D0
      ENDIF

      SPECI=0.0d0
      SPECIV=0.0d0
      SPECPOW=0.0d0

      ALLOCATE(SPECPOWV(NSOURCE*NOBSVZ))
      DO I=1,NSOURCE*NOBSVZ
        SPECPOWV(I)=0.0d0
      ENDDO

      ALLOCATE(WFLUX(NSOURCE*NFREQ))
      DO I=1,NSOURCE*NFREQ
        WFLUX(I)=0.0d0
      ENDDO

      ALLOCATE(SPECTOT(NOBSV*NFREQ))
      DO I=1,NOBSV*NFREQ
        SPECTOT(I)=0.0d0
      ENDDO

      ALLOCATE(REAIMA(10,2,NOBSV*NFREQ))
      REAIMA=0.0d0

      IF (MPINR.NE.0) THEN
        ALLOCATE(REAIMARPHI(10,2,NOBSV*NFREQ))
        REAIMARPHI=0.0d0
      ENDIF

      IF (ISTOKES.NE.0) THEN
        ALLOCATE(STOKES(4,NOBSV*NFREQ))
        STOKES=0.0D0
        IF (IEFOLD.NE.0) THEN
          ALLOCATE(STOKESE(4,NOBSV*NFREQ))
          STOKESE=0.0D0
          IF (IFOLD.NE.0) THEN
            ALLOCATE(STOKESEF(4,NOBSV*NFREQ))
            STOKESE=0.0D0
          ENDIF
        ENDIF
      ENDIF

      ALLOCATE(SPECPOWVH(NSOURCE))
      ALLOCATE(WFLUXI(NSOURCE))
      DO I=1,NSOURCE
        SPECPOWVH(I)=0.0d0
        WFLUXI(I)=0.0d0
      ENDDO

      ALLOCATE(SPECTOTI(NOBSV))
      ALLOCATE(SPECPOWT(NOBSV))
      ALLOCATE(SPECPOWTgraz(NOBSV))
      ALLOCATE(ENEDOS(NOBSV))
      ALLOCATE(SPCOEFM(NOBSV))
      ALLOCATE(WOBS1(NOBSV))
      ALLOCATE(WOBS2(NOBSV))
      ALLOCATE(WOBS3(NOBSV))
      ALLOCATE(WOBS4(NOBSV))
      ALLOCATE(WOBS5(NOBSV))
      ALLOCATE(WOBS6(NOBSV))
      ALLOCATE(WOBS7(NOBSV))
      ALLOCATE(WOBS8(NOBSV))
      ALLOCATE(SPCOEF(NOBSV))
      DO I=1,NOBSV
        SPECTOTI(I)=0.0d0
        SPECPOWT(I)=0.0d0
        SPECPOWTgraz(I)=0.0d0
        ENEDOS(I)=0.0d0
        SPCOEFM(I)=0.0d0
        WOBS1(I)=0.0d0
        WOBS2(I)=0.0d0
        WOBS3(I)=0.0d0
        WOBS4(I)=0.0d0
        WOBS5(I)=0.0d0
        WOBS6(I)=0.0d0
        WOBS7(I)=0.0d0
        WOBS8(I)=0.0d0
        SPCOEF(I)=0.0d0
      ENDDO

      ALLOCATE(SPECPOWVT(NOBSVZ))
      DO I=1,NOBSVZ
        SPECPOWVT(I)=0.0d0
      ENDDO

      ALLOCATE(WFLUXT(NFREQ))

      DO I=1,NFREQ
        WFLUXT(I)=0.0D0
      ENDDO

      IF (ISTOKES.NE.0) THEN
        ALLOCATE(WSTOKES(4,NFREQ))
        ALLOCATE(STOKEC(4,NFREQ))
        DO I=1,NFREQ
          WSTOKES(1,I)=0.0D0
          WSTOKES(2,I)=0.0D0
          WSTOKES(3,I)=0.0D0
          WSTOKES(4,I)=0.0D0
          STOKEC(1,I)=0.0D0
          STOKEC(2,I)=0.0D0
          STOKEC(3,I)=0.0D0
          STOKEC(4,I)=0.0D0
        ENDDO
      ENDIF !ISTOKES

      IF (IBRILL.NE.0) THEN
        ALLOCATE(BRILLC(4,NFREQ))
        ALLOCATE(BRILLCF(4,NFREQ))  !also for ifold.eq.0
        DO I=1,NFREQ
          BRILLC(1,I)=0.0D0
          BRILLC(2,I)=0.0D0
          BRILLC(3,I)=0.0D0
          BRILLC(4,I)=0.0D0
          BRILLCF(1,I)=0.0D0
          BRILLCF(2,I)=0.0D0
          BRILLCF(3,I)=0.0D0
          BRILLCF(4,I)=0.0D0
        ENDDO
      ENDIF !IBRILL

      IF (IEFOLD.NE.0) THEN

        IF (ISTOKES.NE.0) THEN
          ALLOCATE(WSTOKESE(4,NFREQ))
          ALLOCATE(STOKECE(4,NFREQ))
          DO I=1,NFREQ
            WSTOKESE(1,I)=0.0D0
            WSTOKESE(2,I)=0.0D0
            WSTOKESE(3,I)=0.0D0
            WSTOKESE(4,I)=0.0D0
            STOKECE(1,I)=0.0D0
            STOKECE(2,I)=0.0D0
            STOKECE(3,I)=0.0D0
            STOKECE(4,I)=0.0D0
          ENDDO
        ENDIF !ISTOKES

        IF (IBRILL.NE.0) THEN
          ALLOCATE(BRILLCE(4,NFREQ))
          ALLOCATE(BRILLCEF(4,NFREQ)) !also for ifold.eq.0
          DO I=1,NFREQ
            BRILLCE(1,I)=0.0D0
            BRILLCE(2,I)=0.0D0
            BRILLCE(3,I)=0.0D0
            BRILLCE(4,I)=0.0D0
            BRILLCEF(1,I)=0.0D0
            BRILLCEF(2,I)=0.0D0
            BRILLCEF(3,I)=0.0D0
            BRILLCEF(4,I)=0.0D0
          ENDDO
        ENDIF   !IBRILL

      ENDIF !IEFOLD

      IF (IFOLD.NE.0) THEN

        ALLOCATE(SPECF(NSOURCE*NOBSV*NFREQ))
        DO I=1,NSOURCE*NOBSV*NFREQ
          SPECF(I)=0.0d0
        ENDDO

        ALLOCATE(SPECIF(NSOURCE*NOBSV))
        DO I=1,NSOURCE*NOBSV
          SPECIF(I)=0.0d0
        ENDDO

        ALLOCATE(SPECIVF(NSOURCE*NOBSVY))
        DO I=1,NSOURCE*NOBSVY
          SPECIVF(I)=0.0d0
        ENDDO

        ALLOCATE(WFLUXF(NSOURCE*NFREQ))
        DO I=1,NSOURCE*NFREQ
          WFLUXF(I)=0.0d0
        ENDDO

        ALLOCATE(DOBUFF(NOBSV))
        ALLOCATE(DOBUFF1(NOBSV))
        ALLOCATE(DOBUFF2(NOBSV))

        ALLOCATE(SPECTOTF(NOBSV*NFREQ))
        DO I=1,NOBSV*NFREQ
          SPECTOTF(I)=0.0D0
        ENDDO

        IF (ISTOKES.NE.0) THEN
          ALLOCATE(STOKESF(4,NOBSV*NFREQ))
          DO I=1,NOBSV*NFREQ
            STOKESF(1,I)=0.0d0
            STOKESF(2,I)=0.0d0
            STOKESF(3,I)=0.0d0
            STOKESF(4,I)=0.0d0
          ENDDO
        ENDIF

        ALLOCATE(WFLUXIF(NSOURCE))
        DO I=1,NSOURCE
          WFLUXIF(I)=0.0d0
        ENDDO

        ALLOCATE(SPECTOTIF(NOBSV))
        DO I=1,NOBSV
          SPECTOTIF(I)=0.0d0
        ENDDO

        ALLOCATE(WFLUXTF(NFREQ))
        DO I=1,NFREQ
          WFLUXTF(I)=0.0D0
        ENDDO

        IF (ISTOKES.NE.0) THEN
          ALLOCATE(WSTOKESF(4,NFREQ))
          ALLOCATE(STOKECF(4,NFREQ))
          DO I=1,NFREQ
            WSTOKESF(1,I)=0.0d0
            STOKECF(1,I)=0.0d0
            WSTOKESF(2,I)=0.0d0
            STOKECF(2,I)=0.0d0
            WSTOKESF(3,I)=0.0d0
            STOKECF(3,I)=0.0d0
            WSTOKESF(4,I)=0.0d0
            STOKECF(4,I)=0.0d0
          ENDDO
        ENDIF  !ISTOKES

        IF (IEFOLD.NE.0) THEN

          IF (ISTOKES.NE.0) THEN
            ALLOCATE(WSTOKESEF(4,NFREQ))
            ALLOCATE(STOKECEF(4,NFREQ))
            DO I=1,NFREQ
              WSTOKESEF(1,I)=0.0d0
              STOKECEF(1,I)=0.0d0
              WSTOKESEF(2,I)=0.0d0
              STOKECEF(2,I)=0.0d0
              WSTOKESEF(3,I)=0.0d0
              STOKECEF(3,I)=0.0d0
              WSTOKESEF(4,I)=0.0d0
              STOKECEF(4,I)=0.0d0
            ENDDO
          ENDIF   !ISTOKES

        ENDIF  !IEFOLD
      ENDIF !IFOLD

      if (ipin.ne.3) then
        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)'      selected observation point:'
        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)'      '
     &    ,SNGL(OBSV(1,ICBRILL)),SNGL(OBSV(2,ICBRILL)),SNGL(OBSV(3,ICBRILL))
        WRITE(LUNGFO,*)
      endif

      CALL CHECKOB

C--- LOOP OVER ALL SOURCES, EVALUATE INTEGRALS

      IF (IAMPSKIP.NE.0) THEN
        ALLOCATE(AFREQ(6,NOBSV*NFREQ))
        AFREQ=(0.0D0,0.0D0)
        IF (MPINR.GT.0) THEN
          ALLOCATE(AFREQRPHI(6,NOBSVRPHI*NFREQ))
          afreqrphi=(0.0d0,0.0d0)
        ENDIF
        ALLOCATE(EXPOM2P0(2,NFREQ))
      ENDIF !(IAMPSKIP.NE.0)

      IF (NLPOI.EQ.0) nlpoi=(xstop-xstart)*myinum+1

      IF (
     &    ISPECANA.EQ.0
     &    .AND.
     &    IDESYNC.EQ.0
     &    .AND.
     &    ISPECDIP.EQ.0
     &    .AND.
     &    (IRFILSP0.EQ.0.OR.IRFILSTO.EQ.0.AND.ISTOKES.NE.0)
     &    .AND.
     &    IAMPSKIP.EQ.0
     &    ) THEN

C DEFAULT FOR NLPOI

        IF (NLPOI.EQ.-9999) CALL SETNLPOI

C STORE VALUES, REINITIALIZE SOURCEE

        NDWSOU=MAX(NLPOI,NCO)+NBADDP
        NDARGU=NDWSOU
        NLPOIO=NLPOI
        NBUFF=1

        IF (ISPECMODE.EQ.3.OR.ISPECMODE.EQ.4) THEN
          ALLOCATE(REARGUM(11,NDWSOU))
        ENDIF

        IF (ISPECMODE.EQ.1.OR.ISPECMODE.EQ.3.OR.ISPECMODE.EQ.4) THEN
          ALLOCATE(WSOU(3,5,NDWSOU))
        ENDIF

C BEGIN OF RAW SPECTRUM CALCULATION

        IF (NSOURCE.GE.1.and.icluster.lt.0) THEN
          CALL date_and_time(dtday,dttime,dtzone,idatetime)
          WRITE(6,*)
          WRITE(6,*)'     Starting spectrum calculations '
     &      ,dttime(1:2),':',dttime(3:4),':',dttime(5:6)
          WRITE(6,*)
        ENDIF

        DO ISOUR=1,NSOURCE
CERR101292      DO JC=1,3

          DO JC=1,4
            DO IC=1,3
              SOURCEAO(IC,JC,ISOUR)=SOURCEA(IC,JC,ISOUR)
              SOURCEEO(IC,JC,ISOUR)=SOURCEE(IC,JC,ISOUR)
            ENDDO
          ENDDO

          DO JC=1,1
            DO IC=1,3
              SOURCEE(IC,JC,ISOUR)=SOURCEA(IC,JC,ISOUR)+
     &          (SOURCEEO(IC,JC,ISOUR)-SOURCEAO(IC,JC,ISOUR))/NBUFF
            ENDDO
          ENDDO

        ENDDO   !ISOUR

        ISOURO=0

        IF (IAMPSKIP.EQ.0) THEN
          ALLOCATE(AFREQ(6,NOBSV*NFREQ))
          AFREQ=(0.0D0,0.0D0)
          ALLOCATE(EXPOM2P0(2,NFREQ))
          IF (MPINR.GT.0) THEN
            ALLOCATE(AFREQRPHI(6,NOBSVRPHI*NFREQ))
            afreqrphi=(0.0d0,0.0d0)
          ENDIF
        ENDIF !(IAMPSKIP.EQ.0)
        ALLOCATE(TBUFF(NOBSV))
        IF (ISPECMODE.EQ.3.OR.ISPECMODE.EQ.4) THEN
          ALLOCATE(NARGUM(NOBSV,NSOURCE))
        ELSE IF (ISPECMODE.EQ.1.OR.ISPECMODE.EQ.2) THEN
          ALLOCATE(DARGEXPO(6,NOBSV))
        ENDIF

        IF (IAMPLI.LT.0) THEN
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'      repetition of amplitude activated:'
          WRITE(LUNGFO,*)
     &      '      A -> A * (1 + exp(i*phi) + exp(i*2*phi)...'
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'      IAMPLI, AMPSHIFT(1):',IAMPLI,AMPSHIFT(1)
          WRITE(LUNGFO,*)
     &      '      Total phase-advance [nm] and corresponding photon energy [eV]:'
          WRITE(LUNGFO,*)
     &      '      ',(AMPSHIFT(1)/2.0D0/DMYGAMMAP**2+HTRA2I)*1.0D9
     &      ,CLIGHT1*HPLANCK1/ECHARGE1/(AMPSHIFT(1)/2.0D0/DMYGAMMAP**2+HTRA2I)
c          WRITE(LUNGFO,*)
c     &      '      MYINUM has to be tuned,'
c          WRITE(LUNGFO,*)
c     &      '      since phase advance is calculated form trajectory.'
          WRITE(LUNGFO,*)
          WRITE(6,*)
          WRITE(6,*)'      repetition of amplitude activated:'
          WRITE(6,*)
     &      '      A -> A * (1 + exp(i*phi) + exp(i*2*phi)...'
          WRITE(6,*)
          WRITE(6,*)'      IAMPLI, AMPSHIFT(1):',IAMPLI,AMPSHIFT(1)
          WRITE(6,*)
     &      '      Total phase-advance [nm] and corresponding photon energy [eV]:'
          WRITE(6,*)
     &      '      ',(AMPSHIFT(1)/2.0D0/DMYGAMMAP**2+HTRA2I)*1.0D9
     &      ,CLIGHT1*HPLANCK1/ECHARGE1/(AMPSHIFT(1)/2.0D0/DMYGAMMAP**2+HTRA2I)
          WRITE(6,*)
c          WRITE(6,*)
c     &      '*****>>>>      MYINUM has to be tuned,'
c          WRITE(6,*)
c     &      '      since phase advance is calculated from trajectory.'
c          WRITE(6,*)
c          CALL UTIL_WAIT_1
          IF (AMPRAN.NE.0.D0) THEN
            IF (ISOUR.EQ.1) THEN
              WRITE(LUNGFO,*)
              WRITE(LUNGFO,*)'      phase errors for repetition activated:'
              WRITE(LUNGFO,*)
     &          '      A -> A * (1 + exp(i*phi*xran1) + exp(i*2*phi*xran2)...'
              WRITE(LUNGFO,*)
              WRITE(LUNGFO,*)'      IAMPSEED: ',IAMPSEED
              WRITE(LUNGFO,*)
            ENDIF !ISOUR
            ALLOCATE(XRANA(-IAMPLI))
            IF (IAMPSEED.NE.0) CALL RMARIN(IAMPSEED,NTOTIN,NTOT2IN)
            CALL RNORML(XRANA,-IAMPLI,rr)
            RMS=0.0d0
            DO IREP=1,-IAMPLI
              XRANA(IREP)=AMPRAN*XRANA(IREP)
              RMS=RMS+XRANA(IREP)**2
            ENDDO
            RMS=SQRT(RMS/(-IAMPLI))
            WRITE(LUNGFO,*)
     &        '      rel. rms phase AMPRAN (input): ',SNGL(AMPRAN)
            WRITE(LUNGFO,*)
     &        '      rel. rms phase error 1. source (from generated errors): '
     &        ,SNGL(RMS)
          ENDIF   !(AMPRAN.NE.0.D0)
        ENDIF !IAMPLI

        DO ISOUR=1,NSOURCE

          IF (ISPECMODE.EQ.1.OR.ISPECMODE.EQ.2) THEN
            if (icluster.gt.0) goto 1357
            IF (ISPECMODE.EQ.2) THEN
              call sourcesteps(isour,ndwsou)
              ALLOCATE(WSOU(3,5,NDWSOU))
              nsadd=1
            endif
            if (iundulator.ne.2) then
              if (iomp.eq.0.or.(ipin.eq.0.and.mthreads.eq.0)) then
                CALL SOUINTALL(ISOUR)
              else
                CALL SOUINTALL_omp(ISOUR)
              endif
            endif
            IF (ISPECMODE.EQ.2) THEN
              deALLOCATE(WSOU)
            endif
            GOTO 1357
          ENDIF !ISPECMODE

          IF (ISOUR.EQ.2) THEN
            WRITE(6,*)' '
            WRITE(6,*)'     sources done and time:'
            WRITE(6,*)' '
          ENDIF !NSOURCE

          DO IOBSV=1,NOBSV
            TBUFF(IOBSV)=0.0
          ENDDO   !IOBSV

          MSADD=0
          DO IBUFF=1,NBUFF

            IF (MSADD.EQ.1) THEN
              IF (AMPRAN.NE.0.D0.AND.IAMPLI.LT.0) THEN
                DEALLOCATE(XRANA)
              ENDIF   !(AMPRAN.NE.0.D0)
              GOTO 1357 !EXIT IBUFF LOOP
            ENDIF

            IF (IBUFF.EQ.NBUFF.OR.MSADD.EQ.-1) THEN
              NSADD=1
              MSADD=1
            ELSE
              NSADD=0
            ENDIF

            IF (ISPECMODE.EQ.3) THEN
              CALL TRACKS(ISOUR)   !TRACKING OF SOURCE
            ELSE IF (ISPECMODE.EQ.4) THEN
              CALL TRACKSOLD(ISOUR)   !TRACKING OF SOURCE
            ELSE
              PRINT*, '*** ERROR IN SPECTRUM: BAD ISPECMODE: ',ISPECMODE
              STOP '*** PROGRAMM WAVE ABORTED ***'
            ENDIF

            CALL SOUINT(ISOUR,IBUFF)   !INTEGRATION

            DO JC=1,1
              DO IC=1,3
C SOURCEA IS RECALCULATED IN SR TRACKS
                SOURCEE(IC,JC,ISOUR)=SOURCEA(IC,JC,ISOUR)+
     &            (SOURCEEO(IC,JC,ISOUR)-SOURCEAO(IC,JC,ISOUR))/NBUFF
              ENDDO
            ENDDO

            IF (SOURCEE(1,1,ISOUR).GT.SOURCEEO(1,1,ISOUR)) THEN

              DO JC=1,1
                DO IC=1,3
                  SOURCEE(IC,JC,ISOUR)=SOURCEEO(IC,JC,ISOUR)
                ENDDO
              ENDDO

              IF (MSADD.EQ.0) MSADD=-1

            ENDIF !(SOURCEE(1,1,ISOUR).GT.SOURCEEO(1,1,ISOUR))

            IF (MSADD.NE.1
     &          .AND.SOURCEA(1,1,ISOUR).GE.SOURCEE(1,1,ISOUR)) THEN
              WRITE(LUNGFO,*)'*** ERROR IN SPECTRUM:'
              WRITE(LUNGFO,*)'SOMETHING WRONG WITH SOURCE BUFFER'
              WRITE(LUNGFO,*)
     &          'CHANGE INTEGRATION BUFFER OR CHECK SOURCE CODE'
              WRITE(LUNGFO,*)
     &          'IBUFF,NBUFF,SOURCEA(1,1,ISOUR),SOURCEE(1,1,ISOUR)'
              WRITE(LUNGFO,*)IBUFF,NBUFF
              WRITE(LUNGFO,*)SOURCEA(1,1,ISOUR),SOURCEE(1,1,ISOUR)
              WRITE(6,*)'*** ERROR IN SPECTRUM:'
              WRITE(6,*)'SOMETHING WRONG WITH SOURCE BUFFER'
              WRITE(6,*)
     &          'CHANGE INTEGRATION BUFFER OR CHECK SOURCE CODE'
              WRITE(6,*)
     &          'IBUFF,NBUFF,SOURCEA(1,1,ISOUR),SOURCEE(1,1,ISOUR)'
              WRITE(6,*)IBUFF,NBUFF
              WRITE(6,*)SOURCEA(1,1,ISOUR),SOURCEE(1,1,ISOUR)
              STOP
            ENDIF

            ISOURO=ISOUR

          ENDDO   !IBUFF

1357    CONTINUE

        if (kampli.ne.0) then

          if (ibunch.eq.0) then
            nbunch=mbuncho
            neinbunch=meinbuncho
            ibunch=ibuncho
            ihbunch=ihbuncho
          endif

          if (ipin.eq.0) then
            call pinin ! to get pincen etc.
            nobsv=1
            nobsvz=1
            nobsvy=1
            icbrill=1
            obsv(:,1)=pincen(:)
          endif

          call amprep_omp

          pow_u=pow_u*1.0d6
          stokes_u=stokes_u*1.0d6

          fbunch_u(4:14,:)=fbunch_u(4:14,:)/1000.0d0
          fbunch_u(17:19,:)=fbunch_u(17:19,:)/1000.0d0
          fbunch_u(22:26,:)=fbunch_u(22:26,:)*1.0d3
          fbunch_u(30:41,:)=fbunch_u(30:41,:)*1.0d3
          arad_u=arad_u*1000.0d0

          specpow=pow_u
          spec(:)=stokes_u(1,:)
          stokes=stokes_u

          do iobsv=1,nobsv
            do ifr=1,nfreq
              iobfr=iobsv+nobsv*(ifr-1)
              reaima(1:3,1,iobfr)=dreal(arad_u(1:3,iobfr))
              reaima(1:3,2,iobfr)=dimag(arad_u(1:3,iobfr))
              reaima(6:8,1,iobfr)=dreal(arad_u(4:6,iobfr))
              reaima(6:8,2,iobfr)=dimag(arad_u(4:6,iobfr))
            enddo
          enddo

          if (ibunch.ne.0) then
            do i=1,nbunch*neinbunch*nfreq
              if (fbunch_u(21,i).ne.0.0d0) then
                call hfm(nidbunch,fbunch_u(:,i))
              endif
            enddo
          endif
        endif

        if (icluster.ne.0) then
          call wpamp
        endif

        IF (ISOUR.EQ.1.and.nsource.gt.1) THEN
          WRITE(6,*)' '
          WRITE(6,*)' '
          WRITE(6,*)' sources treated so far:'
          WRITE(6,*)' '
        ENDIF

c        CALL APHASE(ISOUR)

        IF (nsource.gt.1) THEN
          CALL date_and_time(dtday,dttime,dtzone,idatetime)

          WRITE(6,2000)ISOUR,NSOURCE,dttime(1:2),dttime(3:4),dttime(5:6)
2000      FORMAT(10X,I4,' of',I4,2X,A,':',A,':',A)
        ENDIF


      ENDDO !LOOP OVER SOURCES

      if (abs(ifold).eq.1) CALL AMPFOLD

C     CALL LIB$SHOW_TIMER

C RESTORE OLD VALUES

      NLPOI=NLPOIO

      IF(ISPECDIP.EQ.0.and.ipin.eq.0) THEN
        if (iundulator.eq.0) then
          CALL SPECDIPA  ! To calculate schwingercen for powgraz
        else
          DO ISOUR=1,NSOURCE
            do jc=1,nobsv
              DO IC=1,3
                schwingercen(IC,JC,ISOUR)=(SOURCEAO(IC,1,ISOUR)+
     &            SOURCEEO(IC,1,ISOUR))/2.0d0
              enddo
            enddo
          enddo
        endif
      ENDIF

      DO ISOUR=1,NSOURCE
CERR101292      DO JC=1,3
        DO JC=1,4
          DO IC=1,3
            SOURCEA(IC,JC,ISOUR)=SOURCEAO(IC,JC,ISOUR)
            SOURCEE(IC,JC,ISOUR)=SOURCEEO(IC,JC,ISOUR)
          ENDDO
        ENDDO
        IPOISOU(ISOUR)=IZTOT(ISOUR)
      ENDDO   !ISOUR

      ELSE IF(ISPECANA.NE.0)   THEN !ISPECANA

        CALL SPECANA      !USER SUPPLIED SPECTRUM
C                  !(E.G. FOR TESTING)
        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)'*** MESSAGE SR SPECTRUM ***'
        WRITE(LUNGFO,*)
     &    'FLUX OVERWRITTEN BY SR SPECANA (FLAG ISPECANA)'
        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)

      ELSE IF(IDESYNC.NE.0)   THEN !ISPECANA

        CALL SYNC_SPEC      !SPECTRUM FROM PROGRAM DESYNC

      ELSE IF(ISPECDIP.GT.0)   THEN !ISPECANA

        CALL SPECDIP  !DIPOL SPECTRUM ACCORDING TO BESSEL FUNCTIONS

      ELSE IF(ISPECDIP.LT.0)   THEN !ISPECANA

        CALL SPECDIPA  !DIPOL SPECTRUM ACCORDING TO BESSEL FUNCTIONS FOR
                       !GIVEN SOURCES
      ELSE

        IF (IRFILSP0.NE.0) CALL RFILSP0
        IF (IRFILSTO.NE.0) CALL RFILSTO

      ENDIF !ISPECANA

C }CHANGE FROM CYLINDRICAL TO CARTHESIAN GRID

      IF (IAMPLI.gt.0.or.iamprep.lt.0) CALL ADDAMPLI
      IF (IAMPLI.LT.0) THEN
        FACAMPLI=-IAMPLI
      ELSE
        FACAMPLI=1.D0
      ENDIF

C END OF RAW SPECTRUM CALCULATION

      IF (IABEND.EQ.6) then
        iroottrees=0
        RETURN
      endif

C--- TAKE FILTER INTO ACCOUNT

      IF (IFILTER.GT.0) THEN
        IF (IFILMUL.EQ.0) THEN
          CALL FILTER !ARRAY SPEC IS OVERWRITTEN
        ELSE
          ABSMUTOT=0.0D0
          OPEN(UNIT=LUNAM,FILE=FILEAM,STATUS='OLD')
          DO I=1,IFILMUL
            READ(LUNAM,*)ABSTHI,FILEABS
            CALL FILTER !ARRAY SPEC IS OVERWRITTEN
            ABSMUTOT=ABSMUTOT+ABSMU
          ENDDO !IFILMUL
          CLOSE(LUNAM)
        ENDIF !IFILTER

      ENDIF !IFILTER

C--- TAKE PHOTO YIELD INTO ACCOUNT

      IF (IEFFI.NE.0) THEN
        CALL EFFI !ARRAY SPEC IS OVERWRITTEN
      ENDIF !IEFFI

C--- LOOP OVER ALL SOURCES, ADD UP CONTRIBUTIONS OF EVALUATED INTEGRALS

      if (iomp.eq.0) CALL SOUADD

C--- FLUX TRHOUGH PINHOLE

      IF(IPINo.GT.0) THEN

        print*
        call zeit(6)
        print*,"     Start integration over pinhole"

        if (iomp.eq.0) then

          DO IFREQ=1,NFREQ

            IF(IPIN.NE.2.and.ipin.ne.3) THEN !SPECTOT IN SOUADD CALCULATED

              DO IY=1,NOBSVY
                DO IZ=1,NOBSVZ
                  IOBSV=(IY-1)*NOBSVZ+IZ
                  SPECTOT(IOBSV+NOBSV*(IFREQ-1))=0.0D0
                ENDDO   !IZ
              ENDDO   !IY

            ENDIF !IPIN.NE.2

            WFLUXT(IFREQ)=0.0

            DO ISOUR=1,NSOURCE

              IF(IPIN.NE.2.and.ipin.ne.3) THEN

C--- SPLINE INTERPOLATION INSIDE PINHOLE

                IF (IUSEM.EQ.0) THEN
                  IF (IPINCIRC.EQ.0.OR.IPINCIRC*IRPHI.NE.0)
     &              CALL PSPLINE(ISOUR,IFREQ)
                ENDIF

C--- INTEGRATION OF FLUX IN PINHOLE (BLENDE)

                IF (IUSEM.EQ.0) THEN

c                if (isour.eq.1.and.ifreq.eq.1) then
c                  caLL Zeit(6)
c                  print*,"     Starting integration over pinhole"
c                endif

                  CALL BLENDE(ISOUR,IFREQ)
                  IF(ISOUR.EQ.NSOURCE.AND.ISTOKES.NE.0) then
                    CALL BLENSTO(IFREQ)
                  endif

                ELSE

                  ICONV=0
                  IF (IPINCIRC.EQ.0) THEN
                    IFLUSS=1
                  ELSE  !IPINCIRC
                    IFLUSS=2
                  ENDIF !IPINCIRC
                  CALL USMCON2

                ENDIF

                DO IY=1,NOBSVY
                  DO IZ=1,NOBSVZ
                    IOBSV=(IY-1)*NOBSVZ+IZ
                    IOBFR=IOBSV+NOBSV*(IFREQ-1)
                    SPECTOT(IOBFR)=SPECTOT(IOBFR)+
     &                SPEC(ISOUR+NSOURCE*(IOBSV-1+NOBSV*(IFREQ-1)))
                  ENDDO   !IZ
                ENDDO   !IY

              else if (ipin.eq.3) then

                CALL BLENDE(ISOUR,IFREQ)
                IF(ISOUR.EQ.NSOURCE.AND.ISTOKES.NE.0)
     &            CALL BLENSTO(IFREQ)
              ENDIF !(IPIN.GT.0)

              WFLUXT(IFREQ)=WFLUXT(IFREQ)+WFLUX(ISOUR+NSOURCE*(IFREQ-1))

            ENDDO !NSOURCE
          ENDDO !IFREQ

        else !if (iomp.eq.0) then

c          if (ipincirc.eq.0) then
            call blendfreq_omp
c          else
c            call blendcircfreq_omp
c          endif

          if (istokes.ne.0) then
            call blenstofreq_omp
          endif

        endif !iomp

C--- FOLD INTENSITY DISTRIBUTIONS

        IF (IFOLD.NE.0.AND.IFOLD.NE.2) THEN
          print*,""
          call zeit(6)
          print*,"     Starting folding procedure"
          IF (IUSEM.EQ.0) THEN
            ALLOCATE(COFOLD(4,4,NOBSV))
c            caLL Zeit(6)
c            print*,"     Starting folding procedure"
            IF (IFOLD.EQ.-2) ALLOCATE(SPCOEFU(3,NOBSV))
            IF (ABS(IFOLD).EQ.1) then
              if (iomp.eq.0) then
                CALL WFOLD
                IF (ISTOKES.NE.0) CALL WFOLDSTO
              else
                call wfold_omp
                IF (ISTOKES.NE.0) then
                  CALL WFOLDSTO_omp
                endif
              endif
            endif
            call powfold
          ELSE !IUSEM
            ICONV=0
            IFLUSS=0
            IF (ISPECANAF.NE.0) THEN
              CALL SPECANAF
            ENDIF
            CALL USMCON2
          ENDIF !IUSEM
        ENDIF !IFOLD

      print*
      call zeit(6)
      print*,"     Finished integration over pinhole"

      ENDIF !IPIN

C--- INTEGRATE SPECTRUM OVER ALL FREQUENCIES

      IF (ISPECINT.NE.0) THEN
        CALL SPECINT
        IF (IFOLD.NE.0) CALL SPECINTF
        IF (IPIN.NE.0) THEN
          CALL CRIFREQ
        ELSE
          CALL CRIFREQS(1)
        ENDIF
      ENDIF

C--- CONVERT FREQUENCES FROM ELECTRONVOLT TO NANOMETER

C260194  IF (IUNIT.EQ.1) CALL CONVUN

      IF (ISTOKES.NE.0) THEN
        ICEN=ICBRILL
        DO IFREQ=1,NFREQ
          DO IC=1,4
            STOKEC(IC,IFREQ)=STOKES(IC,ICEN+NOBSV*(IFREQ-1))
          ENDDO !IC
        ENDDO !NFREQ
      ENDIF !ISTOKES

      IF (ISTOKES.NE.0.AND.IFOLD.NE.0) THEN
        ICEN=ICBRILL
        DO IFREQ=1,NFREQ
          DO IC=1,4
            STOKECF(IC,IFREQ)=STOKESF(IC,ICEN+NOBSV*(IFREQ-1))
          ENDDO !NOBSV
        ENDDO !NFREQ
      ENDIF !ISTOKES

C--- WRITE RESULTS TO FILE

c      print*
c      call zeit(6)
c      print*,"     Writing results to files"

      IF (ISPECDIP.EQ.0) THEN

        WRITE (LUNGFO,*)
        WRITE (LUNGFO,*)
     &'     Source number, mean mag. field (sign from By), abs. mean and rel. rms'
        WRITE (LUNGFO,*)
     &'     for sources, and critical photon energy [eV] or wavelength [nm]'
        WRITE (LUNGFO,*)
     &    '     (with respect to abs. mean):'
        WRITE (LUNGFO,*)

        DO ISOUR=1,NSOURCE
          WRITE (LUNGFO,*)ISOUR
     &      ,SNGL(ECSOUR(4,ISOUR))
     &      ,SNGL(ECSOUR(1,ISOUR))
     &      ,SNGL(ECSOUR(3,ISOUR))
     &      ,SNGL(ECSOUR(2,ISOUR))
        ENDDO !ISOUR

        WRITE (LUNGFO,*)
        WRITE (LUNGFO,*)'     Photon energy cut-off (SPECCUT):',SNGL(SPECCUT)
        WRITE (LUNGFO,*)
        WRITE (LUNGFO,*)
     &    '     Max. field and photon energy cuts for source points:'
        WRITE (LUNGFO,*)
        DO ISOUR=1,NSOURCE
          WRITE (LUNGFO,*)ISOUR
     &      ,SNGL(ECMAX(ISOUR))
     &      ,SNGL(SPECCUT*ecdipev1*DMYENERGY**2*ECMAX(ISOUR))
        ENDDO !ISOUR

      ENDIF !ISPECDIP

      IF(IPIN*ISPECINT.NE.0) THEN

        WRITE (LUNGFO,*)
        WRITE (LUNGFO,*)
     &    '     Critical photon energy or wavelength of calculated flux through'

        IF (IFOLD.NE.0) THEN

          IF (IUNIT.EQ.0)
     &      WRITE (LUNGFO,*)'     pinhole (raw and folded):'
     &      ,SNGL(FREQC),SNGL(FREQCF)
          IF (IUNIT.NE.0)
     &      WRITE (LUNGFO,*)'     pinhole (raw and folded):'
     &      ,SNGL(WELLENC),SNGL(WELLENCF)

        ELSE  !IFOLD

          IF (IUNIT.EQ.0)
     &      WRITE (LUNGFO,*)'     pinhole:',SNGL(FREQC)
          IF (IUNIT.NE.0)
     &      WRITE (LUNGFO,*)'     pinhole:',SNGL(WELLENC)
        ENDIF !IFOLD

        WRITE (LUNGFO,*)

        WRITE (LUNGFO,*)

      ENDIF !IPIN*ISPECINT

      IF(IWFILSP0.NE.0) THEN

        OPEN(UNIT=LUNSP0,FILE=FILESP0)

        WRITE(LUNSP0,*)ICODE,' ',CODE
        WRITE(LUNSP0,*)
        WRITE(LUNSP0,*)NSOURCE,NOBSV,NFREQ,IFREQ2P
        WRITE(LUNSP0,*)NOBSVZ,NOBSVY,MOBSVZ,MOBSVY
        WRITE(LUNSP0,*)MEDGEZ,MEDGEY,MMEDGEZ,MMEDGEY
        WRITE(LUNSP0,*)
        WRITE(LUNSP0,*)PINW,PINH,PINR
        WRITE(LUNSP0,*)OBSVDZ,OBSVDY
        WRITE(LUNSP0,*)

        WRITE(LUNSP0,*)(OBSVZ(IO),IO=1,NOBSVZ)
        WRITE(LUNSP0,*)
        WRITE(LUNSP0,*)(OBSVY(IO),IO=1,NOBSVY)
        WRITE(LUNSP0,*)

        DO IO=1,NOBSV
          WRITE(LUNSP0,*)(OBSV(IX,IO),IX=1,3)
          DO IFR=1,NFREQ
            IF (IUNIT.EQ.0) THEN !260194
              WRITE(LUNSP0,*)FREQ(IFR),
     &          (SPEC(IS+NSOURCE*(IO-1+NOBSV*(IFR-1))),IS=1,NSOURCE)
     &          ,SPECTOT(IO+NOBSV*(IFR-1))
            ELSE !IUNIT
              WRITE(LUNSP0,*)WELLEN(IFR),
     &          (SPEC(IS+NSOURCE*(IO-1+NOBSV*(IFR-1))),IS=1,NSOURCE)
     &          ,SPECTOT(IO+NOBSV*(IFR-1))
            ENDIF !IUNIT
          ENDDO !NFREQ
        ENDDO !NOBSV

        CLOSE(LUNSP0)

      ENDIF !IWFILSP0

      IF(IPHASEANA.NE.0) THEN
        CALL PHASEANA
      ENDIF !(IPHASEANA.NE.0)

      IF(IPHASE.NE.0) THEN
c        if (mthreads.eq.0) then
c          CALL PHASE
c        else
          CALL PHASE_omp
c        endif
      ENDIF !(IPHASE.NE.0)

      IF(IWFILRAY.NE.0) THEN

        OPEN(UNIT=LUNRAY,FILE=FILERAY,STATUS='NEW')

        WRITE(LUNRAY,*)MOBSVZ,MOBSVY,ICODE,SNGL(FREQ(1)),' WAVE'

        DRAY=PINCEN(1)
        DO IY=(NOBSVY-MOBSVY)/2+1,(NOBSVY-MOBSVY)/2+MOBSVY
          YRAY=OBSVY(IY)
          THERAY=ATAN(YRAY/DRAY)*10000. !*10000 mm
          DO IZ=(NOBSVZ-MOBSVZ)/2+1,(NOBSVZ-MOBSVZ)/2+MOBSVZ
            IO=(IY-1)*NOBSVZ+IZ
            ZRAY=OBSVZ(IZ)
            PHIRAY=ATAN(ZRAY/DRAY)*10000.

            RAY=STOKES(1,IO)
     &        /DMYCUR*0.1
     &        /BANWID*0.001
     &        *OBSVDZ*OBSVDY
            RAY1=STOKES(2,IO)
     &        /DMYCUR*0.1
     &        /BANWID*0.001
     &        *OBSVDZ*OBSVDY
            RAY2=STOKES(3,IO)
     &        /DMYCUR*0.1
     &        /BANWID*0.001
     &        *OBSVDZ*OBSVDY
            RAY3=STOKES(4,IO)
     &        /DMYCUR*0.1
     &        /BANWID*0.001
     &        *OBSVDZ*OBSVDY

            IF (RAY.NE.0.0) THEN
              RAY1N=RAY1/RAY
              RAY2N=RAY2/RAY
              RAY3N=RAY3/RAY
            ELSE
              RAY1N=0.0
              RAY2N=0.0
              RAY3N=0.0
            ENDIF   !RAY

C     RAY/PHIRAY/THERAY IS NUMBER OF PHOTONS PER mm**2 PER sec PER 0.001BW
C     PER 100mA IN 10m DISTANCE !?; COORDINATES VALUES IN mm ON FILE

C ABSPRACHE MIT FRANZ            WRITE(LUNRAY,7788) PHIRAY,THERAY,RAY,-RAY1N,RAY2N,RAY3N
      WRITE(LUNRAY,7788) PHIRAY,THERAY,RAY,RAY1N,RAY2N,RAY3N
7788        FORMAT(6(1PE12.4))

          ENDDO !IZ
        ENDDO !IY

        CLOSE(LUNRAY)

        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)'     Data-file written for program RAY'
        WRITE(LUNGFO,*)'     File: ',FILERAY
        WRITE(LUNGFO,*)'     (Device center is assumed at (0,0,0)'
        IF (IUNIT.EQ.0) THEN !260194
          WRITE(LUNGFO,*)'     Photon energy:',SNGL(FREQ(1))
        ELSE
          WRITE(LUNGFO,*)'     Photon energy:',SNGL(WELLEN(1))
        ENDIF
        WRITE(LUNGFO,*)

        WRITE(6,*)
        WRITE(6,*)'     Data-file written for program RAY'
        WRITE(6,*)'     File: ',FILERAY
        WRITE(6,*)'     (Device center is assumed at (0,0,0)'
        IF (IUNIT.EQ.0) THEN !260194
          WRITE(6,*)'     Photon energy:',SNGL(FREQ(1))
        ELSE
          WRITE(6,*)'     Photon energy:',SNGL(WELLEN(1))
        ENDIF
        WRITE(6,*)

      ENDIF !IWFILRAY

      IF(IWFILSTO.NE.0.AND.ISTOKES.NE.0) THEN

        OPEN(UNIT=LUNSTO,FILE=FILESTO)

        WRITE(LUNSTO,*)ICODE,' ',CODE
        WRITE(LUNSTO,*)
        WRITE(LUNSTO,*)NSOURCE,NOBSV,NFREQ,IFREQ2P
        WRITE(LUNSTO,*)NOBSVZ,NOBSVY,MOBSVZ,MOBSVY
        WRITE(LUNSTO,*)MEDGEZ,MEDGEY,MMEDGEZ,MMEDGEY
        WRITE(LUNSTO,*)
        WRITE(LUNSTO,*)PINW,PINH,PINR
        WRITE(LUNSTO,*)OBSVDZ,OBSVDY
        WRITE(LUNSTO,*)

        WRITE(LUNSTO,*)(OBSVZ(IO),IO=1,NOBSVZ)
        WRITE(LUNSTO,*)
        WRITE(LUNSTO,*)(OBSVY(IO),IO=1,NOBSVY)
        WRITE(LUNSTO,*)

        DO IO=1,NOBSV
          WRITE(LUNSTO,*)(OBSV(IX,IO),IX=1,3)
          DO IFR=1,NFREQ
            IF (IUNIT.EQ.0) THEN !260194
              IOBFR=IO+NOBSV*(IFR-1)
              WRITE(LUNSTO,*)FREQ(IFR),(STOKES(IS,IOBFR),IS=1,4)
            ELSE
              WRITE(LUNSTO,*)WELLEN(IFR),(STOKES(IS,IOBFR),IS=1,4)
            ENDIF
          ENDDO !NFREQ
        ENDDO !NOBSV

        CLOSE(LUNSTO)

      ENDIF !IWFILSTO

      IF(IFOLD.NE.0 .AND. IWFILSPF.NE.0) THEN

        OPEN(UNIT=LUNSPF,FILE=FILESPF)

        WRITE(LUNSPF,*)ICODE,' ',CODE
        WRITE(LUNSPF,*)
        WRITE(LUNSPF,*)NSOURCE,NOBSV,NFREQ
        WRITE(LUNSPF,*)NOBSVZ,NOBSVY,MOBSVZ,MOBSVY
        WRITE(LUNSPF,*)MEDGEZ,MEDGEY,MMEDGEZ,MMEDGEY
        WRITE(LUNSPF,*)
        WRITE(LUNSPF,*)PINW,PINH,PINR
        WRITE(LUNSPF,*)OBSVDZ,OBSVDY
        WRITE(LUNSPF,*)

        WRITE(LUNSPF,*)(OBSVZ(IO),IO=1,NOBSVZ)
        WRITE(LUNSPF,*)
        WRITE(LUNSPF,*)(OBSVY(IO),IO=1,NOBSVY)
        WRITE(LUNSPF,*)

        DO IO=1,NOBSV
          WRITE(LUNSPF,*)(OBSV(IX,IO),IX=1,3)
          DO IFR=1,NFREQ
            IF (IUNIT.EQ.0) WRITE(LUNSPF,*)FREQ(IFR)
     &        ,(SPECF(IS+NSOURCE*(IO-1+NOBSV*(IFR-1))),IS=1,NSOURCE)
     &        ,SPECTOTF(IO+NOBSV*(IFR-1))
            IF (IUNIT.NE.0) WRITE(LUNSPF,*)WELLEN(IFR)
     &        ,(SPECF(IS+NSOURCE*(IO-1+NOBSV*(IFR-1))),IS=1,NSOURCE)
     &        ,SPECTOTF(IO+NOBSV*(IFR-1))
          ENDDO !NFREQ
        ENDDO !NOBSV

        CLOSE(LUNSPF)

      ENDIF !IWFILSPF

      IF(istokes.ne.0.and.IFOLD.NE.0 .AND. IWFLSTOF.NE.0) THEN

        OPEN(UNIT=LUNSTOF,FILE=FILESTOF)

        WRITE(LUNSTOF,*)ICODE,' ',CODE
        WRITE(LUNSTOF,*)
        WRITE(LUNSTOF,*)NSOURCE,NOBSV,NFREQ,IFREQ2P
        WRITE(LUNSTOF,*)NOBSVZ,NOBSVY,MOBSVZ,MOBSVY
        WRITE(LUNSTOF,*)MEDGEZ,MEDGEY,MMEDGEZ,MMEDGEY
        WRITE(LUNSTOF,*)
        WRITE(LUNSTOF,*)PINW,PINH,PINR
        WRITE(LUNSTOF,*)OBSVDZ,OBSVDY
        WRITE(LUNSTOF,*)

        WRITE(LUNSTOF,*)(OBSVZ(IO),IO=1,NOBSVZ)
        WRITE(LUNSTOF,*)
        WRITE(LUNSTOF,*)(OBSVY(IO),IO=1,NOBSVY)
        WRITE(LUNSTOF,*)

        DO IO=1,NOBSV
          WRITE(LUNSTOF,*)(OBSV(IX,IO),IX=1,3)
          DO IFR=1,NFREQ
            IF (IUNIT.EQ.0)  !260194
     &        WRITE(LUNSTOF,*)FREQ(IFR),(STOKESF(IS,IO+NOBSV*(IFR-1)),IS=1,4)
            IF (IUNIT.NE.0)
     &        WRITE(LUNSTOF,*)WELLEN(IFR),(STOKESF(IS,IO+NOBSV*(IFR-1)),IS=1,4)
          ENDDO !NFREQ
        ENDDO !NOBSV

        CLOSE(LUNSTOF)

      ENDIF !IWFLSTOF

C--- OUTPUT RESULTS

      WRITE(LUNGFO,*)
      WRITE(LUNGFO,*)'     Results of spectrum calculations'
      WRITE(LUNGFO,*)'     ================================'
      WRITE(LUNGFO,*)
      IF (IPOLA.NE.0) THEN
        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)
     &    '     Photons are polarized parallely to complex vector VPOLA:'
        DO IC=1,3
          WRITE(LUNGFO,*)'     ',CMPLX(VPOLA(IC))
        ENDDO
        WRITE(LUNGFO,*)
      ENDIF !IPOLA

      WRITE(LUNGFO,*)
      WRITE(LUNGFO,*)'     Reflectivity coefficients (complex):'
      WRITE(LUNGFO,*)
      DO IC=1,3
        WRITE(LUNGFO,*)'     ',CONJG(REFLEC(IC))
      ENDDO
      WRITE(LUNGFO,*)
      WRITE(LUNGFO,*)
      WRITE(LUNGFO,*)

      IF (ISPECMODE.EQ.3.OR.ISPECMODE.EQ.4) THEN
        WRITE(LUNGFO,*)
     &    '     Buffer size for integration (NDWSOU):',NDWSOU
        WRITE(LUNGFO,*)
      ENDIF

      IF (ISPECMODE.EQ.3.OR.ISPECMODE.EQ.4) THEN
        WRITE(LUNGFO,*)
     &    '     Provided number of integration steps for each source'
        WRITE(LUNGFO,*)
     &    '     (controlled by NLPOI)'
        WRITE(LUNGFO,*)
     &    '     (not necessarily used)'
        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)(IPOISOU(IS),IS=1,NSOURCE)
      ENDIF

      WRITE(LUNGFO,*)
      WRITE(LUNGFO,*)'     Bandwidth:',SNGL(BANWID)
      WRITE(LUNGFO,*)

      IF(IPIN.EQ.0) THEN

        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)

        WRITE(LUNGFO,*)
     &    '     Photon energy [eV] or wavelength [nm] for all observation'
        WRITE(LUNGFO,*)
     &    '     points, flux per unit area [m**2] for each source,'
        WRITE(LUNGFO,*)
     &    '     total flux density:'
        WRITE(LUNGFO,*)

        WRITE(LUNGFO,*)

        if (iundulator.eq.0) call powgraz

        DO IO=1,NOBSV

          WRITE(LUNGFO,*)'          Observation point (x,y,z) [m]:'
          WRITE(LUNGFO,*)'          ',(SNGL(OBSV(IX,IO)),IX=1,3)

          IF ((ISPECMODE.EQ.3.OR.ISPECMODE.EQ.4).AND.ISPECDIP.EQ.0
     &        .and.ispecana.eq.0) THEN
            WRITE(LUNGFO,*)
     &        '          Number of integration steps for each source:'
            WRITE(LUNGFO,*)
     &        '                 (controlled by NLPOI)'
            WRITE(LUNGFO,*)'          ',(NARGUM(IO,IS),IS=1,NSOURCE)
          ENDIF

          WRITE(LUNGFO,*)
          DO IFR=1,NFREQ
            IF (IUNIT.EQ.0)  !260194
     &        WRITE(LUNGFO,*)'  ',SNGL(FREQ(IFR))
     &        ,(SNGL(SPEC(IS+NSOURCE*(IO-1+NOBSV*(IFR-1)))),IS=1,NSOURCE)
     &        ,SNGL(SPECTOT(IO+NOBSV*(IFR-1)))
            IF (IUNIT.NE.0)  !260194
     &        WRITE(LUNGFO,*)'  ',SNGL(WELLEN(IFR))
     &        ,(SNGL(SPEC(IS+NSOURCE*(IO-1+NOBSV*(IFR-1)))),IS=1,NSOURCE)
     &        ,SNGL(SPECTOT(IO+NOBSV*(IFR-1)))
          ENDDO !IFR


C maximum of spectot{

          IF (NFREQ.GT.1) THEN

            DO IFR=1,NFREQ
              SPECBUFF(IFR)=SPECTOT(IO+NOBSV*(IFR-1))
            ENDDO !IFR

            CALL UTIL_MAX_PARABEL
     &        (NFREQ,FREQ,SPECBUFF,SPECTOTMX(3),SPECTOTMX(4)
     &        ,WSNOBFR1,WSNOBFR2,IFAIL)

            IF (IFAIL.NE.0) THEN
              WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED'
              WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
            ENDIF

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     Estimated maximum:'
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     ',SNGL(SPECTOTMX(3)),SNGL(SPECTOTMX(4))
            WRITE(LUNGFO,*)

          ENDIF   !NFREQ

C maximum of spectot}

      IF (IFOLD.EQ.2) THEN

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)

          WRITE(LUNGFO,*)
     &      '     flux per unit area [m**2] for each source,'
          WRITE(LUNGFO,*)
     &      '     total flux density with emittance:'
          WRITE(LUNGFO,*)

          WRITE(LUNGFO,*)
          DO IFR=1,NFREQ
            SPECTOTF(IO+NOBSV*(IFR-1))=0.0D0
            DO IS=1,NSOURCE
              SPECTOTF(IO+NOBSV*(IFR-1))=
     &          SPECTOTF(IO+NOBSV*(IFR-1))+
     &          SPECF(IS+NSOURCE*(IO-1+NOBSV*(IFR-1)))
            ENDDO
            IF (IUNIT.EQ.0)  !260194
     &        WRITE(LUNGFO,*)'  ',SNGL(FREQ(IFR))
     &        ,(SNGL(SPECF(IS+NSOURCE*(IO-1+NOBSV*(IFR-1)))),IS=1,NSOURCE)
     &        ,SNGL(SPECTOTF(IO+NOBSV*(IFR-1)))
            IF (IUNIT.NE.0)  !260194
     &        WRITE(LUNGFO,*)'  ',SNGL(WELLEN(IFR))
     &        ,(SNGL(SPECF(IS+NSOURCE*(IO-1+NOBSV*(IFR-1)))),IS=1,NSOURCE)
     &        ,SNGL(SPECTOTF(IO+NOBSV*(IFR-1)))
          ENDDO !IFR

C maximum of spectot{

          IF (NFREQ.GT.1) THEN

            DO IFR=1,NFREQ
              SPECBUFF(IFR)=SPECTOTF(IO+NOBSV*(IFR-1))
            ENDDO !IFR

            CALL UTIL_MAX_PARABEL
     &        (NFREQ,FREQ,SPECBUFF,SPECTOTMX(3),SPECTOTMX(4)
     &        ,WSNOBFR1,WSNOBFR2,IFAIL)

            IF (IFAIL.NE.0) THEN
              WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED'
              WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
            ENDIF

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     Estimated maximum:'
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     ',SNGL(SPECTOTMX(3)),SNGL(SPECTOTMX(4))
            WRITE(LUNGFO,*)

          ENDIF   !NFREQ

        ENDIF !IFOLD.EQ.2

C maximum of spectot}

        WRITE(LUNGFO,*)' '

        WRITE(LUNGFO,*)' '
        WRITE(LUNGFO,*)
     &    '     Power density at selected point [W/m**2]:'
        WRITE(LUNGFO,*)

        if (nsource.le.5) then

          WRITE(LUNGFO,*)
     &      '     (for all sources,sum, and sum grazing)'
          IF (IAMPLI.GT.0) THEN
            WRITE(LUNGFO,*)
     &        '     (Option IAMPLI not taken into account!!)'
          ENDIF   !IAMPLI

          WRITE(LUNGFO,*)'   '
     &      ,(SNGL(SPECPOW(IS+NSOURCE*(IO-1))),IS=1,NSOURCE)
     &      ,SNGL(SPECPOWT(IO))
     &      ,SNGL(SPECPOWTgraz(IO))
        else

          WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'

          IF (IAMPLI.GT.0) THEN
            WRITE(LUNGFO,*)
     &        '     (Option IAMPLI not taken into account!!)'
          ENDIF   !IAMPLI

          WRITE(LUNGFO,*)'   '
     &      ,(SNGL(SPECPOW(IS+NSOURCE*(IO-1))),IS=1,2)
     &      ,SNGL(SPECPOW(IS+(NSOURCE/2+1)*(IO-1)))
     &      ,(SNGL(SPECPOW(IS+NSOURCE*(IO-1))),IS=NSOURCE-1,NSOURCE)
     &      ,SNGL(SPECPOWT(IO))
     &      ,SNGL(SPECPOWTgraz(IO))
        endif

        WRITE(LUNGFO,*)' '

        if (ifold.ne.0) then
          WRITE(LUNGFO,*)' '
          WRITE(LUNGFO,*)
     &      '     Power density with emittance at selected point [W/m**2]:'
          WRITE(LUNGFO,*)
          if (nsource.le.5) then
            WRITE(LUNGFO,*)
     &        '     (for all sources and sum)'
            IF (IAMPLI.GT.0) THEN
              WRITE(LUNGFO,*)
     &          '     (Option IAMPLI not taken into account!!)'
            ENDIF !IAMPLI

            WRITE(LUNGFO,*)'   '
     &        ,(SNGL(SPECPOWf(IS+NSOURCE*(IO-1))),IS=1,NSOURCE)
     &        ,SNGL(SPECPOWTf(IO))
          else
            WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'
            IF (IAMPLI.GT.0) THEN
              WRITE(LUNGFO,*)
     &          '     (Option IAMPLI not taken into account!!)'
            ENDIF !IAMPLI

            WRITE(LUNGFO,*)'   '
     &        ,(SNGL(SPECPOWf(IS+NSOURCE*(IO-1))),IS=1,2)
     &        ,SNGL(SPECPOWf(IS+(NSOURCE/2+1)*(IO-1)))
     &        ,(SNGL(SPECPOWf(IS+NSOURCE*(IO-1))),IS=NSOURCE-1,NSOURCE)
     &        ,SNGL(SPECPOWTf(IO))
          endif
          WRITE(LUNGFO,*)' '
        endif !(ifold.ne.0) then

c          IF (IAMPLI.LT.0) THEN
c            WRITE(LUNGFO,*)'     scaled according to IAMPLI:'
c            WRITE(LUNGFO,*)'            '
c     &        ,(SNGL(SPECPOW(IS+NSOURCE*(IO-1))*(-IAMPLI)),IS=1,NSOURCE)
c     &        ,SNGL(SPECPOWT(IO)*(-IAMPLI))
c            WRITE(LUNGFO,*)' '
c          ENDIF  !IAMPLI

          IF (ISPECINT.NE.0) THEN

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
     &        '     Power density [W/m**2]:'
            WRITE(LUNGFO,*)
     &        '     (by integration over spectral range:',
     &        SNGL(FREQ(NFREQ0M)),SNGL(FREQ(NFREQ0P)),','

            if (nsource.le.5) then

              WRITE(LUNGFO,*)
     &          '     for all sources and sum)'
              WRITE(LUNGFO,*)'   '
     &          ,(SNGL(SPECI(IS+NSOURCE*(IO-1))),IS=1,NSOURCE)
     &          ,SNGL(SPECTOTI(IO))

              WRITE(LUNGFO,*)
              WRITE(LUNGFO,*)
     &          '     Divided by total power density:'
              WRITE(LUNGFO,*)'   '
     &          ,(SNGL(SPECI(IS+NSOURCE*(IO-1))/SPECPOW(IS+NSOURCE*(IO-1))),
     &          IS=1,NSOURCE)
     &          ,SNGL(SPECTOTI(IO)/SPECPOWT(IO))

            else

              WRITE(LUNGFO,*)
     &    '     for the first two, the central, and the last sources and sum)'
              WRITE(LUNGFO,*)
     &          '   '
     &          ,(SNGL(SPECI(IS+NSOURCE*(IO-1))),IS=1,2)
     &          ,SNGL(SPECI(IS+(NSOURCE/2+1)*(IO-1)))
     &          ,(SNGL(SPECI(IS+NSOURCE*(IO-1))),IS=nsource-1,NSOURCE)
     &          ,SNGL(SPECTOTI(IO))

              WRITE(LUNGFO,*)
              WRITE(LUNGFO,*)
     &          '     Divided by total power density:'
              WRITE(LUNGFO,*)'   '
     &          ,(SNGL(SPECI(IS+NSOURCE*(IO-1))/SPECPOW(IS+NSOURCE*(IO-1))),
     &          IS=1,2)
     &          ,SNGL(SPECI(IS+(NSOURCE/2+1)*(IO-1))/
     &          SPECPOW(IS+(NSOURCE/2+1)*(IO-1)))
     &          ,(SNGL(SPECI(IS+NSOURCE*(IO-1))/SPECPOW(IS+NSOURCE*(IO-1))),
     &          IS=nsource-1,NSOURCE)
     &          ,SNGL(SPECTOTI(IO)/SPECPOWT(IO))

            endif

            WRITE(LUNGFO,*)

            WRITE (LUNGFO,*)
            WRITE (LUNGFO,*)
     &        '     Critical photon energy or wavelength of calculated flux density'

            IF (IUNIT.EQ.0)
     &        WRITE (LUNGFO,*)'     first observation point:',SNGL(FREQC)
            IF (IUNIT.NE.0)
     &        WRITE (LUNGFO,*)'     first observation point:',SNGL(WELLENC)
            WRITE (LUNGFO,*)

            WRITE(LUNGFO,*)
     &        '     Total number of photons per second at critical energy'
            WRITE(LUNGFO,*)
     &        '     for first observation point:'
            WRITE(LUNGFO,*)'            ',
     &        SNGL(SNGL(SPECTOTI(1))/FREQC/ECHARGE1)

            IF (IDESYNC.NE.0) THEN

              WRITE(LUNGFO,*)
     &          '     Power density at selected point [W/m**2] * AREAM2:'
              WRITE(LUNGFO,*)
     &          '     (by integration over spectral range:',
     &          SNGL(FREQ(NFREQ0M)),SNGL(FREQ(NFREQ0P)),','
              if (nsource.le.5) then
                WRITE(LUNGFO,*)
     &            '     for all sources and sum)'
                WRITE(LUNGFO,*)'   '
     &            ,(SNGL(SPECI(IS+NSOURCE*(IO-1))*AREAM2),IS=1,NSOURCE)
     &            ,SNGL(SPECTOTI(IO)*AREAM2)
              else
                WRITE(LUNGFO,*)'     for the first two, the central, and the last sources and sum)'
                WRITE(LUNGFO,*)
                WRITE(LUNGFO,*)'   '
     &            ,(SNGL(SPECI(IS+NSOURCE*(IO-1))*AREAM2),IS=1,2)
     &            ,(SNGL(SPECI(IS+(NSOURCE/2+1)*(IO-1))*AREAM2))
     &            ,(SNGL(SPECI(IS+NSOURCE*(IO-1))*AREAM2),IS=nsource-1,NSOURCE)
     &            ,SNGL(SPECTOTI(IO)*AREAM2)
              endif
            ENDIF !IDESYNC
            WRITE(LUNGFO,*)

        IF (IDOSE.NE.0) THEN

          WRITE(LUNGFO,*)" "
          WRITE(LUNGFO,*)"     *** CAUTION: THE DOSE CALCULATIONS ARE NOT MEANT FOR RADITATION SAFETY PRUPOSES OR MEDICAL APPLICATIONS ***"
          WRITE(LUNGFO,*)" "

          WRITE(LUNGFO,*)
     &      '     Absorbed energy dose rate [Gy/sec]:',SNGL(ENEDOS(IO))
          WRITE(LUNGFO,*)
     &      '     Absorbed energy dose rate [mGy/h]:',SNGL(ENEDOS(IO)
     &      *1000.*3600)
          WRITE(LUNGFO,*)
     &      '     Absorbed energy dose rate [mGy/6000h]:',SNGL(ENEDOS(IO)
     &      *1000.*3600*6000)
           WRITE(LUNGFO,*)

          IF (IO.EQ.NOBSV) THEN
            ENEDOSMX=-1.D30
            DO IOBSV=1,NOBSV
              IF (ENEDOS(IOBSV).GT.ENEDOSMX) ENEDOSMX=ENEDOS(IOBSV)
            ENDDO
            WRITE(LUNGFO,*)
     &        '     Maximum absorbed energy dose rate [Gy/sec]:',SNGL(ENEDOSMX)
            WRITE(LUNGFO,*)
     &        '     Maximum absorbed energy dose rate [mGy/h]:',SNGL(ENEDOSMX
     &        *1000.*3600)
            WRITE(LUNGFO,*)
     &        '     Maximum absorbed energy dose rate [mGy/6000h]:',SNGL(ENEDOSMX
     &        *1000.*3600*6000)
            WRITE(LUNGFO,*)

          ENDIF   !IO=NOBSV

        ENDIF !IDOSE

      ENDIF !ISPECINT


        ENDDO !IO

      ENDIF  !IPIN.eq.0

      IF(IPIN.NE.0) THEN

        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)'     Pinhole position (x,y,z) [m]:'
        WRITE(LUNGFO,*)'     ',(SNGL(PINCEN(IO)),IO=1,3)
        WRITE(LUNGFO,*)

        IF(IPIN.NE.2.and.ipin.ne.3) THEN

          WRITE(LUNGFO,*)
     &      '     Numbers defining inner vert. and hori. edges (MMEDGEY,MMEDGEZ): ',
     &      MMEDGEY,MMEDGEZ," (obsolete, MUST be zero)"
          if (mmedgey.ne.0.or.mmedgez.ne.0) stop "MMEDGEY OR MMEDGEZ NOT ZERO!"
          WRITE(LUNGFO,*)
     &      '     Numbers defining outerer vert. and hori. edges (MEDGEY,MEDGEZ): ',
     &      MEDGEY,MEDGEZ
          WRITE(LUNGFO,*)
     &      '     Total number of vert. and hori. points:          ',NOBSVY,NOBSVZ
          WRITE(LUNGFO,*)
     &      '     Number of vert. and horiz. points inside pinhole:',MOBSVY,MOBSVZ
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '     Vertical and horizontal grid size [m]:     '
     &      ,SNGL(OBSVDY),SNGL(OBSVDZ)

        ENDIF !IPIN.NE.2

        IF (MPINR.NE.0) THEN
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '     IQAUDPHI, NOBSVR, NOBSVPHI: ',IQUADPHI,NOBSVR, NOBSVPHI
          WRITE(LUNGFO,*)
     &      '     OBSVDR, OBSVDPHI: ',SNGL(OBSVDR),SNGL(OBSVDPHI*RADGRA1)
          WRITE(LUNGFO,*)
        ENDIF

        IF(IPIN.NE.2.and.ipin.ne.3) THEN

          WRITE(LUNGFO,*)
     &      '     Vertical and horizontal size [m x m]:      '
     &      ,AMAX1(SNGL(OBSVDY),(MOBSVY-1)*SNGL(OBSVDY))
     &      ,AMAX1(SNGL(OBSVDZ),(MOBSVZ-1)*SNGL(OBSVDZ))

          WRITE(LUNGFO,*)
     &      '     Total vert. and horiz. size [m x m]:       '
     &      ,AMAX1(SNGL(OBSVDY),(NOBSVY-1)*SNGL(OBSVDY))
     &      ,AMAX1(SNGL(OBSVDZ),(NOBSVZ-1)*SNGL(OBSVDZ))

        else

          if (ipincirc.eq.0) then
            WRITE(LUNGFO,*)
     &        '     Vertical and horizontal size [m x m]:      ',
     &        SNGL(pinh),sngl(pinw)
          endif

        ENDIF !(IPIN.NE.2)

        IF (IPINCIRC.NE.0) THEN

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &'     Flux is calculated through circ. pinhole, radius [m] and area [m x m]:'
          WRITE(LUNGFO,*)'      ',SNGL(pinr),sngl(pi1*pinr**2)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)

        ENDIF

        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)
     &    '     Photon energy or wavelength and flux through pinhole:'

        if (nsource.le.5) then
          WRITE(LUNGFO,*)'     (for all sources and sum)'
          WRITE(LUNGFO,*)

          DO IFR=1,NFREQ

            IF (IUNIT.EQ.0)
     &        WRITE(LUNGFO,*)'  ',SNGL(FREQ(IFR))
     &        ,(SNGL(WFLUX(IS+NSOURCE*(IFR-1))),IS=1,NSOURCE)
     &        ,SNGL(WFLUXT(IFR))

            IF (IUNIT.NE.0)
     &        WRITE(LUNGFO,*)'  ',SNGL(WELLEN(IFR))
     &        ,(SNGL(WFLUX(IS+NSOURCE*(IFR-1))),IS=1,NSOURCE)
     &        ,SNGL(WFLUXT(IFR))

          ENDDO !IFR
        else
          WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'
          WRITE(LUNGFO,*)

          DO IFR=1,NFREQ

            IF (IUNIT.EQ.0)
     &        WRITE(LUNGFO,*)'  ',SNGL(FREQ(IFR))
     &        ,(SNGL(WFLUX(IS+NSOURCE*(IFR-1))),IS=1,2)
     &        ,SNGL(WFLUX(IS+(NSOURCE/2+1)*(IFR-1)))
     &        ,(SNGL(WFLUX(IS+NSOURCE*(IFR-1))),IS=nsource-1,NSOURCE)
     &        ,SNGL(WFLUXT(IFR))

            IF (IUNIT.NE.0)
     &        WRITE(LUNGFO,*)'  ',SNGL(WELLEN(IFR))
     &        ,(SNGL(WFLUX(IS+NSOURCE*(IFR-1))),IS=1,2)
     &        ,SNGL(WFLUX(IS+(NSOURCE/2+1)*(IFR-1)))
     &        ,(SNGL(WFLUX(IS+NSOURCE*(IFR-1))),IS=nsource-1,NSOURCE)
     &        ,SNGL(WFLUXT(IFR))

          ENDDO !IFR
        endif

C maximum of spectot{

        IF (NFREQ.GT.1) THEN

          DO IFR=1,NFREQ
            SPECBUFF(IFR)=WFLUXT(IFR)
          ENDDO   !IFR

          CALL UTIL_MAX_PARABEL
     &      (NFREQ,FREQ,SPECBUFF,SPECTOTMX(5),SPECTOTMX(6)
     &      ,WSNOBFR1,WSNOBFR2,IFAIL)

          IF (IFAIL.NE.0) THEN
            WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED'
            WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
          ENDIF

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'     Estimated maximum:'
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'     ',SNGL(SPECTOTMX(5)),SNGL(SPECTOTMX(6))
          WRITE(LUNGFO,*)

        ENDIF  !NFREQ

C maximum of spectot}

        IF (IPINALL.NE.0) THEN

          if (ipin.ne.3) then
            DO IFR=1,NFREQ

              WRITE(LUNGFO,*)
              WRITE(LUNGFO,*)'     Flux density at each grid point:'
              WRITE(LUNGFO,*)
              DO IY=1,NOBSVY
                IF (IF1DIM.EQ.0) WRITE(LUNGFO,*)
                DO IZ=1,NOBSVZ
                  IOBSV=(IY-1)*NOBSVZ+IZ
                  WRITE(LUNGFO,*)'           '
     &              ,(SNGL(SPEC(IS+NSOURCE*(IOBSV-1+NOBSV*(IFR-1)))),IS=1,NSOURCE)
     &              ,SNGL(SPECTOT(IOBSV+NOBSV*(IFR-1)))
                ENDDO   !IZ
              ENDDO   !IY
              WRITE(LUNGFO,*)

            ENDDO !NFREQ

          endif !ipin.ne.3

        ELSE !IPINALL.NE.0

          if (ipin.ne.3) then
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     Flux density for selected point:'
            WRITE(LUNGFO,*)
          else
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     Mean flux density:'
            WRITE(LUNGFO,*)
          endif

          DO IFR=1,NFREQ

            IOBSV=ICBRILL

            WRITE(LUNGFO,*)'           '
     &        ,SNGL(FREQ(IFR)),(SNGL(SPEC(IS+NSOURCE*(IOBSV-1+NOBSV*(IFR-1)))),IS=1,NSOURCE)
     &        ,SNGL(SPECTOT(IOBSV+NOBSV*(IFR-1)))

          ENDDO   !NFREQ

C maximum of spectot{

          IF (NFREQ.GT.1) THEN

            DO IFR=1,NFREQ
              SPECBUFF(IFR)=SPECTOT(ICBRILL+NOBSV*(IFR-1))
            ENDDO !IFR

            CALL UTIL_MAX_PARABEL
     &        (NFREQ,FREQ,SPECBUFF,SPECTOTMX(1),SPECTOTMX(2)
     &        ,WSNOBFR1,WSNOBFR2,IFAIL)

            IF (IFAIL.NE.0) THEN
              WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED'
              WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
            ENDIF

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     Estimated maximum:'
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     ',SNGL(SPECTOTMX(1)),SNGL(SPECTOTMX(2))
            WRITE(LUNGFO,*)

          ENDIF   !NFREQ

C maximum of spectot}

        ENDIF !IPINALL

        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)
     &    '     Power through pinhole [W]:'
        if (nsource.le.5) then
          WRITE(LUNGFO,*)'     (for all sources and sum)'
          IF (IAMPLI.GT.0) THEN
            WRITE(LUNGFO,*)
     &        '     (Option IAMPLI not taken into account!!)'
          ENDIF   !IAMPLI
          WRITE(LUNGFO,*)'   '
     &      ,(SNGL(SPECPOWVH(IS)),IS=1,NSOURCE)
     &      ,SNGL(SPECPOWVHT)
          WRITE(LUNGFO,*)
        else
          WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'
          IF (IAMPLI.GT.0) THEN
            WRITE(LUNGFO,*)
     &        '     (Option IAMPLI not taken into account!!)'
          ENDIF   !IAMPLI
          WRITE(LUNGFO,*)'   '
     &      ,(SNGL(SPECPOWVH(IS)),IS=1,2)
     &      ,SNGL(SPECPOWVH(nsource/2+1))
     &      ,(SNGL(SPECPOWVH(IS)),IS=nsource-1,NSOURCE)
     &      ,SNGL(SPECPOWVHT)
          WRITE(LUNGFO,*)
        endif
c        IF (IAMPLI.LT.0) THEN
c          WRITE(LUNGFO,*)'     scaled according to IAMPLI:'
c          WRITE(LUNGFO,*)'            '
c     &      ,(SNGL(SPECPOWVH(IS)*(-IAMPLI)),IS=1,NSOURCE)
c     &      ,SNGL(SPECPOWVHT*(-IAMPLI))
c          WRITE(LUNGFO,*)' '
c        ENDIF !IAMPLI

        WRITE(LUNGFO,*)
        if (ipin.ne.3) then
          WRITE(LUNGFO,*)
     &      '     Power density at selected point [W/m**2]:'
          IF (IAMPLI.GT.0) THEN
            WRITE(LUNGFO,*)
     &        '     (Option IAMPLI not taken into account!!)'
          ENDIF   !IAMPLI
        else
          WRITE(LUNGFO,*)
     &      '     Mean power density [W/m**2]:'
          IF (IAMPLI.GT.0) THEN
            WRITE(LUNGFO,*)
     &        '     (Option IAMPLI not taken into account!!)'
          ENDIF   !IAMPLI
        endif
        WRITE(LUNGFO,*)

        IOBSV=ICBRILL
        WRITE(LUNGFO,*)'            '
     &    ,(SNGL(SPECPOW(IS+NSOURCE*(IOBSV-1))),IS=1,NSOURCE)
     &    ,SNGL(SPECPOWT(IOBSV))
        WRITE(LUNGFO,*)

c        IF (IAMPLI.LT.0) THEN
c          WRITE(LUNGFO,*)'     scaled according to IAMPLI:'
c          WRITE(LUNGFO,*)'            '
c     &      ,(SNGL(SPECPOW(IS+NSOURCE*(IOBSV-1))*(-IAMPLI)),IS=1,NSOURCE)
c     &      ,SNGL(SPECPOWT(IOBSV)*(-IAMPLI))
c          WRITE(LUNGFO,*)' '
c        ENDIF !IAMPLI

        IF (ISPECINT.NE.0) THEN

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '     Power [W] through pinhole or power density [W/m**2]:'
          WRITE(LUNGFO,*)
     &      '     (by integration over spectral range:',
     &      SNGL(FREQ(NFREQ0M)),SNGL(FREQ(NFREQ0P)),','
          if (nsource.le.5) then
            WRITE(LUNGFO,*)
     &        '     for all sources and sum)'
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'   '
     &        ,(SNGL(WFLUXI(IS)),IS=1,NSOURCE)
     &        ,SNGL(WFLUXTI)
          else
            WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'
            WRITE(LUNGFO,*)
     &        '     for all sources and sum)'
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'   '
     &        ,(SNGL(WFLUXI(IS)),IS=1,2)
     &        ,SNGL(WFLUXI(nsource/2+1))
     &        ,(SNGL(WFLUXI(IS)),IS=nsource-1,NSOURCE)
     &        ,SNGL(WFLUXTI)
          endif
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '     Corresponding total number of photons at critical energy:'
          WRITE(LUNGFO,*)'            ',SNGL(WFLUXTI/FREQC/ECHARGE1)
          WRITE(LUNGFO,*)

          IF (IPINALL.NE.0) THEN

            if (ipin.ne.3) then

              WRITE(LUNGFO,*)
              WRITE(LUNGFO,*)
     &          '     Power density at each grid point [W/m**2]:'
              WRITE(LUNGFO,*)
     &          '     (by integration over spectral range:',
     &          SNGL(FREQ(NFREQ0M)),SNGL(FREQ(NFREQ0P)),','
              if (nsource.le.5) then
                WRITE(LUNGFO,*)
     &            '     for all sources and sum)'
                WRITE(LUNGFO,*)
                DO IY=1,NOBSVY
                  IF (IF1DIM.EQ.0) WRITE(LUNGFO,*)
                  DO IZ=1,NOBSVZ
                    IOBSV=(IY-1)*NOBSVZ+IZ
                    WRITE(LUNGFO,*)'   '
     &                ,(SNGL(SPECI(IS+NSOURCE*(IOBSV-1))),IS=1,NSOURCE)
     &                ,SNGL(SPECTOTI(IOBSV))
                  ENDDO   !IZ
                ENDDO   !IY
              else
                WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'
                WRITE(LUNGFO,*)
                DO IY=1,NOBSVY
                  IF (IF1DIM.EQ.0) WRITE(LUNGFO,*)
                  DO IZ=1,NOBSVZ
                    IOBSV=(IY-1)*NOBSVZ+IZ
                    WRITE(LUNGFO,*)'   '
     &                ,(SNGL(SPECI(IS+NSOURCE*(IOBSV-1))),IS=1,2)
     &                ,SNGL(SPECI(IS+(NSOURCE/2+1)*(IOBSV-1)))
     &                ,(SNGL(SPECI(IS+NSOURCE*(IOBSV-1))),IS=nsource-1,NSOURCE)
     &                ,SNGL(SPECTOTI(IOBSV))
                  ENDDO   !IZ
                ENDDO   !IY
              endif
              WRITE(LUNGFO,*)

            endif !ipin.ne.3

          ELSE !(IPINALL.NE.0)

            WRITE(LUNGFO,*)
            if (ipin.ne.3) then
              WRITE(LUNGFO,*)
     &          '     Power density at selected point [W/m**2]:'
              WRITE(LUNGFO,*)
     &          '     (by integration over spectral range:',
     &          SNGL(FREQ(NFREQ0M)),SNGL(FREQ(NFREQ0P)),','
              if (nsource.le.5) then
                WRITE(LUNGFO,*)
     &            '     for all sources and sum)'
              else
                WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'
              endif
            else
              WRITE(LUNGFO,*)
     &          '     Mean power density [W/m**2]:'
              WRITE(LUNGFO,*)
     &          '     (by integration over spectral range:',
     &          SNGL(FREQ(NFREQ0M)),SNGL(FREQ(NFREQ0P)),','
              if (nsource.le.5) then
                WRITE(LUNGFO,*)
     &            '     for all sources and sum)'
              else
                WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'
              endif
            endif
            WRITE(LUNGFO,*)

            IOBSV=ICBRILL
            if (nsource.le.5) then
              WRITE(LUNGFO,*)'     '
     &          ,(SNGL(SPECI(IS+NSOURCE*(IOBSV-1))),IS=1,NSOURCE)
     &          ,SNGL(SPECTOTI(IOBSV))
            else
              WRITE(LUNGFO,*)'   '
     &          ,(SNGL(SPECI(IS+NSOURCE*(IOBSV-1))),IS=1,2)
     &          ,SNGL(SPECI(IS+(NSOURCE/2+1)*(IOBSV-1)))
     &          ,(SNGL(SPECI(IS+NSOURCE*(IOBSV-1))),IS=nsource-1,NSOURCE)
     &          ,SNGL(SPECTOTI(IOBSV))
              WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'
            endif
            WRITE(LUNGFO,*)

          ENDIF !IPINALL

          WRITE(LUNGFO,*)

          IF (IDOSE.NE.0) THEN

            WRITE(LUNGFO,*)" "
            WRITE(LUNGFO,*)"     *** CAUTION: THE DOSE CALCULATIONS ARE NOT MEANT FOR RADITATION SAFETY PRUPOSES OR MEDICAL APPLICATIONS ***"
            WRITE(LUNGFO,*)" "

            DO IO=1,NOBSV

              IF (IPINALL.NE.0) THEN

                WRITE(LUNGFO,*)
     &            '     Z, Y:',SNGL(OBSVZ(IO)),SNGL(OBSVY(IO))
                WRITE(LUNGFO,*)
     &            '     Absorbed energy dose rate [mGy/h]:',SNGL(ENEDOS(IO)
     &            *1000.*3600)
                WRITE(LUNGFO,*)

              ENDIF  !IPINALL

              IF (IO.EQ.NOBSV) THEN
                ENEDOSMX=-1.D30
                DO IOBSV=1,NOBSV
                  IF (ENEDOS(IOBSV).GT.ENEDOSMX) ENEDOSMX=ENEDOS(IOBSV)
                ENDDO
                WRITE(LUNGFO,*)
     &            '     Maximum absorbed energy dose rate [Gy/sec]:',SNGL(ENEDOSMX)
                WRITE(LUNGFO,*)
     &            '     Maximum absorbed energy dose rate [mGy/h]:',SNGL(ENEDOSMX
     &            *1000.*3600)
                WRITE(LUNGFO,*)
     &            '     Maximum absorbed energy dose rate [mGy/a]:',SNGL(ENEDOSMX
     &            *1000.*3600*6000)
                WRITE(LUNGFO,*)

              ENDIF  !IO=NOBSV
            ENDDO !IO

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
     &        '      Dose rate averaged over pinhole [Gy/sec]:',SNGL(PINDOS)
            WRITE(LUNGFO,*)
     &        '      Dose rate averaged over pinhole [mGy/h]:',SNGL(PINDOS
     &        *1000.*3600)
            WRITE(LUNGFO,*)
     &        '      Dose rate averaged over pinhole [mGy/a]:',SNGL(PINDOS
     &        *1000.*3600*6000)
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     Effective pinhole size [m**2]:'
     &        ,PINDOS*PINW*PINH/ENEDOSMX
            WRITE(LUNGFO,*)'     Effective pinhole height [m]:'
     &        ,PINDOS*PINH/ENEDOSMX

            if (ipincirc.ne.0) then
              print*,"Error in spectrum: Dose calculation require rectangular pinhole ***"
              print*,"*** Program WAVE aborted ***"
              stop
            endif

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
     &        '      The estimated scattered dose behind the filter is the averaged dose scaled to the full solid angle.'
            WRITE(LUNGFO,*)
     &        '      *** DO NOT USE THESE ESTIMATIONS FOR RADIATION SAFETY OF MEDICAL APPLICATONS ***'
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
     &        '      Estimated scattered dose 1m behind the filter 1m distance [Gy/sec]',
     &        SNGL(PINDOS*(pinw*pinh/pincen(1)**2)/4./pi1)
            WRITE(LUNGFO,*)
     &        '      Estimated scattered dose 1m behind the filter in 1m distance [mGy/h]',
     &        SNGL(PINDOS*(pinw*pinh/pincen(1)**2)/4./pi1*1000.*3600)
            WRITE(LUNGFO,*)
     &        '      Estimated scattered dose behind the filter in 1m distance [mGy/a]',
     &        SNGL(PINDOS*(pinw*pinh/pincen(1)**2)/4./pi1*1000.*3600*6000)
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     Effective pinhole size [m**2]:'
     &        ,PINDOS*PINW*PINH/ENEDOSMX
            WRITE(LUNGFO,*)'     Effective pinhole height [m]:'
     &        ,PINDOS*PINH/ENEDOSMX

          ENDIF !IDOSE

        ENDIF !ISPECINT
        WRITE(LUNGFO,*)

        if (ipin.eq.3) then

           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)'     Horizontal emittance EPS0H [m-rad]:',EPS0H
           WRITE(LUNGFO,*)'     Vertical emittance EPS0V [m-rad]:  ',EPS0V
           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'     Sigmas of sources for horiz. folding:'
          WRITE(LUNGFO,*)'     ',(SNGL(WSIGZ(IS)),IS=1,NSOURCE)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'     Sigmas of sources for vert. folding:'
          WRITE(LUNGFO,*)'     ',(SNGL(WSIGY(IS)),IS=1,NSOURCE)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'     Sigmas of horizontal beam size and divergence:'
          WRITE(LUNGFO,*)
     &      '     (if not zero, sigmas for folding are calculated from these values)'
          WRITE(LUNGFO,*)'     ',(SNGL(BSIGZ(IS)),SNGL(BSIGZP(IS)),IS=1,NSOURCE)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'     Sigmas of vertical beam size and divergence:'
          WRITE(LUNGFO,*)
     &      '     (if not zero, sigmas for folding are calculated from these values)'
          WRITE(LUNGFO,*)'     ',(SNGL(BSIGY(IS)),SNGL(BSIGYP(IS)),IS=1,NSOURCE)
          WRITE(LUNGFO,*)

        else IF (IFOLD.NE.0)   THEN

          WRITE(LUNGFO,*)

          if (ipin.ne.3) then
            IF (IFOLD.NE.2.AND.IFOLD.NE.1)
     &        WRITE(LUNGFO,*)
     &        '     Number of Fourier coefficients for folding:',NGFOURZ,NGFOURY

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     Number of sigmas for horiz. folding:'
            WRITE(LUNGFO,*)'     ',(SNGL(DGSIGZ(IS)),IS=1,NSOURCE)
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     Number of sigmas for vert. folding:'
            WRITE(LUNGFO,*)'     ',(SNGL(DGSIGY(IS)),IS=1,NSOURCE)
            WRITE(LUNGFO,*)
          endif
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'     Sigmas of sources for horiz. folding:'
          WRITE(LUNGFO,*)'     ',(SNGL(WSIGZ(IS)),IS=1,NSOURCE)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'     Sigmas of sources for vert. folding:'
          WRITE(LUNGFO,*)'     ',(SNGL(WSIGY(IS)),IS=1,NSOURCE)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'     Sigmas of horizontal beam size and divergence:'
          WRITE(LUNGFO,*)
     &      '     (if not zero, sigmas for folding are calculated from these values)'
          WRITE(LUNGFO,*)'     ',(SNGL(BSIGZ(IS)),SNGL(BSIGZP(IS)),IS=1,NSOURCE)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'     Sigmas of vertical beam size and divergence:'
          WRITE(LUNGFO,*)
     &      '     (if not zero, sigmas for folding are calculated from these values)'
          WRITE(LUNGFO,*)'     ',(SNGL(BSIGY(IS)),SNGL(BSIGYP(IS)),IS=1,NSOURCE)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)

          IF (ISTOKES.NE.0) THEN
            WRITE(LUNGFO,*)
     &        '     Sigmas for folding of components of STOKES vector:'
            WRITE(LUNGFO,*)
     &        '     ',SNGL(WSIGZ(ISIGSTO)),SNGL(WSIGY(ISIGSTO))
            WRITE(LUNGFO,*)
          ENDIF !ISTOKES
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '     Photon energy or wavelen. and flux through pinhole with emittance effects:'
          WRITE(LUNGFO,*)

          DO IFR=1,NFREQ

            IF (IUNIT.EQ.0)
     &        WRITE(LUNGFO,*)'  ',SNGL(FREQ(IFR))
     &        ,(SNGL(WFLUXF(IS+NSOURCE*(IFR-1))),IS=1,NSOURCE)
     &        ,SNGL(WFLUXTF(IFR))
            IF (IUNIT.NE.0)
     &        WRITE(LUNGFO,*)'  ',SNGL(WELLEN(IFR))
     &        ,(SNGL(WFLUXF(IS+NSOURCE*(IFR-1))),IS=1,NSOURCE)
     &        ,SNGL(WFLUXTF(IFR))

          ENDDO !IFR

C maximum of spectot{

          IF (NFREQ.GT.1) THEN

            DO IFR=1,NFREQ
              SPECBUFF(IFR)=WFLUXTF(IFR)
            ENDDO !IFR

            CALL UTIL_MAX_PARABEL
     &        (NFREQ,FREQ,SPECBUFF,SPECTOTMX(1),SPECTOTMX(2)
     &        ,WSNOBFR1,WSNOBFR2,IFAIL)

            IF (IFAIL.NE.0) THEN
              WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED'
              WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
            ENDIF

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     Estimated maximum:'
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'     ',SNGL(SPECTOTMX(1)),SNGL(SPECTOTMX(2))
            WRITE(LUNGFO,*)

          ENDIF   !NFREQ

C maximum of spectot}

          if (ipin.ne.3) then

            IF (IPINALL.NE.0) THEN

              WRITE(LUNGFO,*)
              WRITE(LUNGFO,*)'     Flux density at each grid point with emittance:'
              WRITE(LUNGFO,*)

              DO IFR=1,NFREQ

                DO IY=(NOBSVY-MOBSVY)/2+1,(NOBSVY-MOBSVY)/2+MOBSVY
                  IF (IF1DIM.EQ.0) WRITE(LUNGFO,*)
                  DO IZ=(NOBSVZ-MOBSVZ)/2+1,(NOBSVZ-MOBSVZ)/2+MOBSVZ
                    IOBSV=(IY-1)*NOBSVZ+IZ
                    WRITE(LUNGFO,*)'           '
     &                ,(SNGL(SPECF(IS+NSOURCE*(IOBSV-1+NOBSV*(IFR-1)))),IS=1,NSOURCE)
     &                ,SNGL(SPECTOTF(IOBSV+NOBSV*(IFR-1)))
                  ENDDO   !IZ
                ENDDO   !IY
                WRITE(LUNGFO,*)

              ENDDO    !IFR

            ELSE !(IPINALL.NE.0)

              WRITE(LUNGFO,*)
              WRITE(LUNGFO,*)
     &          '     Flux density at selected point with emittance:'
              WRITE(LUNGFO,*)

              DO IFR=1,NFREQ

                IOBSV=ICBRILL
                WRITE(LUNGFO,*)'           '
     &            ,SNGL(FREQ(IFR))
     &            ,(SNGL(SPECF(IS+NSOURCE*(IOBSV-1+NOBSV*(IFR-1)))),IS=1,NSOURCE)
     &            ,SNGL(SPECTOTF(IOBSV+NOBSV*(IFR-1)))

              ENDDO    !IFR

C maximum of spectot{

              IF (NFREQ.GT.1) THEN

                DO IFR=1,NFREQ
                  SPECBUFF(IFR)=SPECTOTF(ICBRILL+NOBSV*(IFR-1))
                ENDDO   !IFR

                CALL UTIL_MAX_PARABEL
     &            (NFREQ,FREQ,SPECBUFF,SPECTOTMX(1),SPECTOTMX(2)
     &            ,WSNOBFR1,WSNOBFR2,IFAIL)

                IF (IFAIL.NE.0) THEN
                  WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED'
                  WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
                ENDIF

                WRITE(LUNGFO,*)
                WRITE(LUNGFO,*)'     Estimated maximum:'
                WRITE(LUNGFO,*)
                WRITE(LUNGFO,*)'     ',SNGL(SPECTOTMX(1)),SNGL(SPECTOTMX(2))
                WRITE(LUNGFO,*)

              ENDIF  !NFREQ

C maximum of spectot}

            ENDIF !IPINALL

            IF (ISPECINT.NE.0) THEN

              WRITE(LUNGFO,*)
     &          '     Power [W] or power density [W/m**2] with emittance'
              WRITE(LUNGFO,*)
     &          '     (by integration over spectral range:',
     &          SNGL(FREQ(NFREQ0M)),SNGL(FREQ(NFREQ0P)),','
              if (nsource.le.5) then
                WRITE(LUNGFO,*)
     &            '     for all sources and sum)'
                WRITE(LUNGFO,*)
                WRITE(LUNGFO,*)'   '
     &            ,(SNGL(WFLUXIF(IS)),IS=1,NSOURCE)
     &            ,SNGL(WFLUXTIF)
              else
                WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'
                WRITE(LUNGFO,*)
                WRITE(LUNGFO,*)'   '
     &            ,(SNGL(WFLUXIF(IS)),IS=1,2)
     &            ,SNGL(WFLUXIF(nsource/2+1))
     &            ,(SNGL(WFLUXIF(IS)),IS=nsource-1,NSOURCE)
     &            ,SNGL(WFLUXTIF)
              endif
              WRITE(LUNGFO,*)
              WRITE(LUNGFO,*)
     &          '     Corresponding total number of photons at critical energy:'
              WRITE(LUNGFO,*)'     ',SNGL(WFLUXTIF/FREQCF/ECHARGE1)

              IF (IPINALL.NE.0) THEN

                WRITE(LUNGFO,*)
                WRITE(LUNGFO,*)
     &            '     Power density at each grid point [W/m**2] with emittance:'
                WRITE(LUNGFO,*)
     &            '     (by integration over spectral range:',
     &            SNGL(FREQ(NFREQ0M)),SNGL(FREQ(NFREQ0P)),','
                if (nsource.le.5) then
                  WRITE(LUNGFO,*)
     &              '     for all sources and sum)'
                  WRITE(LUNGFO,*)
                  DO IY=(NOBSVY-MOBSVY)/2+1,(NOBSVY-MOBSVY)/2+MOBSVY
                    IF (IF1DIM.EQ.0) WRITE(LUNGFO,*)
                    DO IZ=(NOBSVZ-MOBSVZ)/2+1,(NOBSVZ-MOBSVZ)/2+MOBSVZ
                      IOBSV=(IY-1)*NOBSVZ+IZ
                      WRITE(LUNGFO,*)'   '
     &                  ,(SNGL(SPECIF(IS+NSOURCE*(IOBSV-1))),IS=1,NSOURCE)
     &                  ,SNGL(SPECTOTIF(IOBSV))
                    ENDDO   !IZ
                  ENDDO   !IY
                else
                  WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'
                  WRITE(LUNGFO,*)
                  DO IY=(NOBSVY-MOBSVY)/2+1,(NOBSVY-MOBSVY)/2+MOBSVY
                    IF (IF1DIM.EQ.0) WRITE(LUNGFO,*)
                    DO IZ=(NOBSVZ-MOBSVZ)/2+1,(NOBSVZ-MOBSVZ)/2+MOBSVZ
                      IOBSV=(IY-1)*NOBSVZ+IZ
                      WRITE(LUNGFO,*)'   '
     &                  ,(SNGL(SPECIF(IS+NSOURCE*(IOBSV-1))),IS=1,2)
     &                  ,SNGL(SPECIF(IS+(NSOURCE/2+1)*(IOBSV-1)))
     &                  ,(SNGL(SPECIF(IS+NSOURCE*(IOBSV-1))),IS=nsource-1,NSOURCE)
     &                  ,SNGL(SPECTOTIF(IOBSV))
                    ENDDO   !IZ
                  ENDDO   !IY
                endif
                WRITE(LUNGFO,*)

              ELSE !(IPINALL.NE.0)

                WRITE(LUNGFO,*)
                WRITE(LUNGFO,*)
     &            '     Power density at selected point [W/m**2] with emittance:'
                WRITE(LUNGFO,*)
     &            '     (by integration over spectral range:',
     &            SNGL(FREQ(NFREQ0M)),SNGL(FREQ(NFREQ0P)),','
                if (nsource.le.5) then
                  WRITE(LUNGFO,*)
     &              '     for all sources and sum)'
                  WRITE(LUNGFO,*)
                  IOBSV=ICBRILL
                  WRITE(LUNGFO,*)'   '
     &              ,(SNGL(SPECIF(IS+NSOURCE*(IOBSV-1))),IS=1,NSOURCE)
     &              ,SNGL(SPECTOTIF(IOBSV))
                else
                  WRITE(LUNGFO,*)'     (for the first two, the central, and the last sources and sum)'
                  WRITE(LUNGFO,*)
     &              '     for all sources and sum)'
                  WRITE(LUNGFO,*)
                  IOBSV=ICBRILL
                  WRITE(LUNGFO,*)'   '
     &              ,(SNGL(SPECIF(IS+NSOURCE*(IOBSV-1))),IS=1,2)
     &              ,SNGL(SPECIF(IS+(NSOURCE/2+1)*(IOBSV-1)))
     &              ,(SNGL(SPECIF(IS+NSOURCE*(IOBSV-1))),IS=nsource-1,NSOURCE)
     &              ,SNGL(SPECTOTIF(IOBSV))
                endif
                WRITE(LUNGFO,*)

              ENDIF !IPINALL

            ENDIF !ISPECINT

          ENDIF !IFOLD

        endif !ipin3 and ifold

      ENDIF  !IPIN.ne.0

      IF (ISTOKES.NE.0) THEN

        IF (IPIN.EQ.0) THEN

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)

          WRITE(LUNGFO,*)
     &      '     Photon energy [eV] or wavelength [nm] for all observation'
          WRITE(LUNGFO,*)
     &      '     points, normalized components S0, S1/S0, S2/S0, S3/S0, P of'
          WRITE(LUNGFO,*)
     &      '     STOKES vector per unit area [m**2]:'
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)

          DO IO=1,NOBSV

            WRITE(LUNGFO,*)'          Observation point (x,y,z) [m]:'
            WRITE(LUNGFO,*)'          ',(SNGL(OBSV(IX,IO)),IX=1,3)
            WRITE(LUNGFO,*)

            DO IFR=1,NFREQ
              IOBFR=IO+NOBSV*(IFR-1)
              IF (STOKES(1,IOBFR).EQ.0.0) STOKES(1,IOBFR)=1.E-10
              S1=STOKES(1,IOBFR)
              S2=STOKES(2,IOBFR)
              S3=STOKES(3,IOBFR)
              S4=STOKES(4,IOBFR)
              POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1
              IF (STOKES(1,IOBFR).EQ.1.E-10) POL=0.0
              IF (IUNIT.EQ.0)
     &          WRITE(LUNGFO,2584)SNGL(FREQ(IFR)),STOKES(1,IOBFR)
     &          ,(STOKES(IS,IOBFR)/STOKES(1,IOBFR),IS=2,4),POL
              IF (IUNIT.NE.0)
     &          WRITE(LUNGFO,2584)SNGL(WELLEN(IFR))
     &          ,(STOKES(IS,IOBFR)/STOKES(1,IOBFR),IS=2,4),POL
            ENDDO !IFR

            IF (IFOLD.EQ.2) THEN

              WRITE(LUNGFO,*)
              WRITE(LUNGFO,*)

              WRITE(LUNGFO,*)
     &          '       Photon energy [eV] or wavelength [nm] for all observation'
              WRITE(LUNGFO,*)
     &          '       points, normalized components S0, S1/S0, S2/S0, S3/S0, P of'
              WRITE(LUNGFO,*)
     &          '       STOKES vector per unit area [m**2] with emittance:'
              WRITE(LUNGFO,*)
              WRITE(LUNGFO,*)

              DO IFR=1,NFREQ
                IOBFR=IO+NOBSV*(IFR-1)
                IF (STOKESF(1,IOBFR).EQ.0.0) STOKESF(1,IOBFR)=1.E-10
                S1=STOKESF(1,IOBFR)
                S2=STOKESF(2,IOBFR)
                S3=STOKESF(3,IOBFR)
                S4=STOKESF(4,IOBFR)
                POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1
                IF (STOKESF(1,IOBFR).EQ.1.E-10) POL=0.0
                IF (IUNIT.EQ.0)
     &            WRITE(LUNGFO,2584)SNGL(FREQ(IFR)),STOKESF(1,IOBFR)
     &            ,(STOKESF(IS,IOBFR)/STOKESF(1,IOBFR),IS=2,4),POL
                IF (IUNIT.NE.0)
     &            WRITE(LUNGFO,2584)SNGL(WELLEN(IFR))
     &            ,(STOKESF(IS,IOBFR)/STOKESF(1,IOBFR),IS=2,4),POL
              ENDDO !IFR
            ENDIF !IFOLD.EQ.2

          ENDDO !NOBSV

        ELSE   !IPIN

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '     Photon energy or wavelength and normalized components S0, S1/S0,'
          WRITE(LUNGFO,*)
     &      '     S2/S0, S3/S0 of STOKES vector and polarization for pinhole:'
          WRITE(LUNGFO,*)

          DO IFR=1,NFREQ

            IF (WSTOKES(1,IFR).EQ.0.0) WSTOKES(1,IFR)=1.E-10
            S1=WSTOKES(1,IFR)
            S2=WSTOKES(2,IFR)
            S3=WSTOKES(3,IFR)
            S4=WSTOKES(4,IFR)
            POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1
C         POL=SQRT(WSTOKES(2,IFR)**2+WSTOKES(3,IFR)**2+
C     &               WSTOKES(4,IFR)**2)/WSTOKES(1,IFR)

            IF (IUNIT.EQ.0)
     &        WRITE(LUNGFO,2584)SNGL(FREQ(IFR))
     &        ,WSTOKES(1,IFR)
     &        ,(WSTOKES(IS,IFR)/WSTOKES(1,IFR),IS=2,4),POL

            IF (IUNIT.NE.0)
     &        WRITE(LUNGFO,2584)SNGL(WELLEN(IFR))
     &        ,WSTOKES(1,IFR)
     &        ,(WSTOKES(IS,IFR)/WSTOKES(1,IFR),IS=2,4),POL
2584        FORMAT('     ',6(1PE12.4))

          ENDDO !IFR

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
          if (ipin.ne.3) then
            WRITE(LUNGFO,*)
     &        '     Photon energy [eV] or wavelength [nm] for selected point'
            WRITE(LUNGFO,*)'     of pinhole, S0, S1/S0, S2/S0, S3/S0, P of'
            WRITE(LUNGFO,*)
     &        '     STOKES vector per unit area [m**2]:'
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
            IO=ICBRILL
            WRITE(LUNGFO,*)'          Observation point (x,y,z) [m]:'
            WRITE(LUNGFO,*)'          ',(SNGL(OBSV(IX,IO)),IX=1,3)
            WRITE(LUNGFO,*)
          else
            WRITE(LUNGFO,*)
     &        '     Photon energy [eV] or wavelength [nm]'
            WRITE(LUNGFO,*)'     , mean densities of S0, S1/S0, S2/S0, S3/S0, P of'
            WRITE(LUNGFO,*)
     &        '     STOKES vector per unit area [m**2]:'
          endif

          DO IFR=1,NFREQ
            IF (STOKEC(1,IFR).EQ.0.0) STOKEC(1,IFR)=1.E-10
            S1=STOKEC(1,IFR)
            S2=STOKEC(2,IFR)
            S3=STOKEC(3,IFR)
            S4=STOKEC(4,IFR)
            POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1
C         POL=
C     &                   SQRT(
C     &          (STOKEC(2,IFR)**2
C     &          +STOKEC(3,IFR)**2
C     &          +STOKEC(4,IFR)**2))
C     &          /STOKEC(1,IFR)
            IF (STOKEC(1,IFR).EQ.1.E-10) POL=0.0
            IF (IUNIT.EQ.0)
     &        WRITE(LUNGFO,2584)SNGL(FREQ(IFR))
     &        ,STOKEC(1,IFR),(STOKEC(IS,IFR)/STOKEC(1,IFR),IS=2,4),POL
            IF (IUNIT.NE.0)
     &        WRITE(LUNGFO,2584)SNGL(WELLEN(IFR))
     &        ,STOKEC(1,IFR),(STOKEC(IS,IFR)/STOKEC(1,IFR),IS=2,4),POL
          ENDDO !IFR

          IF (IFOLD.NE.0.and.ipin.ne.3)   THEN

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
     &        '     Energy, S0, S1/S0, S2/S0, S3/S0 and P for pinhole with emittance:'
            WRITE(LUNGFO,*)

            DO IFR=1,NFREQ

              IF (WSTOKESF(1,IFR).EQ.0.0) WSTOKESF(1,IFR)=1.E-10

              S1=WSTOKESF(1,IFR)
              S2=WSTOKESF(2,IFR)
              S3=WSTOKESF(3,IFR)
              S4=WSTOKESF(4,IFR)
              POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1
C         POL=SQRT(WSTOKESF(2,IFR)**2+WSTOKESF(3,IFR)**2+
C     &               WSTOKESF(4,IFR)**2)/WSTOKESF(1,IFR)

              IF (IUNIT.EQ.0)
     &          WRITE(LUNGFO,2584)SNGL(FREQ(IFR))
     &          ,WSTOKESF(1,IFR)
     &          ,(WSTOKESF(IS,IFR)/WSTOKESF(1,IFR),IS=2,4),POL

              IF (IUNIT.NE.0)
     &          WRITE(LUNGFO,2584)SNGL(WELLEN(IFR))
     &          ,WSTOKESF(1,IFR)
     &          ,(WSTOKESF(IS,IFR)/WSTOKESF(1,IFR),IS=2,4),POL

            ENDDO !IFR
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
     &        '     Photon energy [eV] or wavelength [nm] for selected point'
            WRITE(LUNGFO,*)
     &        '     of pinhole, S0, S1/S0, S2/S0, S3/S0, P of with emittance'
            WRITE(LUNGFO,*)
     &        '     STOKES vector per unit area [m**2]:'
            WRITE(LUNGFO,*)

            DO IFR=1,NFREQ
              IF (STOKECF(1,IFR).EQ.0.0) STOKECF(1,IFR)=1.E-10
              S1=STOKECF(1,IFR)
              S2=STOKECF(2,IFR)
              S3=STOKECF(3,IFR)
              S4=STOKECF(4,IFR)
              POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1
C         POL=
C     &                   SQRT(
C     &          (STOKECF(2,IFR)**2
C     &          +STOKECF(3,IFR)**2
C     &          +STOKECF(4,IFR)**2))
C     &          /STOKECF(1,IFR)
              IF (STOKECF(1,IFR).EQ.1.E-10) POL=0.0
              IF (IUNIT.EQ.0)
     &          WRITE(LUNGFO,2584)SNGL(FREQ(IFR))
     &          ,STOKECF(1,IFR),(STOKECF(IS,IFR)/STOKECF(1,IFR),
     &          IS=2,4),POL
              IF (IUNIT.NE.0)
     &          WRITE(LUNGFO,2584)SNGL(WELLEN(IFR))
     &          ,STOKECF(1,IFR),
     &          (STOKECF(IS,IFR)/STOKECF(1,IFR),IS=2,4),POL
            ENDDO !IFR

          ENDIF !IFOLD

        ENDIF  !IPIN


      ENDIF !ISTOKES

      IF (IW_BLENF.NE.0) ISPECSUM=1

C--- USE SIMPLE SUMMATION TO EVALUATE FLUX THROUGH PINHOLE (TEST PURPOSES)

      IF (IPIN.NE.0..AND.IPIN.NE.2.and.ipin.ne.3.AND.ISPECSUM.NE.0) THEN

          IF (ISTOKES.NE.0) THEN
               CALL STOKSUM
          ELSE
               CALL SPECSUM
          ENDIF   !ISTOKES

          IF (IFOLD.NE.0.AND.IFOLD.NE.2) THEN

         IF (ISTOKES.NE.0) THEN
             CALL STOKSUMF
         ELSE
             CALL SPECSUMF
         ENDIF !ISTOKES

          ENDIF   !IFOLD

      ENDIF !IPIN AND ISPECSUM

C--- WRITE FLUX THROUGH PINHOLE TO FILE

      IF(IWFILFL0.NE.0) THEN

         OPEN(UNIT=LUNFL0,FILE=FILEFL0,STATUS='NEW')

         WRITE(LUNFL0,*)ICODE,' ',CODE
         WRITE(LUNFL0,*)NFREQ,NSOURCE

         DO IFR=1,NFREQ
            IF (IUNIT.EQ.0)
     &         WRITE(LUNFL0,*)SNGL(FREQ(IFR))
     &                        ,(SNGL(WFLUX(IS+NSOURCE*(IFR-1))),IS=1,NSOURCE)
     &                           ,SNGL(WFLUXT(IFR))
            IF (IUNIT.NE.0)
     &         WRITE(LUNFL0,*)SNGL(WELLEN(IFR))
     &                        ,(SNGL(WFLUX(IS+NSOURCE*(IFR-1))),IS=1,NSOURCE)
     &                           ,SNGL(WFLUXT(IFR))
         ENDDO

         CLOSE(LUNFL0)
      ENDIF !IWFILFL0

      IF(ipin.ne.3.and.IFOLD.NE.0.AND.IWFILFLF.NE.0) THEN

         OPEN(UNIT=LUNFLF,FILE=FILEFLF)

         WRITE(LUNFLF,*)ICODE,' ',CODE
         WRITE(LUNFLF,*)NFREQ,NSOURCE

         DO IFR=1,NFREQ
            IF (IUNIT.EQ.0)
     &         WRITE(LUNFLF,*)SNGL(FREQ(IFR))
     &        ,(SNGL(WFLUXF(IS+NSOURCE*(IFR-1))),IS=1,NSOURCE)
     &        ,SNGL(WFLUXTF(IFR))
            IF (IUNIT.NE.0)
     &         WRITE(LUNFLF,*)SNGL(WELLEN(IFR))
     &        ,(SNGL(WFLUXF(IS+NSOURCE*(IFR-1))),IS=1,NSOURCE)
     &        ,SNGL(WFLUXTF(IFR))
         ENDDO

         CLOSE(LUNFLF)
      ENDIF !IWFILFLF

      IF (IPIN.NE.0) THEN

        STOKESMAX=0.0

        IF (ISTOKES.NE.0) THEN

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '      Total absolute maxima found for Stokes-V. (z,y,Eph,fluxdens.)'
          WRITE(LUNGFO,*)

          DO ISTOK=1,4

            DO IY=(NOBSVY-MOBSVY)/2+1,(NOBSVY-MOBSVY)/2+MOBSVY
              DO IZ=(NOBSVZ-MOBSVZ)/2+1,(NOBSVZ-MOBSVZ)/2+MOBSVZ
                IO=(IY-1)*NOBSVZ+IZ
                DO IFR=1,NFREQ
                  IF (ABS(STOKES(ISTOK,IO+NOBSV*(IFR-1))).GT.
     &                STOKESMAX(4,ISTOK)) THEN
                    STOKESMAX(1,ISTOK)=OBSV(2,IO)
                    STOKESMAX(2,ISTOK)=OBSV(3,IO)
                    STOKESMAX(3,ISTOK)=FREQ(IFR)
                    STOKESMAX(4,ISTOK)=STOKES(ISTOK,IO+NOBSV*(IFR-1))
                  ENDIF
                ENDDO   !IFR
              ENDDO  !IZ
            ENDDO !IY

            WRITE(LUNGFO,'(6X,4((1PE12.4)))')STOKESMAX(1:4,ISTOK)

          ENDDO !ISTOK

        ELSE !(ISTOKES.NE.0)

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '      Total absolute maxima found for flux-density (z,y,Eph,fluxdens.)'
          WRITE(LUNGFO,*)

          DO IY=(NOBSVY-MOBSVY)/2+1,(NOBSVY-MOBSVY)/2+MOBSVY
            DO IZ=(NOBSVZ-MOBSVZ)/2+1,(NOBSVZ-MOBSVZ)/2+MOBSVZ
              IO=(IY-1)*NOBSVZ+IZ
              DO IFR=1,NFREQ
                IF (SPECTOT(IO+NOBSV*(IFR-1)).GT.STOKESMAX(4,1)) THEN
                  STOKESMAX(1,1)=OBSV(2,IO)
                  STOKESMAX(2,1)=OBSV(3,IO)
                  STOKESMAX(3,1)=FREQ(IFR)
                  STOKESMAX(4,1)=SPECTOT(IO+NOBSV*(IFR-1))
                ENDIF
              ENDDO  !IFR
            ENDDO !IZ
          ENDDO   !IY

          WRITE(LUNGFO,'(6X,4((1PE12.4)))')STOKESMAX(1:4,1)

        ENDIF !(ISTOKES.NE.0)

        STOKESMAXF=0.0

        IF (IFOLD.NE.0.and.ipin.ne.3) THEN

          IF (ISTOKES.NE.0) THEN

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
     &        '      Total absolute maxima found for Stokes-V. with emittance'
            WRITE(LUNGFO,*)
     &        '      (z,y,Eph,fluxdens.)'
            WRITE(LUNGFO,*)

            DO ISTOK=1,4

              DO IY=(NOBSVY-MOBSVY)/2+1,(NOBSVY-MOBSVY)/2+MOBSVY
                DO IZ=(NOBSVZ-MOBSVZ)/2+1,(NOBSVZ-MOBSVZ)/2+MOBSVZ
                  IO=(IY-1)*NOBSVZ+IZ
                  DO IFR=1,NFREQ
                    IF (ABS(STOKESF(ISTOK,IO+NOBSV*(IFR-1))).GT.
     &                  STOKESMAXF(4,ISTOK)) THEN
                      STOKESMAXF(1,ISTOK)=OBSV(2,IO)
                      STOKESMAXF(2,ISTOK)=OBSV(3,IO)
                      STOKESMAXF(3,ISTOK)=FREQ(IFR)
                      STOKESMAXF(4,ISTOK)=STOKESF(ISTOK,IO+NOBSV*(IFR-1))
                    ENDIF
                  ENDDO !IFR
                ENDDO   !IZ
              ENDDO  !IY

              WRITE(LUNGFO,'(6X,4((1PE12.4)))')STOKESMAXF(1:4,ISTOK)

            ENDDO !ISTOK

          ELSE !(ISTOKES.NE.0)

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
     &        '      Total absolute maxima found for flux-dens. with emit. (z,y,Eph,fluxd.)'
            WRITE(LUNGFO,*)

            DO IY=(NOBSVY-MOBSVY)/2+1,(NOBSVY-MOBSVY)/2+MOBSVY
              DO IZ=(NOBSVZ-MOBSVZ)/2+1,(NOBSVZ-MOBSVZ)/2+MOBSVZ
                IO=(IY-1)*NOBSVZ+IZ
                DO IFR=1,NFREQ
                  IF (SPECTOTF(IO+NOBSV*(IFR-1)).GT.STOKESMAXF(4,1)) THEN
                    STOKESMAXF(1,1)=OBSV(2,IO)
                    STOKESMAXF(2,1)=OBSV(3,IO)
                    STOKESMAXF(3,1)=FREQ(IFR)
                    STOKESMAXF(4,1)=SPECTOTF(IO+NOBSV*(IFR-1))
                  ENDIF
                ENDDO   !IFR
              ENDDO  !IZ
            ENDDO !IY

            WRITE(LUNGFO,'(XXXXXX,4((1PE12.4)))')STOKESMAXF(1:4,1)

          ENDIF !(ISTOKES.NE.0)

        ENDIF !IFOLD

      ENDIF !IPIN

      IF(IEFOLD.NE.0) THEN

        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)

        IF (ipin.ne.3.and.IEFOLD.NE.0) THEN
          CALL EFOLD
        ELSE IF (ipin.eq.3) THEN
          WRITE(LUNGFO,*)
     &      '     Beam energy spread (ESPREAD) for energy folding:'
          WRITE(LUNGFO,*)'     ',SNGL(ESPREAD)
        ELSE IF (IEFOLD.lt.0) THEN
          WRITE(LUNGFO,*)
     &      '     Beam energy spread (ESPREAD) and number of sigmas'
          WRITE(LUNGFO,*)
     &      '     for energy folding:'
          WRITE(LUNGFO,*)'     ',SNGL(ESPREAD),NSIGE
          WRITE(LUNGFO,*)
        ENDIF

        IF (IPIN.EQ.0) THEN

          IF (NOBSV.GT.1) THEN
            WRITE(LUNGFO,*)
     &        '       Photon energy [eV] or wavelength [nm] for first observation'
            IO=1
          ELSE
            WRITE(LUNGFO,*)
     &        '       Photon energy [eV] or wavelength [nm] for selected observation'
            IO=ICBRILL
          ENDIF

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '     point, normalized components S0, S1/S0, S2/S0, S3/S0, P of'
          WRITE(LUNGFO,*)
     &      '     STOKES vector per unit area [m**2] (e-folded):'
          WRITE(LUNGFO,*)

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'          Observation point (x,y,z) [m]:'
          WRITE(LUNGFO,*)'          ',(SNGL(OBSV(IX,IO)),IX=1,3)
          WRITE(LUNGFO,*)

          DO IFR=1,NFREQ
            IF (WSTOKESE(1,IFR).EQ.0.0) WSTOKESE(1,IFR)=1.E-10
            S1=WSTOKESE(1,IFR)
            S2=WSTOKESE(2,IFR)
            S3=WSTOKESE(3,IFR)
            S4=WSTOKESE(4,IFR)
            POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1
            IF (WSTOKESE(1,IFR).EQ.1.E-10) POL=0.0
            IF (IUNIT.EQ.0)
     &        WRITE(LUNGFO,2584)SNGL(FREQ(IFR)),WSTOKESE(1,IFR)
     &        ,(WSTOKESE(IS,IFR)/WSTOKESE(1,IFR),IS=2,4),POL
            IF (IUNIT.NE.0)
     &        WRITE(LUNGFO,2584)SNGL(WELLEN(IFR)),WSTOKESE(1,IFR)
     &        ,(WSTOKESE(IS,IFR)/WSTOKESE(1,IFR),IS=2,4),POL
          ENDDO !IFR

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
          IF (IFOLD.EQ.2) THEN
            IF (NOBSV.GT.1) THEN
              WRITE(LUNGFO,*)
     &          '       Photon energy [eV] or wavelength [nm] for first observation'
              IO=1
            ELSE
              WRITE(LUNGFO,*)
     &          '       Photon energy [eV] or wavelength [nm] for selected observation'
              IO=ICBRILL
            ENDIF

            WRITE(LUNGFO,*)
     &        '     point, normalized components S0, S1/S0, S2/S0, S3/S0, P of'
            WRITE(LUNGFO,*)
     &        '     STOKES vector per unit area [m**2] with emittance (e-folded):'
            WRITE(LUNGFO,*)

            DO IFR=1,NFREQ
              IF (WSTOKESEF(1,IFR).EQ.0.0) WSTOKESEF(1,IFR)=1.E-10
              S1=WSTOKESEF(1,IFR)
              S2=WSTOKESEF(2,IFR)
              S3=WSTOKESEF(3,IFR)
              S4=WSTOKESEF(4,IFR)
              POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1
              IF (WSTOKESEF(1,IFR).EQ.1.E-10) POL=0.0
              IF (IUNIT.EQ.0)
     &          WRITE(LUNGFO,2584)SNGL(FREQ(IFR)),WSTOKESEF(1,IFR)
     &          ,(WSTOKESEF(IS,IFR)/WSTOKESEF(1,IFR),IS=2,4),POL
              IF (IUNIT.NE.0)
     &          WRITE(LUNGFO,2584)SNGL(WELLEN(IFR)),WSTOKESEF(1,IFR)
     &          ,(WSTOKESEF(IS,IFR)/WSTOKESEF(1,IFR),IS=2,4),POL
            ENDDO !IFR
          ENDIF !IFOLD.EQ.2

        ELSE   !IPIN

          IF(IWFLSTOE.NE.0.AND.IEFOLD.NE.0) THEN

            OPEN(UNIT=LUNSTO,FILE=FILESTOE)

            WRITE(LUNSTO,*)ICODE,' ',CODE
            WRITE(LUNSTO,*)
            WRITE(LUNSTO,*)NSOURCE,NOBSV,NFREQ,IFREQ2P
            WRITE(LUNSTO,*)NOBSVZ,NOBSVY,MOBSVZ,MOBSVY
            WRITE(LUNSTO,*)MEDGEZ,MEDGEY,MMEDGEZ,MMEDGEY
            WRITE(LUNSTO,*)
            WRITE(LUNSTO,*)PINW,PINH,PINR
            WRITE(LUNSTO,*)OBSVDZ,OBSVDY
            WRITE(LUNSTO,*)

            WRITE(LUNSTO,*)(OBSVZ(IO),IO=1,NOBSVZ)
            WRITE(LUNSTO,*)
            WRITE(LUNSTO,*)(OBSVY(IO),IO=1,NOBSVY)
            WRITE(LUNSTO,*)

            DO IO=1,NOBSV
              WRITE(LUNSTO,*)(OBSV(IX,IO),IX=1,3)
              DO IFR=1,NFREQ
                IF (IUNIT.EQ.0) THEN !260194
                  IOBFR=IO+NOBSV*(IFR-1)
                  WRITE(LUNSTO,*)FREQ(IFR),(STOKESE(IS,IOBFR),IS=1,4)
                ELSE
                  WRITE(LUNSTO,*)WELLEN(IFR),(STOKESE(IS,IOBFR),IS=1,4)
                ENDIF
              ENDDO !NFREQ
            ENDDO !NOBSV

            CLOSE(LUNSTO)

          ENDIF !IWFLSTOE

          IF(IWFLSTOEF.NE.0.AND.IEFOLD.NE.0.AND.IFOLD.NE.0) THEN

            OPEN(UNIT=LUNSTO,FILE=FILESTOEF)

            WRITE(LUNSTO,*)ICODE,' ',CODE
            WRITE(LUNSTO,*)
            WRITE(LUNSTO,*)NSOURCE,NOBSV,NFREQ,IFREQ2P
            WRITE(LUNSTO,*)NOBSVZ,NOBSVY,MOBSVZ,MOBSVY
            WRITE(LUNSTO,*)MEDGEZ,MEDGEY,MMEDGEZ,MMEDGEY
            WRITE(LUNSTO,*)
            WRITE(LUNSTO,*)PINW,PINH,PINR
            WRITE(LUNSTO,*)OBSVDZ,OBSVDY
            WRITE(LUNSTO,*)

            WRITE(LUNSTO,*)(OBSVZ(IO),IO=1,NOBSVZ)
            WRITE(LUNSTO,*)
            WRITE(LUNSTO,*)(OBSVY(IO),IO=1,NOBSVY)
            WRITE(LUNSTO,*)

            DO IO=1,NOBSV
              WRITE(LUNSTO,*)(OBSV(IX,IO),IX=1,3)
              DO IFR=1,NFREQ
                IF (IUNIT.EQ.0) THEN !260194
                  IOBFR=IO+NOBSV*(IFR-1)
                  WRITE(LUNSTO,*)FREQ(IFR),(STOKESEF(IS,IOBFR),IS=1,4)
                ELSE
                  WRITE(LUNSTO,*)WELLEN(IFR),(STOKESEF(IS,IOBFR),IS=1,4)
                ENDIF
              ENDDO !NFREQ
            ENDDO !NOBSV

            CLOSE(LUNSTO)

          ENDIF !IWFLSTOEF

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '     Photon energy or wavelength and normalized components S0, S1/S0,'
          WRITE(LUNGFO,*)
     &      '     S2/S0, S3/S0 of STOKES vector and polarization for pinhole'
          WRITE(LUNGFO,*)
     &      '     (e-folded):'
          WRITE(LUNGFO,*)

          DO IFR=1,NFREQ

            IF (WSTOKESE(1,IFR).EQ.0.0) WSTOKESE(1,IFR)=1.E-10

            S1=WSTOKESE(1,IFR)
            S2=WSTOKESE(2,IFR)
            S3=WSTOKESE(3,IFR)
            S4=WSTOKESE(4,IFR)
            POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1

            IF (IUNIT.EQ.0)
     &        WRITE(LUNGFO,2584)SNGL(FREQ(IFR))
     &        ,WSTOKESE(1,IFR)
     &        ,(WSTOKESE(IS,IFR)/WSTOKESE(1,IFR),IS=2,4),POL

            IF (IUNIT.NE.0)
     &        WRITE(LUNGFO,2584)SNGL(WELLEN(IFR))
     &        ,WSTOKESE(1,IFR)
     &        ,(WSTOKESE(IS,IFR)/WSTOKESE(1,IFR),IS=2,4),POL

          ENDDO !IFR

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '     Photon energy or wavelength and normalized components S0, S1/S0,'
          WRITE(LUNGFO,*)
     &      '     S2/S0, S3/S0 of STOKES vector and polarization for selected point of'
          WRITE(LUNGFO,*)
     &      '     pinhole (e-folded):'
          WRITE(LUNGFO,*)

          DO IFR=1,NFREQ

            IF (STOKECE(1,IFR).EQ.0.0) STOKECE(1,IFR)=1.E-10

            S1=STOKECE(1,IFR)
            S2=STOKECE(2,IFR)
            S3=STOKECE(3,IFR)
            S4=STOKECE(4,IFR)
            POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1

            IF (IUNIT.EQ.0)
     &        WRITE(LUNGFO,2584)SNGL(FREQ(IFR))
     &        ,STOKECE(1,IFR)
     &        ,(STOKECE(IS,IFR)/STOKECE(1,IFR),IS=2,4),POL

            IF (IUNIT.NE.0)
     &        WRITE(LUNGFO,2584)SNGL(WELLEN(IFR))
     &        ,STOKECE(1,IFR)
     &        ,(STOKECE(IS,IFR)/STOKECE(1,IFR),IS=2,4),POL

          ENDDO !IFR

          STOKESMAXE=0.0

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '      Total absolute maxima found for Stokes-V. with'
          WRITE(LUNGFO,*)
     &      '      e-spread (z,y,Eph,fluxdens.)'
          WRITE(LUNGFO,*)

          DO ISTOK=1,4

            DO IY=(NOBSVY-MOBSVY)/2+1,(NOBSVY-MOBSVY)/2+MOBSVY
              DO IZ=(NOBSVZ-MOBSVZ)/2+1,(NOBSVZ-MOBSVZ)/2+MOBSVZ
                IO=(IY-1)*NOBSVZ+IZ
                DO IFR=1,NFREQ
                  IF (ABS(STOKESE(ISTOK,IO+NOBSV*(IFR-1))).GT.
     &                STOKESMAXE(4,ISTOK)) THEN
                    STOKESMAXE(1,ISTOK)=OBSV(2,IO)
                    STOKESMAXE(2,ISTOK)=OBSV(3,IO)
                    STOKESMAXE(3,ISTOK)=FREQ(IFR)
                    STOKESMAXE(4,ISTOK)=STOKESE(ISTOK,IO+NOBSV*(IFR-1))
                  ENDIF
                ENDDO   !IFR
              ENDDO  !IZ
            ENDDO !IY

            WRITE(LUNGFO,'(6X,4((1PE12.4)))')STOKESMAXE(1:4,ISTOK)

          ENDDO !ISTOK

          IF (IFOLD.NE.0.and.ipin.ne.3)   THEN

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
     &        '     Energy, S0, S1/S0, S2/S0, S3/S0 and P for pinhole with emittance'
            WRITE(LUNGFO,*)
     &        '     (e-folded):'
            WRITE(LUNGFO,*)

            DO IFR=1,NFREQ

              IF (WSTOKESEF(1,IFR).EQ.0.0) WSTOKESEF(1,IFR)=1.E-10

              S1=WSTOKESEF(1,IFR)
              S2=WSTOKESEF(2,IFR)
              S3=WSTOKESEF(3,IFR)
              S4=WSTOKESEF(4,IFR)
              POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1

              IF (IUNIT.EQ.0)
     &          WRITE(LUNGFO,2584)SNGL(FREQ(IFR))
     &          ,WSTOKESEF(1,IFR)
     &          ,(WSTOKESEF(IS,IFR)/WSTOKESEF(1,IFR),IS=2,4),POL

              IF (IUNIT.NE.0)
     &          WRITE(LUNGFO,2584)SNGL(WELLEN(IFR))
     &          ,WSTOKESEF(1,IFR)
     &          ,(WSTOKESEF(IS,IFR)/WSTOKESEF(1,IFR),IS=2,4),POL

            ENDDO !IFR

            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)
     &        '     Energy, S0, S1/S0, S2/S0, S3/S0 and P for selected point of pinhole'
            WRITE(LUNGFO,*)
     &        '     with emittance (e-folded):'
            WRITE(LUNGFO,*)

            DO IFR=1,NFREQ

              IF (STOKECEF(1,IFR).EQ.0.0) STOKECEF(1,IFR)=1.E-10

              S1=STOKECEF(1,IFR)
              S2=STOKECEF(2,IFR)
              S3=STOKECEF(3,IFR)
              S4=STOKECEF(4,IFR)
              POL=DSQRT(S2*S2+S3*S3+S4*S4)/S1

              IF (IUNIT.EQ.0)
     &          WRITE(LUNGFO,2584)SNGL(FREQ(IFR))
     &          ,STOKECEF(1,IFR)
     &          ,(STOKECEF(IS,IFR)/STOKECEF(1,IFR),IS=2,4),POL

              IF (IUNIT.NE.0)
     &          WRITE(LUNGFO,2584)SNGL(WELLEN(IFR))
     &          ,STOKECEF(1,IFR)
     &          ,(STOKECEF(IS,IFR)/STOKECEF(1,IFR),IS=2,4),POL

            ENDDO !IFR

          ENDIF !IFOLD

        ENDIF  !IPIN

        STOKESMAXEF=0.0

        IF (ipin.ne.3.and.IFOLD.NE.0) THEN

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)
     &      '      Total absolute maxima found for Stokes-V. with'
          WRITE(LUNGFO,*)
     &      '      emit. and e-spread (z,y,Eph,fluxdens.)'
          WRITE(LUNGFO,*)

          DO ISTOK=1,4

            DO IY=(NOBSVY-MOBSVY)/2+1,(NOBSVY-MOBSVY)/2+MOBSVY
              DO IZ=(NOBSVZ-MOBSVZ)/2+1,(NOBSVZ-MOBSVZ)/2+MOBSVZ
                IO=(IY-1)*NOBSVZ+IZ
                DO IFR=1,NFREQ
                  IF (ABS(STOKESEF(ISTOK,IO+NOBSV*(IFR-1))).GT.
     &                STOKESMAXEF(4,ISTOK)) THEN
                    STOKESMAXEF(1,ISTOK)=OBSV(2,IO)
                    STOKESMAXEF(2,ISTOK)=OBSV(3,IO)
                    STOKESMAXEF(3,ISTOK)=FREQ(IFR)
                    STOKESMAXEF(4,ISTOK)=STOKESEF(ISTOK,IO+NOBSV*(IFR-1))
                  ENDIF
                ENDDO   !IFR
              ENDDO  !IZ
            ENDDO !IY

            WRITE(LUNGFO,'(6X,4((1PE12.4)))')STOKESMAXEF(1:4,ISTOK)

          ENDDO !ISTOK

        ENDIF !IFOLD

      ENDIF !IEFOLD

      IF(IWFILS.NE.0.AND.ISTOKES.NE.0) THEN

        OPEN(UNIT=LUNS,FILE=FILES)

        WRITE(LUNS,*)ICODE,' ',CODE
        WRITE(LUNS,*)NFREQ

        DO IFR=1,NFREQ
          IF (IUNIT.EQ.0)
     &      WRITE(LUNS,*)SNGL(FREQ(IFR))
     &      ,((WSTOKES(IS,IFR)),IS=1,4)
          IF (IUNIT.NE.0)
     &      WRITE(LUNS,*)SNGL(WELLEN(IFR))
     &      ,((WSTOKES(IS,IFR)),IS=1,4)
        ENDDO

        CLOSE(LUNS)
      ENDIF !IWFILS

      IF(IFOLD.NE.0.AND.IWFILSF.NE.0.AND.ISTOKES.NE.0) THEN

        OPEN(UNIT=LUNSF,FILE=FILESF)

        WRITE(LUNSF,*)ICODE,' ',CODE
        WRITE(LUNSF,*)NFREQ

        DO IFR=1,NFREQ
          IF (IUNIT.EQ.0)
     &      WRITE(LUNSF,*)SNGL(FREQ(IFR))
     &      ,((WSTOKESF(IS,IFR)),IS=1,4)
          IF (IUNIT.NE.0)
     &      WRITE(LUNSF,*)SNGL(WELLEN(IFR))
     &      ,((WSTOKESF(IS,IFR)),IS=1,4)
        ENDDO

        CLOSE(LUNSF)
      ENDIF !IWFILSF

      IF(IEFOLD.NE.0.AND.IWFILSE.NE.0.AND.ISTOKES.NE.0) THEN

        OPEN(UNIT=LUNSE,FILE=FILESE)

        WRITE(LUNSE,*)ICODE,' ',CODE
        WRITE(LUNSE,*)NFREQ

        DO IFR=1,NFREQ
          IF (IUNIT.EQ.0)
     &      WRITE(LUNSE,*)SNGL(FREQ(IFR))
     &      ,((WSTOKESE(IS,IFR)),IS=1,4)
          IF (IUNIT.NE.0)
     &      WRITE(LUNSE,*)SNGL(WELLEN(IFR))
     &      ,((WSTOKESE(IS,IFR)),IS=1,4)
        ENDDO

        CLOSE(LUNSE)
      ENDIF !IWFILSE

      IF(IEFOLD.NE.0.AND.IFOLD.NE.0.AND.IWFILSEF.NE.0.AND.ISTOKES.NE.0) THEN

        OPEN(UNIT=LUNSEF,FILE=FILESEF)

        WRITE(LUNSEF,*)ICODE,' ',CODE
        WRITE(LUNSEF,*)NFREQ

        DO IFR=1,NFREQ
          IF (IUNIT.EQ.0)
     &      WRITE(LUNSEF,*)SNGL(FREQ(IFR))
     &      ,((WSTOKESEF(IS,IFR)),IS=1,4)
          IF (IUNIT.NE.0)
     &      WRITE(LUNSEF,*)SNGL(WELLEN(IFR))
     &      ,((WSTOKESEF(IS,IFR)),IS=1,4)
        ENDDO

        CLOSE(LUNSEF)
      ENDIF !IWFILSEF

      IF(IWFILB.NE.0.AND.ISTOKES.NE.0) THEN

        OPEN(UNIT=LUNC,FILE=FILEC)

        WRITE(LUNC,*)ICODE,' ',CODE
        WRITE(LUNC,*)nintFREQ

        DO IFR=1,NFREQ
           if (freq(ifr).ge.freqlow-(freq(2)-freq(1))/2.0d0
     &         .and.freq(ifr).le.freqhig+(freq(2)-freq(1))/2.0d0) then
          IF (IUNIT.EQ.0)
     &      WRITE(LUNC,*)SNGL(FREQ(IFR))
     &      ,((STOKEC(IS,IFR)),IS=1,4)
          IF (IUNIT.NE.0)
     &      WRITE(LUNC,*)SNGL(WELLEN(IFR))
     &      ,((STOKEC(IS,IFR)),IS=1,4)
          endif
        ENDDO

        CLOSE(LUNC)
      ENDIF !IWFILB

      IF(IFOLD.NE.0.AND.IWFILBF.NE.0.AND.ISTOKES.NE.0) THEN

        OPEN(UNIT=LUNCF,FILE=FILECF)

        WRITE(LUNCF,*)ICODE,' ',CODE
        WRITE(LUNCF,*)NintFREQ

        DO IFR=1,NFREQ
           if (freq(ifr).ge.freqlow-(freq(2)-freq(1))/2.0d0
     &         .and.freq(ifr).le.freqhig+(freq(2)-freq(1))/2.0d0) then
          IF (IUNIT.EQ.0)
     &      WRITE(LUNCF,*)SNGL(FREQ(IFR))
     &      ,((STOKECF(IS,IFR)),IS=1,4)
          IF (IUNIT.NE.0)
     &      WRITE(LUNCF,*)SNGL(WELLEN(IFR))
     &      ,((STOKECF(IS,IFR)),IS=1,4)
          endif
        ENDDO

        CLOSE(LUNCF)
      ENDIF !IWFILBF

      IF(IEFOLD.NE.0.AND.IWFILBE.NE.0.AND.ISTOKES.NE.0) THEN

         OPEN(UNIT=LUNCE,FILE=FILECE)

         WRITE(LUNCE,*)ICODE,' ',CODE
         WRITE(LUNCE,*)nintFREQ

         DO IFR=1,NFREQ
           if (freq(ifr).ge.freqlow-(freq(2)-freq(1))/2.0d0
     &         .and.freq(ifr).le.freqhig+(freq(2)-freq(1))/2.0d0) then
           IF (IUNIT.EQ.0)
     &       WRITE(LUNCE,*)SNGL(FREQ(IFR))
     &       ,((STOKECE(IS,IFR)),IS=1,4)
           IF (IUNIT.NE.0)
     &       WRITE(LUNCE,*)SNGL(WELLEN(IFR))
     &       ,((STOKECE(IS,IFR)),IS=1,4)
           endif
         ENDDO

         CLOSE(LUNCE)
       ENDIF !IWFILBE

       IF(IEFOLD.NE.0.AND.IFOLD.NE.0.AND.IWFILBEF.NE.0.AND.ISTOKES.NE.0) THEN

         OPEN(UNIT=LUNCEF,FILE=FILECEF)

         WRITE(LUNCEF,*)ICODE,' ',CODE
         WRITE(LUNCEF,*)NintFREQ

         DO IFR=1,NFREQ
           if (freq(ifr).ge.freqlow-(freq(2)-freq(1))/2.0d0
     &         .and.freq(ifr).le.freqhig+(freq(2)-freq(1))/2.0d0) then
           IF (IUNIT.EQ.0)
     &       WRITE(LUNCEF,*)SNGL(FREQ(IFR))
     &       ,((STOKECEF(IS,IFR)),IS=1,4)
           IF (IUNIT.NE.0)
     &       WRITE(LUNCEF,*)SNGL(WELLEN(IFR))
     &       ,((STOKECEF(IS,IFR)),IS=1,4)
           endif
         ENDDO

         CLOSE(LUNCEF)
       ENDIF !IWFILBEF

       IF (ISTOKES.NE.0) THEN

         DO ISTO=1,4

           DO IFREQ=1,NFREQ
             SPECBUFF(IFREQ)=ABS(STOKEC(ISTO,IFREQ))
           ENDDO  !IFR
           CALL UTIL_MAX_PARABEL
     &       (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
           STOKCMX(ISTO,1)=DUM1
           STOKCMX(ISTO,2)=DUM2

           IF (IFAIL.NE.0) THEN
             WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S',ISTO
             WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
           ENDIF

           IF (IFOLD.NE.0) THEN
             DO IFREQ=1,NFREQ
               SPECBUFF(IFREQ)=ABS(STOKECF(ISTO,IFREQ))
             ENDDO   !IFR
             CALL UTIL_MAX_PARABEL
     &         (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
             STOKCMXF(ISTO,1)=DUM1
             STOKCMXF(ISTO,2)=DUM2
             IF (IFAIL.NE.0) THEN
               WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S',ISTO
               WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
             ENDIF
           ENDIF

           IF (IEFOLD.NE.0) THEN
             DO IFREQ=1,NFREQ
               SPECBUFF(IFREQ)=ABS(STOKECE(ISTO,IFREQ))
             ENDDO   !IFR
             CALL UTIL_MAX_PARABEL
     &         (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
             STOKCMXE(ISTO,1)=DUM1
             STOKCMXE(ISTO,2)=DUM2
             IF (IFAIL.NE.0) THEN
               WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S',ISTO
               WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
             ENDIF
           ENDIF

           IF (IFOLD.NE.0.AND.IEFOLD.NE.0) THEN
             DO IFREQ=1,NFREQ
               SPECBUFF(IFREQ)=ABS(STOKECEF(ISTO,IFREQ))
             ENDDO   !IFR
             CALL UTIL_MAX_PARABEL
     &         (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
             STOKCMXEF(ISTO,1)=DUM1
             STOKCMXEF(ISTO,2)=DUM2
             IF (IFAIL.NE.0) THEN
               WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S',ISTO
               WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
             ENDIF
           ENDIF

         ENDDO !ISTO

       ENDIF   !ISTOKES

       IF (NFREQ.GT.1) THEN

         IF (ISTOKES.NE.0) THEN

           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
          if (ipin.ne.3) then
            WRITE(LUNGFO,*)
     &        '      Estimated maxima of s0, s1, s2 ,s3 for selected point:'
          else
            WRITE(LUNGFO,*)
     &        '      Estimated maxima of mean densities of s0, s1, s2 ,s3:'
          endif
           DO ISTO=1,4
             WRITE(LUNGFO,*)'      ',STOKCMX(ISTO,1),STOKCMX(ISTO,2)
           ENDDO  !ISTO

           IF (IFOLD.NE.0) THEN
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
     &         '      Estimated maxima of s0, s1, s2 ,s3 for selected point with emittance:'
             DO ISTO=1,4
               WRITE(LUNGFO,*)'      ',STOKCMXF(ISTO,1),STOKCMXF(ISTO,2)
             ENDDO   !ISTO
           ENDIF  !IFOLD

           IF (IEFOLD.NE.0) THEN
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
     &         '      Estimated maxima of s0, s1, s2 ,s3 for selected point with energy spread:'
             DO ISTO=1,4
               WRITE(LUNGFO,*)'      ',STOKCMXE(ISTO,1),STOKCMXE(ISTO,2)
             ENDDO   !ISTO
           ENDIF  !IFOLD

           IF (IFOLD.NE.0.AND.IEFOLD.NE.0) THEN
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
     &         '      Estimated maxima of s0, s1, s2 ,s3 for selected point'
             WRITE(LUNGFO,*)
     &         '      with emittance and energy spread:'
             DO ISTO=1,4
               WRITE(LUNGFO,*)'      ',STOKCMXEF(ISTO,1),STOKCMXEF(ISTO,2)
             ENDDO   !ISTO
           ENDIF

           DO IFREQ=1,NFREQ
             S1=STOKEC(1,IFREQ)
             S2=STOKEC(2,IFREQ)
             S3=STOKEC(3,IFREQ)
             S4=STOKEC(4,IFREQ)
             IF (S1.NE.0.0) THEN
               POL=S4/S1*S4
             ELSE
               POL=0.0d0
             ENDIF
             SPECBUFF(IFREQ)=ABS(POL)
           ENDDO  !IFR
           CALL UTIL_MAX_PARABEL
     &       (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
           G3CMX(1)=DUM1
           G3CMX(2)=DUM2
           IF (IFAIL.NE.0) THEN
             WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S'
             WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
           ENDIF

           IF (IFOLD.NE.0) THEN
             DO IFREQ=1,NFREQ
               S1=STOKECF(1,IFREQ)
               S2=STOKECF(2,IFREQ)
               S3=STOKECF(3,IFREQ)
               S4=STOKECF(4,IFREQ)
               IF (S1.NE.0.0) THEN
                 POL=S4/S1*S4
               ELSE
                 POL=0.0d0
               ENDIF
               SPECBUFF(IFREQ)=ABS(POL)
             ENDDO   !IFR
             CALL UTIL_MAX_PARABEL
     &         (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
             G3CMXF(1)=DUM1
             G3CMXF(2)=DUM2
             IF (IFAIL.NE.0) THEN
               WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S3*S3/S0'
               WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
             ENDIF
           ENDIF

           IF (IEFOLD.NE.0) THEN
             DO IFREQ=1,NFREQ
               S1=STOKECE(1,IFREQ)
               S2=STOKECE(2,IFREQ)
               S3=STOKECE(3,IFREQ)
               S4=STOKECE(4,IFREQ)
               IF (S1.NE.0.0) THEN
                 POL=S4/S1*S4
               ELSE
                 POL=0.0d0
               ENDIF
               SPECBUFF(IFREQ)=ABS(POL)
             ENDDO   !IFR
             CALL UTIL_MAX_PARABEL
     &         (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
             G3CMXE(1)=DUM1
             G3CMXE(2)=DUM2
             IF (IFAIL.NE.0) THEN
               WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S3*S3/S0'
               WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
             ENDIF
           ENDIF

           IF (IFOLD.NE.0.AND.IEFOLD.NE.0) THEN

             DO IFREQ=1,NFREQ
               S1=STOKECEF(1,IFREQ)
               S2=STOKECEF(2,IFREQ)
               S3=STOKECEF(3,IFREQ)
               S4=STOKECEF(4,IFREQ)
               IF (S1.NE.0.0) THEN
                 POL=S4/S1*S4
               ELSE
                 POL=0.0d0
               ENDIF
               SPECBUFF(IFREQ)=ABS(POL)
             ENDDO   !IFREQ

             CALL UTIL_MAX_PARABEL
     &         (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
             G3CMXEF(1)=DUM1
             G3CMXEF(2)=DUM2
             IF (IFAIL.NE.0) THEN
               WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S3*S3/S0'
               WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
             ENDIF

           ENDIF  !IFOLD,IEFOLD

           WRITE(LUNGFO,*)
           WRITE(LUNGFO,*)
           if (ipin.ne.3) then
             WRITE(LUNGFO,*)
     &         '      Estimated maximum of s3*s3/s0 for selected point:'
           else
             WRITE(LUNGFO,*)
     &         '      Estimated maximum of mean density s3*s3/s0:'
           endif
           WRITE(LUNGFO,*)'      ',G3CMX(1),G3CMX(2)

           IF (IFOLD.NE.0) THEN
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
     &         '      Estimated maximum of s3*s3/s0 for selected point with emittance:'
             WRITE(LUNGFO,*)'      ',G3CMXF(1),G3CMXF(2)
           ENDIF!IFOLD

           IF (IEFOLD.NE.0) THEN
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
     &         '      Estimated maximum of s3*s3/s0 for selected point with energy spread:'
             WRITE(LUNGFO,*)'      ',G3CMXE(1),G3CMXE(2)
           ENDIF  !IEFOLD

           IF (IFOLD.NE.0.AND.IEFOLD.NE.0) THEN
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
     &         '      Estimated maximum of s3*s3/s0 for selected point'
             WRITE(LUNGFO,*)
     &         '      with emittance and energy spread:'
             WRITE(LUNGFO,*)'      ',G3CMXEF(1),G3CMXEF(2)
           ENDIF !IFOLD,IEFOLD

           IF (IPIN.NE.0) THEN

             DO ISTO=1,4

               DO IFREQ=1,NFREQ
                 SPECBUFF(IFREQ)=ABS(WSTOKES(ISTO,IFREQ))
c                 print*,"spectrum:",isto,ifreq,wstokes(isto,ifreq)
               ENDDO !IFR
               CALL UTIL_MAX_PARABEL
     &           (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
               WSTOKMX(ISTO,1)=DUM1
               WSTOKMX(ISTO,2)=DUM2
               IF (IFAIL.NE.0) THEN
                 WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S',ISTO
                 WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
               ENDIF


               IF (IFOLD.NE.0) THEN
                 DO IFREQ=1,NFREQ
                   SPECBUFF(IFREQ)=ABS(WSTOKESF(ISTO,IFREQ))
                 ENDDO  !IFR
                 CALL UTIL_MAX_PARABEL
     &             (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
                 WSTOKMXF(ISTO,1)=DUM1
                 WSTOKMXF(ISTO,2)=DUM2
                 IF (IFAIL.NE.0) THEN
                   WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S',ISTO
                   WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
                 ENDIF
               ENDIF !IFOLD

               IF (IEFOLD.NE.0) THEN
                 DO IFREQ=1,NFREQ
                   SPECBUFF(IFREQ)=ABS(WSTOKESE(ISTO,IFREQ))
                 ENDDO  !IFR
                 CALL UTIL_MAX_PARABEL
     &             (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
                 WSTOKMXE(ISTO,1)=DUM1
                 WSTOKMXE(ISTO,2)=DUM2
                 IF (IFAIL.NE.0) THEN
                   WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S',ISTO
                   WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
                 ENDIF
               ENDIF !IEFOLD

               IF (IFOLD.NE.0.AND.IEFOLD.NE.0) THEN
                 DO IFREQ=1,NFREQ
                   SPECBUFF(IFREQ)=ABS(WSTOKESEF(ISTO,IFREQ))
                 ENDDO  !IFR
                 CALL UTIL_MAX_PARABEL
     &             (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
                 WSTOKMXEF(ISTO,1)=DUM1
                 WSTOKMXEF(ISTO,2)=DUM2
                 IF (IFAIL.NE.0) THEN
                   WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S',ISTO
                   WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
                 ENDIF
               ENDIF !IFOLD,IEFOLD

             ENDDO   !ISTO

             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
     &         '      Estimated maxima of fluxes s0, s1, s2 ,s3:'
             DO ISTO=1,4
               WRITE(LUNGFO,*)'      ',WSTOKMX(ISTO,1),WSTOKMX(ISTO,2)
             ENDDO   !ISTO

             IF (IFOLD.NE.0) THEN
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
     &           '      Estimated maxima of fluxes s0, s1, s2 ,s3 with emittance:'
               DO ISTO=1,4
                 WRITE(LUNGFO,*)'      ',WSTOKMXF(ISTO,1),WSTOKMXF(ISTO,2)
               ENDDO !ISTO
             ENDIF

             IF (IEFOLD.NE.0) THEN
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
     &           '      Estimated maxima of fluxes s0, s1, s2 ,s3 with energy spread:'
               DO ISTO=1,4
                 WRITE(LUNGFO,*)'      ',WSTOKMXE(ISTO,1),WSTOKMXE(ISTO,2)
               ENDDO !ISTO
             ENDIF

             IF (IFOLD.NE.0.AND.IEFOLD.NE.0) THEN
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
     &           '      Estimated maxima of fluxes s0, s1, s2 ,s3'
               WRITE(LUNGFO,*)
     &           '      with emittance and energy spread:'
               DO ISTO=1,4
                 WRITE(LUNGFO,*)'      ',WSTOKMXEF(ISTO,1),WSTOKMXEF(ISTO,2)
               ENDDO !ISTO
             ENDIF

             DO IFREQ=1,NFREQ
               S1=WSTOKES(1,IFREQ)
               S2=WSTOKES(2,IFREQ)
               S3=WSTOKES(3,IFREQ)
               S4=WSTOKES(4,IFREQ)
               IF (S1.NE.0.0) THEN
                 POL=S4/S1*S4
               ELSE
                 POL=0.0d0
               ENDIF
               SPECBUFF(IFREQ)=ABS(POL)
             ENDDO   !IFR
             CALL UTIL_MAX_PARABEL
     &         (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
             WG3MX(1)=DUM1
             WG3MX(2)=DUM2
             IF (IFAIL.NE.0) THEN
               WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S3*S3/S0'
               WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
             ENDIF

             IF (IEFOLD.NE.0) THEN
               DO IFREQ=1,NFREQ
                 S1=WSTOKESE(1,IFREQ)
                 S2=WSTOKESE(2,IFREQ)
                 S3=WSTOKESE(3,IFREQ)
                 S4=WSTOKESE(4,IFREQ)
                 IF (S1.NE.0.0) THEN
                   POL=S4/S1*S4
                 ELSE
                   POL=0.0d0
                 ENDIF
                 SPECBUFF(IFREQ)=ABS(POL)
               ENDDO !IFR
               CALL UTIL_MAX_PARABEL
     &           (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
               WG3MXE(1)=DUM1
               WG3MXE(2)=DUM2
               IF (IFAIL.NE.0) THEN
                 WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S3*S3/S0'
                 WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
               ENDIF
             ENDIF   !IEFOLD

             IF (IFOLD.NE.0) THEN
               DO IFREQ=1,NFREQ
                 S1=WSTOKESF(1,IFREQ)
                 S2=WSTOKESF(2,IFREQ)
                 S3=WSTOKESF(3,IFREQ)
                 S4=WSTOKESF(4,IFREQ)
                 IF (S1.NE.0.0) THEN
                   POL=S4/S1*S4
                 ELSE
                   POL=0.0d0
                 ENDIF
                 SPECBUFF(IFREQ)=ABS(POL)
               ENDDO !IFR
               CALL UTIL_MAX_PARABEL
     &           (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
               WG3MXF(1)=DUM1
               WG3MXF(2)=DUM2
               IF (IFAIL.NE.0) THEN
                 WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S3*S3/S0'
                 WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
               ENDIF
             ENDIF   !IFOLD

             IF (IFOLD.NE.0.AND.IEFOLD.NE.0) THEN
               DO IFREQ=1,NFREQ
                 S1=WSTOKESEF(1,IFREQ)
                 S2=WSTOKESEF(2,IFREQ)
                 S3=WSTOKESEF(3,IFREQ)
                 S4=WSTOKESEF(4,IFREQ)
                 IF (S1.NE.0.0) THEN
                   POL=S4/S1*S4
                 ELSE
                   POL=0.0d0
                 ENDIF
                 SPECBUFF(IFREQ)=ABS(POL)
               ENDDO !IFR
               CALL UTIL_MAX_PARABEL
     &           (NFREQ,FREQ,SPECBUFF,DUM1,DUM2,WSNOBFR1,WSNOBFR2,IFAIL)
               WG3MXEF(1)=DUM1
               WG3MXEF(2)=DUM2
               IF (IFAIL.NE.0) THEN
                 WRITE(LUNGFO,*)'*** WARNING: CALL TO UTIL_MAX_PARABEL FAILED FOR S3*S3/S0'
                 WRITE(LUNGFO,*)'*** CHECK VALUES CAREFULLY'
               ENDIF
             ENDIF   !IFOLD,IEFOLD

             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
             WRITE(LUNGFO,*)
     &         '      Estimated maxima of fluxes s3*s3/s0:'
             WRITE(LUNGFO,*)'      ',WG3MX(1),WG3MX(2)

             IF (IFOLD.NE.0) THEN
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
     &           '      Estimated maxima of fluxes s3*s3/s0 with emittance:'
               WRITE(LUNGFO,*)'      ',WG3MXF(1),WG3MXF(2)
             ENDIF

             IF (IEFOLD.NE.0) THEN
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
     &           '      Estimated maxima of fluxes s3*s3/s0 with energy spread:'
               WRITE(LUNGFO,*)'      ',WG3MXE(1),WG3MXE(2)
             ENDIF

             IF (IFOLD.NE.0.AND.IEFOLD.NE.0) THEN
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
               WRITE(LUNGFO,*)
     &           '      Estimated maxima of fluxes s3*s3/s0'
               WRITE(LUNGFO,*)
     &           '      with emittance and energy spread:'
               WRITE(LUNGFO,*)'      ',WG3MXEF(1),WG3MXEF(2)
             ENDIF

           ENDIF  !ISTOKES

         ENDIF !IPIN

      ENDIF !NFREQ

C---BRILLIANCE


      IF (IBRILL.NE.0) CALL BRILL

C--- STORE RESULT IN HISTOGRAMS

      ALLOCATE(FILL(NOBSV))
      DO I=1,NOBSV
        FILL(I)=0.0d0
      ENDDO

      IF(IHPIN.GT.0) THEN
        CALL HSPEC
      ELSE IF (IHFOLD.NE.0) THEN
        CALL HFOLD
      ENDIF

      !{ Fold power density
      !Baustelle
      !} Fold power density

      IF(IWFILPOW.NE.0) THEN

         OPEN(UNIT=LUNPOW,FILE=FILEPOW)

         IF (IWFILPOW.GT.0) THEN
           WRITE(LUNPOW,*)ICODE,' ',CODE
         ENDIF

         if (ipin.ne.0) then
           DO IY=(NOBSVY-MOBSVY)/2+1,(NOBSVY-MOBSVY)/2+MOBSVY
             DO IZ=(NOBSVZ-MOBSVZ)/2+1,(NOBSVZ-MOBSVZ)/2+MOBSVZ
               IO=(IY-1)*NOBSVZ+IZ
               DUM1=0.0d0
               IF(IFOLD.NE.0) DUM1=SPECTOTIF(IO)
               WRITE(LUNPOW,'(7(1PE13.5))')(OBSV(IX,IO)*1.E3,IX=1,3)
     &           ,SPECPOWT(IO)/1.0E6,SPECTOTI(IO)/1.E6,DUM1/1.E6
     &           ,SPECPOWTgraz(IO)/1.0e6
             ENDDO
           ENDDO
         else
           dum1=0.0d0
           do iobsv=1,nobsv
             write(lunpow,'(7(1pe13.5))')(obsv(ix,iobsv)*1.e3,ix=1,3)
     &         ,specpowt(iobsv)/1.0e6,spectoti(iobsv)/1.e6,dum1/1.e6
     &         ,SPECPOWTgraz(iobsv)/1.0e6
           enddo
         endif

         CLOSE(LUNPOW)

      ENDIF !IWFILPOW

      IF(IHFREQ.NE.0) CALL HFREQ

      RETURN
      END
