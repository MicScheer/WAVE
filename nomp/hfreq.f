*CMZ :  4.01/03 10/06/2023  15.52.02  by  Michael Scheer
*CMZ :  4.01/00 08/01/2023  10.16.47  by  Michael Scheer
*CMZ :  4.00/17 04/10/2022  08.10.22  by  Michael Scheer
*CMZ :  4.00/15 07/04/2022  07.14.03  by  Michael Scheer
*CMZ :  4.00/14 30/12/2021  15.41.22  by  Michael Scheer
*CMZ :  4.00/13 07/12/2021  18.47.10  by  Michael Scheer
*CMZ :  4.00/11 11/06/2021  11.00.05  by  Michael Scheer
*CMZ :  4.00/04 23/08/2019  15.58.25  by  Michael Scheer
*CMZ :  4.00/02 12/04/2019  18.39.49  by  Michael Scheer
*CMZ :  3.04/01 03/04/2018  14.26.06  by  Michael Scheer
*CMZ :  3.03/02 18/04/2016  15.26.59  by  Michael Scheer
*CMZ :  3.03/00 20/08/2015  15.24.19  by  Michael Scheer
*CMZ :  3.02/09 09/07/2015  17.12.40  by  Michael Scheer
*CMZ :  3.02/08 25/06/2015  12.41.28  by  Michael Scheer
*CMZ :  3.02/07 24/06/2015  12.40.15  by  Michael Scheer
*CMZ :  3.02/04 12/12/2014  16.56.09  by  Michael Scheer
*CMZ :  3.02/03 04/11/2014  12.49.47  by  Michael Scheer
*CMZ :  3.01/06 23/06/2014  09.14.50  by  Michael Scheer
*CMZ :  3.01/05 12/06/2014  08.52.10  by  Michael Scheer
*CMZ :  3.00/00 11/03/2013  15.13.36  by  Michael Scheer
*CMZ :  2.70/05 02/01/2013  15.34.39  by  Michael Scheer
*CMZ :  2.70/00 11/12/2012  10.58.11  by  Michael Scheer
*CMZ :  2.69/00 24/10/2012  16.35.22  by  Michael Scheer
*CMZ :  2.68/05 28/09/2012  13.18.55  by  Michael Scheer
*CMZ :  2.68/01 29/05/2012  13.43.27  by  Michael Scheer
*CMZ :  2.67/02 26/04/2012  14.57.31  by  Michael Scheer
*CMZ :  2.67/00 17/02/2012  14.11.28  by  Michael Scheer
*CMZ :  2.66/19 16/12/2010  12.57.57  by  Michael Scheer
*CMZ :  2.66/18 16/12/2010  12.52.11  by  Michael Scheer
*CMZ :  2.66/14 09/11/2010  15.39.16  by  Michael Scheer
*CMZ :  2.66/07 12/05/2010  13.34.28  by  Michael Scheer
*CMZ :  2.66/03 27/11/2009  15.57.31  by  Michael Scheer
*CMZ :  2.66/02 26/10/2009  09.28.27  by  Michael Scheer
*CMZ :  2.65/02 23/10/2009  09.19.41  by  Michael Scheer
*CMZ :  2.64/01 14/09/2009  15.19.42  by  Michael Scheer
*CMZ :  2.61/03 27/03/2007  13.10.16  by  Michael Scheer
*CMZ :  2.61/01 15/03/2007  11.13.54  by  Michael Scheer
*CMZ :  2.56/00 17/10/2005  12.42.20  by  Michael Scheer
*CMZ :  2.55/00 07/07/2005  16.35.20  by  Michael Scheer
*CMZ :  2.53/04 28/01/2005  12.42.15  by  Michael Scheer
*CMZ :  2.53/03 26/01/2005  15.02.46  by  Michael Scheer
*CMZ :  2.53/02 25/01/2005  16.49.46  by  Michael Scheer
*CMZ :  2.52/16 21/01/2005  13.34.39  by  Michael Scheer
*CMZ :  2.52/13 09/12/2004  11.06.01  by  Michael Scheer
*CMZ :  2.52/00 30/06/2004  16.42.15  by  Michael Scheer
*CMZ :  2.49/00 22/03/2004  09.56.01  by  Michael Scheer
*CMZ :  2.48/04 17/03/2004  10.57.53  by  Michael Scheer
*CMZ :  2.47/08 20/05/2003  14.46.41  by  Michael Scheer
*CMZ :  2.41/10 14/08/2002  17.34.01  by  Michael Scheer
*CMZ :  2.41/07 13/06/2002  15.05.28  by  Michael Scheer
*CMZ :  2.41/00 20/03/2002  14.37.14  by  Michael Scheer
*CMZ :  2.36/01 08/11/2001  17.30.36  by  Michael Scheer
*CMZ :  2.33/06 04/05/2001  11.44.17  by  Michael Scheer
*CMZ :  2.33/05 04/05/2001  11.42.26  by  Michael Scheer
*CMZ :  2.20/10 04/04/2001  12.21.46  by  Michael Scheer
*CMZ :  2.20/09 23/03/2001  18.26.22  by  Michael Scheer
*CMZ :  2.16/08 23/10/2000  17.29.35  by  Michael Scheer
*CMZ :  2.16/07 01/09/2000  14.32.32  by  Michael Scheer
*CMZ :  2.16/06 30/08/2000  13.48.49  by  Michael Scheer
*CMZ :  2.16/05 04/08/2000  12.09.00  by  Michael Scheer
*CMZ :  2.16/04 28/06/2000  17.39.06  by  Michael Scheer
*CMZ :  2.16/01 15/06/2000  15.45.22  by  Michael Scheer
*CMZ :  2.15/00 11/05/2000  10.25.20  by  Michael Scheer
*CMZ :  2.13/07 17/02/2000  15.11.12  by  Michael Scheer
*CMZ :  2.13/03 12/01/2000  16.33.49  by  Michael Scheer
*CMZ :  2.13/00 02/12/99  13.24.15  by  Michael Scheer
*CMZ :  2.10/01 25/02/99  14.18.30  by  Michael Scheer
*CMZ :  1.03/06 23/09/98  17.07.41  by  Michael Scheer
*CMZ :  1.03/00 16/01/98  11.16.48  by  Michael Scheer
*CMZ :  1.00/00 24/09/97  10.31.27  by  Michael Scheer
*CMZ : 00.02/03 16/01/97  11.48.11  by  Michael Scheer
*CMZ : 00.02/02 10/01/97  16.50.11  by  Michael Scheer
*CMZ : 00.01/12 15/10/96  10.36.48  by  Michael Scheer
*CMZ : 00.01/06 14/02/95  10.54.13  by  Michael Scheer
*CMZ : 00.01/04 30/01/95  13.06.50  by  Michael Scheer
*CMZ : 00.01/02 18/11/94  16.43.29  by  Michael Scheer
*CMZ : 00.00/04 29/04/94  17.52.08  by  Michael Scheer
*CMZ : 00.00/00 28/04/94  16.12.39  by  Michael Scheer
*-- Author :  Michael Scheer
      SUBROUTINE HFREQ
*KEEP,gplhint.
!******************************************************************************
!
!      Copyright 2013 Helmholtz-Zentrum Berlin (HZB)
!      Hahn-Meitner-Platz 1
!      D-14109 Berlin
!      Germany
!
!      Author Michael Scheer, Michael.Scheer@Helmholtz-Berlin.de
!
! -----------------------------------------------------------------------
!
!    This program is free software: you can redistribute it and/or modify
!    it under the terms of the GNU General Public License as published by
!    the Free Software Foundation, either version 3 of the License, or
!    (at your option) any later version.
!
!    This program is distributed in the hope that it will be useful,
!    but WITHOUT ANY WARRANTY; without even the implied warranty of
!    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
!    GNU General Public License for more details.
!
!    You should have received a copy (wave_gpl.txt) of the GNU General Public
!    License along with this program.
!    If not, see <http://www.gnu.org/licenses/>.
!
!    Dieses Programm ist Freie Software: Sie koennen es unter den Bedingungen
!    der GNU General Public License, wie von der Free Software Foundation,
!    Version 3 der Lizenz oder (nach Ihrer Option) jeder spaeteren
!    veroeffentlichten Version, weiterverbreiten und/oder modifizieren.
!
!    Dieses Programm wird in der Hoffnung, dass es nuetzlich sein wird, aber
!    OHNE JEDE GEWAEHRLEISTUNG, bereitgestellt; sogar ohne die implizite
!    Gewaehrleistung der MARKTFAEHIGKEIT oder EIGNUNG FueR EINEN BESTIMMTEN ZWECK.
!    Siehe die GNU General Public License fuer weitere Details.
!
!    Sie sollten eine Kopie (wave_gpl.txt) der GNU General Public License
!    zusammen mit diesem Programm erhalten haben. Wenn nicht,
!    siehe <http://www.gnu.org/licenses/>.
!
!******************************************************************************
*KEND.

*KEEP,spectf90u.
      include 'spectf90u.cmn'
*KEEP,sourcef90u.
      include 'sourcef90u.cmn'
*KEEP,observf90u.
      include 'observf90u.cmn'
*KEND.

      use clustermod

C--- HISTOGRAMS FOR SPECTRA OF SINGLE OBSERVATION POINTS OR PINHOLE

      IMPLICIT NONE

*KEEP,cmpara.
      include 'cmpara.cmn'
*KEEP,contrl.
      include 'contrl.cmn'
*KEEP,whbook.
      include 'whbook.cmn'
*KEEP,pawcmn.
*KEND.

*KEEP,spect.
      include 'spect.cmn'
*KEEP,freqs.
      include 'freqs.cmn'
*KEEP,observf90.
      include 'observf90.cmn'
*KEEP,sourcef90.
      include 'sourcef90.cmn'
*KEEP,specdip.
      include 'specdip.cmn'
*KEEP,phasef90.
      include 'phasef90.cmn'
*KEEP,ampli.
      include 'ampli.cmn'
*KEEP,myfiles.
      include 'myfiles.cmn'
*KEEP,phycon.
      include 'phycon.cmn'
*KEEP,debugwave.
      include 'debugwave.cmn'
*KEND.

      INTEGER ID,IOBSV,ifrq,ISOUR,IOBSVY,IOBSVZ,NDIMPH,IOBSVR,IOBSVPHI
      INTEGER ICYCLE,MFREQ,I,ISTAT,I47,jsource

      REAL*4 FLOW,FHIG,DF
      DOUBLE PRECISION WEIGHT,smax,reanor,
     &  dist,dist0,ddist,h2,censoux,censouy,censouz,dphase,wlen,waves

      CHARACTER(80) TIT
      CHARACTER(4) CHTAGS(5)
      CHARACTER(5) CHTAGSF(36)
      CHARACTER(5) CHTAGSFd(36)
      CHARACTER(4) CHSPEC(31)
      CHARACTER(4) CHSPECRPHI(33)
      CHARACTER(4) CHPOW(8)
      CHARACTER(4) CHPOWF(9)
      CHARACTER(4) CHPOWV(5)
      CHARACTER(4) CHSPECF(18)
      CHARACTER(4) CHSTOK(12)
      CHARACTER(4) CHBRILL(17)
      CHARACTER(128) FILE47
      CHARACTER(8) OLDDIR

      INTEGER ND

      REAL*8 FSTUPLE(100),FSPEC(33)
      real*8 , dimension(:), allocatable :: phfill

      data chtags/'x','y','z','ener','spec'/

      data chtagsf/'iene','ener','flux','fluxf'
     &  ,'s0','s1','s2','s3'
     &  ,'s0f','s1f','s2f','s3f'
     &  ,'s0e','s1e','s2e','s3e'
     &  ,'s0ef','s1ef','s2ef','s3ef'
     &  ,'b0','b1','b2','b3'
     &  ,'b0f','b1f','b2f','b3f'
     &  ,'b0e','b1e','b2e','b3e'
     &  ,'b0ef','b1ef','b2ef','b3ef' /

      data chtagsfd/'iene','ener','fldn','fldnf'
     &  ,'s0','s1','s2','s3'
     &  ,'s0f','s1f','s2f','s3f'
     &  ,'s0e','s1e','s2e','s3e'
     &  ,'s0ef','s1ef','s2ef','s3ef'
     &  ,'b0','b1','b2','b3'
     &  ,'b0f','b1f','b2f','b3f'
     &  ,'b0e','b1e','b2e','b3e'
     &  ,'b0ef','b1ef','b2ef','b3ef' /

      data chspec/'isou','iobs','x','y','z','ener','spec'
     &  ,'iz','iy','iene',
     &  're_x','im_x','re_y','im_y','re_z','im_z','rf_y','if_y','rf_z','if_z',
     &  'rs_x','is_x','rs_y','is_y','rs_z','is_z','rsfy','isfy','rsfz','isfz',
     &  'phi0'
     &  /
      data chspecrphi/'isou','iobs','x','y','z','r','phi','ener','spec'
     &  ,'ir','iphi','iene',
     &  're_x','im_x','re_y','im_y','re_z','im_z','rf_y','if_y','rf_z','if_z',
     &  'rs_x','is_x','rs_y','is_y','rs_z','is_z','rsfy','isfy','rsfz','isfz',
     &  'phi0'
     &  /
      data chbrill/'ener','b0','b1','b2','b3','b0f','b1f','b2f','b3f',
     &  'b0e','b1e','b2e','b3e','b0ef','b1ef','b2ef','b3ef'/

      data chpow/'x','y','z','pow','iz','iy','iobs','isou'/
      data chpowf/'x','y','z','pow','powf','iz','iy','iobs','isou'/

      data chpowv/'x','z','pow','iz','isou'/

      data chspecf/'isou','iobs','x','y','z','ener','spec'
     &  ,'iz','iy','iene',
     &  're_y','im_y','re_z','im_z',
     &  'rs_y','is_y','rs_z','is_z'
     &  /

      data chstok/'iobs','x','y','z','ener','s0','s1','s2','s3'
     &  ,'iz','iy','iene'
     &  /

      NDIMPH=MPHASEZ*MPHASEY
      allocate(PHFILL(NDIMPH))
      phfill=0.0d0

      if (ipin.eq.3) then
        call hfreq3
        if(ibunch.ne.0.and.icluster.gt.0) call wpampntup
        return
      endif

      I47=0

      IF (mhbookp.eq.0.
     &    .and.
     &    IPIN.EQ.1.AND.NOBSV*NFREQ.GT.100000.and.iroottrees.ge.0) THEN

        I47=1

        WRITE(6,*)
        WRITE(6,*)'*** WARNING IN HFREQ: HISTOGRAM FILE PROBABLY TOO SMALL'
        WRITE(6,*)
     & '*** GENERATING SPECIAL HISTOGRAM FILES FOR DISTRIBUTIONS IN PINHOLES'
        WRITE(6,*)
        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)'*** WARNING IN HFREQ: HISTOGRAM FILE PROBABLY TOO SMALL'
        WRITE(LUNGFO,*)
     & '*** GENERATING SPECIAL HISTOGRAM FILES FOR DISTRIBUTIONS IN PINHOLES'
        WRITE(LUNGFO,*)

      ENDIF

      IF (IUNIT.NE.0) THEN
        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)
     &    '*** WARNING SR HFREQ: NO HISTOGRAMS ONLY NTUPLES OF SPECTRUM FOR IUNIT.NE.0'
        WRITE(LUNGFO,*)
        WRITE(6,*)
        WRITE(6,*)
     &    '*** WARNING SR HFREQ: NO HISTOGRAMS ONLY NTUPLES OF SPECTRUM FOR IUNIT.NE.0'
        WRITE(6,*)
        GOTO 100
      ENDIF

      IF (ifreq2P.eq.0) THEN
        WRITE(LUNGFO,*)
        WRITE(LUNGFO,*)'*** WARNING SR HFREQ ***'
        WRITE(LUNGFO,*)'PARAMETER ifreq2P=0 , NO HISTOGRAM BOOKED'
        WRITE(LUNGFO,*)
      else IF (ifreq2P.EQ.2) THEN

        DF=FREQ(2)-FREQ(1)
        FLOW=FREQ(1)-DF/2.
        FHIG=FREQ(NFREQ)+DF/2.

        IF (FLOW.LT.0.) THEN
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'*** WARNING SR HFREQ ***'
          WRITE(LUNGFO,*)'LOW EDGE OF HISTOGRAM NEGATIVE'
          WRITE(LUNGFO,*)'BE CAREFUL IF X-AXIS IS PLOTTED WITH LOGARITHMIC SCALE'
          WRITE(LUNGFO,*)
        ENDIF

        IF(IPIN.EQ.0) THEN

          DO IOBSV=1,NOBSV

            ID=ICFREQ+IOBSV
            MFREQ=NINT((FHIG-FLOW)/DF)
            call hbook1m(ID,'PHOTON FLUX DENSITY x 1.E-6',
     &        MFREQ,FLOW,FHIG,VMX)

            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          SPECTOT(IOBSV+NOBSV*(ifrq-1))*1.0d-6)
            ENDDO   !NFREQ

            CALL MHROUT(ID,ICYCLE,' ')
            CALL hdeletm(ID)

          IF (IFOLD.EQ.2) THEN
              ID=ICFREQ+1000+IOBSV
              MFREQ=NINT((FHIG-FLOW)/DF)
              call hbook1m(ID,'PHOTON FLUX DENSITY x 1.E-6 (FOLDED)',
     &        MFREQ,FLOW,FHIG,VMX)

              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          SPECTOTF(IOBSV+NOBSV*(ifrq-1))*1.0d-6)
              ENDDO   !NFREQ

              CALL MHROUT(ID,ICYCLE,' ')
              CALL hdeletm(ID)

          ENDIF !IFOLDE.EQ.2

          ENDDO !IOBSV

          IF (ISTOKES.NE.0) THEN

            ID=ICFRS0
            call hbook1m(ID,'S0 (sel. obs. point) x 1.E-6 '
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(STOKES(1,1+NOBSV*(ifrq-1))*1.0d-6))
            ENDDO   !NFREQ

            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRS1
            call hbook1m(ID,'S1 (sel. obs. point) x 1.E-6 '
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(STOKES(2,1+NOBSV*(ifrq-1))*1.0d-6))
            ENDDO   !NFREQ

            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRS2
            call hbook1m(ID,'S2 (sel. obs. point) x 1.E-6 '
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(STOKES(3,1+NOBSV*(ifrq-1))*1.0d-6))
            ENDDO   !NFREQ

            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRS3
            call hbook1m(ID,'S3 (sel. obs. point) x 1.E-6 '
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(STOKES(4,1+NOBSV*(ifrq-1))*1.0d-6))
            ENDDO   !NFREQ

            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRP
            call hbook1m(ID,'P (sel. obs. point)'
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=SQRT
     &          ((STOKES(2,IOBFR)/STOKES(1,IOBFR))**2
     &          +(STOKES(3,IOBFR)/STOKES(1,IOBFR))**2
     &         +(STOKES(4,IOBFR)/STOKES(1,IOBFR))**2)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,WEIGHT)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRP1
            call hbook1m(ID,'P1 (sel. obs. point)'
     &                    ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=STOKES(2,IOBFR)/STOKES(1,IOBFR)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,WEIGHT)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRP2
            call hbook1m(ID,'P2 (sel. obs. point)'
     &                    ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=STOKES(3,IOBFR)/STOKES(1,IOBFR)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,WEIGHT)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRP3
            call hbook1m(ID,'P3 (sel. obs. point)'
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=STOKES(4,IOBFR)/STOKES(1,IOBFR)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,WEIGHT)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRP23
            call hbook1m(ID,'P23 (sel. obs. point)'
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=SQRT((STOKES(3,IOBFR)/STOKES(1,IOBFR))**2
     &          +(STOKES(4,IOBFR)/STOKES(1,IOBFR))**2)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRG3
            call hbook1m(ID,'G3 (sel. obs. point) x 1.E-6 '
     &                    ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=STOKES(4,IOBFR)/STOKES(1,IOBFR)*STOKES(4,IOBFR)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight*1.0d-6)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRG23
            call hbook1m(ID,'G23 (sel. obs. point) x 1.E-6 '
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=((STOKES(3,IOBFR)/STOKES(1,IOBFR))**2
     &          +(STOKES(4,IOBFR)/STOKES(1,IOBFR))**2)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight*1.0d-6)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            IF (IEFOLD.NE.0) THEN

              ID=ICFRS0E
              call hbook1m(ID,'S0_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(WSTOKESE(1,ifrq)*1.0d-6))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRS1E
              call hbook1m(ID,'S1_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(wstokESE(2,ifrq)*1.0d-6))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRS2E
              call hbook1m(ID,'S2_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(wstokESE(3,ifrq)*1.0d-6))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRS3E
              call hbook1m(ID,'S3_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(wstokESE(4,ifrq)*1.0d-6))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRPE
              call hbook1m(ID,'P_E (sel. obs. point)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=SQRT
     &            ((WSTOKESE(2,ifrq)/WSTOKESE(1,ifrq))**2
     &            +(WSTOKESE(3,ifrq)/WSTOKESE(1,ifrq))**2
     &            +(WSTOKESE(4,ifrq)/WSTOKESE(1,ifrq))**2)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRP1E
              call hbook1m(ID,'P1_E (sel. obs. point)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(2,ifrq)/WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRP2E
              call hbook1m(ID,'P2_E (sel. obs. point)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(3,ifrq)/WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRP3E
              call hbook1m(ID,'P3_E (sel. obs. point)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(4,ifrq)/WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRP23E
              call hbook1m(ID,'P23_E (sel. obs. point)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=SQRT(
     &            (WSTOKESE(3,ifrq)/WSTOKESE(1,ifrq))**2
     &            +(WSTOKESE(4,ifrq)/WSTOKESE(1,ifrq))**2)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRG3E
              call hbook1m(ID,'G3_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(4,ifrq)/WSTOKESE(1,ifrq)*WSTOKESE(4,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight*1.0d-6)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRG23E
              call hbook1m(ID,'G23_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(3,ifrq)/WSTOKESE(1,ifrq)*WSTOKESE(3,ifrq)
     &            +WSTOKESE(4,ifrq)/WSTOKESE(1,ifrq)*WSTOKESE(4,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight*1.0d-6)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

            ENDIF !IEFOLD

            IF (IBRILL.NE.0) THEN

              ID=ICFRB0
              call hbook1m(ID,'SELECTED B0 x 1.E-12'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(brillC(1,ifrq)*1.0d-12))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

              ID=ICFRB1
              call hbook1m(ID,'SELECTED B1 x 1.E-12'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(brillC(2,ifrq)*1.0d-12))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

              ID=ICFRB2
              call hbook1m(ID,'SELECTED B2 x 1.E-12'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(brillC(3,ifrq)*1.0d-12))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

              ID=ICFRB3
              call hbook1m(ID,'SELECTED B3 x 1.E-12'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(brillC(4,ifrq)*1.0d-12))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

              IF (IEFOLD.NE.0) THEN

                ID=ICFRB0E
                call hbook1m(ID,'SELECTED B0_E x 1.E-12'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(brillCE(1,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                ID=ICFRB1E
                call hbook1m(ID,'SELECTED B1_E x 1.E-12'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(brillCE(2,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                ID=ICFRB2E
                call hbook1m(ID,'SELECTED B2_E x 1.E-12'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(brillCE(3,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                ID=ICFRB3E
                call hbook1m(ID,'SELECTED B3_E x 1.E-12'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(brillCE(4,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ENDIF !IEFOLD

              IF (IFOLD.EQ.2) THEN

                ID=ICFRB0F
                call hbook1m(ID,'SELECTED B0 x 1.E-12 (FOLDED)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(brillCF(1,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

                ID=ICFRB1F
                call hbook1m(ID,'SELECTED B1 x 1.E-12 (FOLDED)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(brillCF(2,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

                ID=ICFRB2F
                call hbook1m(ID,'SELECTED B2 x 1.E-12 (FOLDED)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(brillCF(3,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

                ID=ICFRB3F
                call hbook1m(ID,'SELECTED B3 x 1.E-12 (FOLDED)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(brillCF(4,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

                IF (IEFOLD.NE.0) THEN

                  ID=ICFRB0EF
                  call hbook1m(ID,'SELECTED B0_E x 1.E-12 (FOLDED)'
     &              ,NFREQ,FLOW,FHIG,VMX)
                  DO ifrq=1,NFREQ,IHFREQ
                    CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &                dble(brillCEF(1,ifrq)*1.0d-12))
                  ENDDO   !NFREQ
                  CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                  ID=ICFRB1EF
                  call hbook1m(ID,'SELECTED B1_E x 1.E-12 (FOLDED)'
     &              ,NFREQ,FLOW,FHIG,VMX)
                  DO ifrq=1,NFREQ,IHFREQ
                    CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &                dble(brillCEF(2,ifrq)*1.0d-12))
                  ENDDO   !NFREQ
                  CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                  ID=ICFRB2EF
                  call hbook1m(ID,'SELECTED B2_E x 1.E-12 (FOLDED)'
     &              ,NFREQ,FLOW,FHIG,VMX)
                  DO ifrq=1,NFREQ,IHFREQ
                    CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &                dble(brillCEF(3,ifrq)*1.0d-12))
                  ENDDO   !NFREQ
                  CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                  ID=ICFRB3EF
                  call hbook1m(ID,'SELECTED B3_E x 1.E-12 (FOLDED)'
     &              ,NFREQ,FLOW,FHIG,VMX)
                  DO ifrq=1,NFREQ,IHFREQ
                    CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &                dble(brillCEF(4,ifrq)*1.0d-12))
                  ENDDO   !NFREQ
                  CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                ENDIF !IEFOLD
              ENDIF !IFOLD.NE.2

            ENDIF !IBRILL

          ENDIF !ISTOKES

        ELSE  !IPIN

          ID=IDFREQ
          MFREQ=NINT((FHIG-FLOW)/DF)
          call hbook1m(ID,'PHOTON FLUX THROUGH PINHOLE',
     &      MFREQ,FLOW,FHIG,VMX)
          DO ifrq=1,NFREQ,IHFREQ
            CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,WFLUXT(ifrq))
          ENDDO   !NFREQ
          CALL MHROUT(ID,ICYCLE,' ')
          call hdeletm(ID)

          IF (IFOLD.NE.0) THEN
            ID=IDFREQF
            MFREQ=NINT((FHIG-FLOW)/DF)
            call hbook1m(ID,'PHOTON FLUX (pinhole, folded)',
     &        MFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,WFLUXTF(ifrq))
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
            call hdeletm(ID)
          ENDIF   !IFOLD

        ENDIF !IPIN

      ELSE  !ifreq2P

        DF=FREQ(2)-FREQ(1)
        FLOW=FREQ(1)-DF/2.
        FHIG=FREQ(NFREQ)+DF/2.

        if (ifreq2p.eq.1.or.freqlow.eq.freqhig) then
          DF=freqhig-freqlow
          FLOW=freqlow-DF/2.
          FHIG=freqlow+DF/2.
        else if (ifreq2p.eq.-1) then
          FLOW=freqlow
          FHIG=freqhig
        endif

        IF (FLOW.LT.0.) THEN
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'*** WARNING SR HFREQ ***'
          WRITE(LUNGFO,*)'LOW EDGE OF HISTOGRAM NEGATIVE'
          WRITE(LUNGFO,*)
     &      'BE CAREFUL IF X-AXIS IS PLOTTED WITH LOGARITHMIC SCALE'
          WRITE(LUNGFO,*)
        ENDIF

        IF(IPIN.EQ.0) THEN

          DO IOBSV=1,NOBSV

            ID=ICFREQ+IOBSV
            call hbook1m(ID,'PHOTON FLUX DENSITY x 1.E-6 ',NFREQ,FLOW,FHIG,VMX)

            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          specTOT(IOBSV+NOBSV*(ifrq-1))*1.0d-6)
            ENDDO   !NFREQ

            CALL MHROUT(ID,ICYCLE,' ')
            CALL hdeletm(ID)

          IF (IFOLD.EQ.2) THEN

              ID=ICFREQ+1000+IOBSV
              call hbook1m(ID,
     &'PHOTON FLUX DENSITY x 1.E-6 (FOLDED)',NFREQ,FLOW,FHIG,VMX)

              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          specTOTF(IOBSV+NOBSV*(ifrq-1))*1.0d-6)
              ENDDO   !NFREQ

              CALL MHROUT(ID,ICYCLE,' ')
              CALL hdeletm(ID)

          ENDIF !IFOLD.EQ.2

          ENDDO !IOBSV

          IF (ISTOKES.NE.0) THEN

            ID=ICFRS0
            call hbook1m(ID,'S0 (sel. obs. point) x 1.E-6 '
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(stokES(1,1+NOBSV*(ifrq-1))*1.0d-6))
            ENDDO   !NFREQ

            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRS1
            call hbook1m(ID,'S1 (sel. obs. point) x 1.E-6 '
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(stokES(2,1+NOBSV*(ifrq-1))*1.0d-6))
            ENDDO   !NFREQ

            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRS2
            call hbook1m(ID,'S2 (sel. obs. point) x 1.E-6 '
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(stokES(3,1+NOBSV*(ifrq-1))*1.0d-6))
            ENDDO   !NFREQ

            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRS3
            call hbook1m(ID,'S3 (sel. obs. point) x 1.E-6 '
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(stokES(4,1+NOBSV*(ifrq-1))*1.0d-6))
            ENDDO   !NFREQ

            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRP
            call hbook1m(ID,'P (sel. obs. point)'
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=SQRT
     &          ((STOKES(2,IOBFR)/STOKES(1,IOBFR))**2
     &          +(STOKES(3,IOBFR)/STOKES(1,IOBFR))**2
     &         +(STOKES(4,IOBFR)/STOKES(1,IOBFR))**2)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRP1
            call hbook1m(ID,'P1 (sel. obs. point)'
     &                    ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=STOKES(2,IOBFR)/STOKES(1,IOBFR)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRP2
            call hbook1m(ID,'P2 (sel. obs. point)'
     &                    ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=STOKES(3,IOBFR)/STOKES(1,IOBFR)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRP3
            call hbook1m(ID,'P3 (sel. obs. point)'
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=STOKES(4,IOBFR)/STOKES(1,IOBFR)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRP23
            call hbook1m(ID,'P23 (sel. obs. point)'
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=SQRT((STOKES(3,IOBFR)/STOKES(1,IOBFR))**2
     &          +(STOKES(4,IOBFR)/STOKES(1,IOBFR))**2)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRG3
            call hbook1m(ID,'G3 (sel. obs. point) x 1.E-6 '
     &                    ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=STOKES(4,IOBFR)/STOKES(1,IOBFR)*STOKES(4,IOBFR)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight*1.0d-6)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=ICFRG23
            call hbook1m(ID,'G23 (sel. obs. point) x 1.E-6 '
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IOBFR=1+NOBSV*(ifrq-1)
              IF (STOKES(1,IOBFR).NE.0.0)
     &          WEIGHT=((STOKES(3,IOBFR)/STOKES(1,IOBFR))**2
     &          +(STOKES(4,IOBFR)/STOKES(1,IOBFR))**2)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight*1.0d-6)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            IF (IEFOLD.NE.0) THEN

              ID=ICFRS0E
              call hbook1m(ID,'S0_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(WSTOKESE(1,ifrq)*1.0d-6))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRS1E
              call hbook1m(ID,'S1_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(wstokESE(2,ifrq)*1.0d-6))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRS2E
              call hbook1m(ID,'S2_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(wstokESE(3,ifrq)*1.0d-6))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRS3E
              call hbook1m(ID,'S3_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(wstokESE(4,ifrq)*1.0d-6))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRPE
              call hbook1m(ID,'P_E (sel. obs. point)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=SQRT
     &            ((WSTOKESE(2,ifrq)/WSTOKESE(1,ifrq))**2
     &            +(WSTOKESE(3,ifrq)/WSTOKESE(1,ifrq))**2
     &            +(WSTOKESE(4,ifrq)/WSTOKESE(1,ifrq))**2)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRP1E
              call hbook1m(ID,'P1_E (sel. obs. point)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(2,ifrq)/WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRP2E
              call hbook1m(ID,'P2_E (sel. obs. point)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(3,ifrq)/WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRP3E
              call hbook1m(ID,'P3_E (sel. obs. point)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(4,ifrq)/WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRP23E
              call hbook1m(ID,'P23_E (sel. obs. point)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=SQRT(
     &            (WSTOKESE(3,ifrq)/WSTOKESE(1,ifrq))**2
     &            +(WSTOKESE(4,ifrq)/WSTOKESE(1,ifrq))**2)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRG3E
              call hbook1m(ID,'G3_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(4,ifrq)/WSTOKESE(1,ifrq)*WSTOKESE(4,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight*1.0d-6)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=ICFRG23E
              call hbook1m(ID,'G23_E (sel. obs. point) x 1.E-6 '
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(3,ifrq)/WSTOKESE(1,ifrq)*WSTOKESE(3,ifrq)
     &            +WSTOKESE(4,ifrq)/WSTOKESE(1,ifrq)*WSTOKESE(4,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight*1.0d-6)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

            ENDIF !IEFOLD

            IF (IBRILL.NE.0) THEN

              ID=ICFRB0
              call hbook1m(ID,'SELECTED B0 x 1.E-12'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(brillC(1,ifrq)*1.0d-12))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

              ID=ICFRB1
              call hbook1m(ID,'SELECTED B1 x 1.E-12'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(brillC(2,ifrq)*1.0d-12))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

              ID=ICFRB2
              call hbook1m(ID,'SELECTED B2 x 1.E-12'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(brillC(3,ifrq)*1.0d-12))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

              ID=ICFRB3
              call hbook1m(ID,'SELECTED B3 x 1.E-12'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(brillC(4,ifrq)*1.0d-12))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

              IF (IEFOLD.NE.0) THEN

                ID=ICFRB0E
                call hbook1m(ID,'SELECTED B0_E x 1.E-12'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(brillCE(1,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                ID=ICFRB1E
                call hbook1m(ID,'SELECTED B1_E x 1.E-12'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(brillCE(2,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                ID=ICFRB2E
                call hbook1m(ID,'SELECTED B2_E x 1.E-12'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(BRILLCE(3,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                ID=ICFRB3E
                call hbook1m(ID,'SELECTED B3_E x 1.E-12'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(BRILLCE(4,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ENDIF !IEFOLD

              IF (IFOLD.EQ.2) THEN

                ID=ICFRB0F
                call hbook1m(ID,'SELECTED B0 x 1.E-12 (FOLDED)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(BRILLCF(1,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

                ID=ICFRB1F
                call hbook1m(ID,'SELECTED B1 x 1.E-12 (FOLDED)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(BRILLCF(2,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

                ID=ICFRB2F
                call hbook1m(ID,'SELECTED B2 x 1.E-12 (FOLDED)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(BRILLCF(3,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

                ID=ICFRB3F
                call hbook1m(ID,'SELECTED B3 x 1.E-12 (FOLDED)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(BRILLCF(4,ifrq)*1.0d-12))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

                IF (IEFOLD.NE.0) THEN

                  ID=ICFRB0EF
                  call hbook1m(ID,'SELECTED B0_E x 1.E-12 (FOLDED)'
     &              ,NFREQ,FLOW,FHIG,VMX)
                  DO ifrq=1,NFREQ,IHFREQ
                    CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &                dble(BRILLCEF(1,ifrq)*1.0d-12))
                  ENDDO   !NFREQ
                  CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                  ID=ICFRB1EF
                  call hbook1m(ID,'SELECTED B1_E x 1.E-12 (FOLDED)'
     &              ,NFREQ,FLOW,FHIG,VMX)
                  DO ifrq=1,NFREQ,IHFREQ
                    CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &                dble(BRILLCEF(2,ifrq)*1.0d-12))
                  ENDDO   !NFREQ
                  CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                  ID=ICFRB2EF
                  call hbook1m(ID,'SELECTED B2_E x 1.E-12 (FOLDED)'
     &              ,NFREQ,FLOW,FHIG,VMX)
                  DO ifrq=1,NFREQ,IHFREQ
                    CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &                dble(BRILLCEF(3,ifrq)*1.0d-12))
                  ENDDO   !NFREQ
                  CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                  ID=ICFRB3EF
                  call hbook1m(ID,'SELECTED B3_E x 1.E-12 (FOLDED)'
     &              ,NFREQ,FLOW,FHIG,VMX)
                  DO ifrq=1,NFREQ,IHFREQ
                    CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &                dble(BRILLCEF(4,ifrq)*1.0d-12))
                  ENDDO   !NFREQ
                  CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

                ENDIF !IEFOLD
              ENDIF !IFOLD.NE.2

            ENDIF !IBRILL

          ENDIF !ISTOKES

        ELSE  !IPIN

          ID=IDFREQ
          call hbook1m(ID,'PHOTON FLUX (pinhole)',NFREQ,FLOW,FHIG,VMX)
          DO ifrq=1,NFREQ,IHFREQ
            CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,WFLUXT(ifrq))
          ENDDO   !NFREQ
          CALL MHROUT(ID,ICYCLE,' ')
         call hdeletm(ID)

          IF (IFOLD.NE.0) THEN
            ID=IDFREQF
            call hbook1m(ID,'PHOTON FLUX (pinhole, folded)'
     &        ,NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,WFLUXTF(ifrq))
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)
          ENDIF   !IFOLD

          IF (NSOURCE.GT.10) THEN
            JSOURCE=10
            WRITE(6,*)
            WRITE(6,*)'--- Information from HFREQ: More than 10 sources.'
            WRITE(6,*)'--- Generating flux histograms for every 10th source only'
            WRITE(6,*)
            WRITE(lungfo,*)
            WRITE(lungfo,*)'--- Information from HFREQ: More than 10 sources.'
            WRITE(lungfo,*)'--- Generating flux histograms for every 10th source only'
            WRITE(lungfo,*)
          else
            jsource=1
          ENDIF

          DO ISOUR=1,NSOURCE,JSOURCE

            ID=IDFREQ+200000+ISOUR
            call hbook1m(ID,'PHOTON FLUX (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          WFLUX( ISOUR+NSOURCE*(ifrq-1)))
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
         call hdeletm(ID)

            IF (IFOLD.NE.0) THEN
              ID=IDFREQF+200000+ISOUR
              call hbook1m(ID,'PHOTON FLUX (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            WFLUXF(ISOUR+NSOURCE*(ifrq-1)))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)
            ENDIF   !IFOLD

          ENDDO !ISOURCE

          IF (ISTOKES.NE.0) THEN

            ID=IDFRS0
            call hbook1m(ID,'S0 (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(WSTOKES(1,ifrq)))
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=IDFRS1
            call hbook1m(ID,'S1 (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(WSTOKES(2,ifrq)))
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=IDFRS2
            call hbook1m(ID,'S2 (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(WSTOKES(3,ifrq)))
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=IDFRS3
            call hbook1m(ID,'S3 (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &          dble(WSTOKES(4,ifrq)))
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=IDFRP
            call hbook1m(ID,'P (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IF (WSTOKES(1,ifrq).NE.0.0)
     &          WEIGHT=SQRT
     &          (WSTOKES(2,ifrq)**2+WSTOKES(3,ifrq)**2
     &          +WSTOKES(4,ifrq)**2)
     &          /WSTOKES(1,ifrq)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=IDFRP1
            call hbook1m(ID,'P1 (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IF (WSTOKES(1,ifrq).NE.0.0)
     &          WEIGHT=WSTOKES(2,ifrq)/WSTOKES(1,ifrq)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=IDFRP2
            call hbook1m(ID,'P2 (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IF (WSTOKES(1,ifrq).NE.0.0)
     &          WEIGHT=WSTOKES(3,ifrq)/WSTOKES(1,ifrq)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=IDFRP3
            call hbook1m(ID,'P3 (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IF (WSTOKES(1,ifrq).NE.0.0)
     &          WEIGHT=WSTOKES(4,ifrq)/WSTOKES(1,ifrq)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=IDFRP23
            call hbook1m(ID,'P23 (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IF (WSTOKES(1,ifrq).NE.0.0)
     &          WEIGHT=SQRT
     &          (WSTOKES(3,ifrq)**2+WSTOKES(4,ifrq)**2)
     &          /WSTOKES(1,ifrq)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=IDFRG3
            call hbook1m(ID,'G3 (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IF (WSTOKES(1,ifrq).NE.0.0)
     &          WEIGHT=WSTOKES(4,ifrq)**2/WSTOKES(1,ifrq)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            ID=IDFRG23
            call hbook1m(ID,'G23 (pinhole)',NFREQ,FLOW,FHIG,VMX)
            DO ifrq=1,NFREQ,IHFREQ
              WEIGHT=0.0
              IF (WSTOKES(1,ifrq).NE.0.0)
     &          WEIGHT=
     &          (WSTOKES(3,ifrq)**2+WSTOKES(4,ifrq)**2)
     &          /WSTOKES(1,ifrq)
              CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
            ENDDO   !NFREQ
            CALL MHROUT(ID,ICYCLE,' ')
             call hdeletm(ID)

            IF (IFOLD.NE.0) THEN

              ID=IDFRS0F
              call hbook1m(ID,'S0 (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(WSTOKESF(1,ifrq)))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRS1F
              call hbook1m(ID,'S1  (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(WSTOKESF(2,ifrq)))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRS2F
              call hbook1m(ID,'S2 (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(WSTOKESF(3,ifrq)))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRS3F
              call hbook1m(ID,'S3 (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(WSTOKESF(4,ifrq)))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRPF
              call hbook1m(ID,'P (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESF(1,ifrq).NE.0.0)
     &            WEIGHT=SQRT
     &            (WSTOKESF(2,ifrq)**2+WSTOKESF(3,ifrq)**2
     &            +WSTOKESF(4,ifrq)**2)
     &            /WSTOKESF(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRP1F
              call hbook1m(ID,'P1 (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESF(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESF(2,ifrq)/WSTOKESF(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRP2F
              call hbook1m(ID,'P2 (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESF(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESF(3,ifrq)/WSTOKESF(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRP3F
              call hbook1m(ID,'P3 (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESF(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESF(4,ifrq)/WSTOKESF(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRP23F
              call hbook1m(ID,'P23 (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESF(1,ifrq).NE.0.0)
     &            WEIGHT=SQRT
     &            (WSTOKESF(3,ifrq)**2+WSTOKESF(4,ifrq)**2)
     &            /WSTOKESF(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRG3F
              call hbook1m(ID,'G3 (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESF(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESF(4,ifrq)**2/WSTOKESF(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRG23F
              call hbook1m(ID,'G23 (pinhole, folded)'
     &          ,NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESF(1,ifrq).NE.0.0)
     &            WEIGHT=(WSTOKESF(3,ifrq)**2+WSTOKESF(4,ifrq)**2)
     &            /WSTOKESF(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

            ENDIF   !IFOLD

            IF (IEFOLD.NE.0) THEN

              ID=IDFRS0E
              call hbook1m(ID,'S0_E (pinhole)',NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(WSTOKESE(1,ifrq)))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRS1E
              call hbook1m(ID,'S1_E (pinhole)',NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(WSTOKESE(2,ifrq)))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRS2E
              call hbook1m(ID,'S2_E (pinhole)',NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(WSTOKESE(3,ifrq)))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRS3E
              call hbook1m(ID,'S3_E (pinhole)',NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &            dble(WSTOKESE(4,ifrq)))
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRPE
              call hbook1m(ID,'P_E (pinhole)',NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=SQRT
     &            (WSTOKESE(2,ifrq)**2+WSTOKESE(3,ifrq)**2
     &            +WSTOKESE(4,ifrq)**2)
     &            /WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRP1E
              call hbook1m(ID,'P1_E (pinhole)',NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(2,ifrq)/WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRP2E
              call hbook1m(ID,'P2_E (pinhole)',NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(3,ifrq)/WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRP3E
              call hbook1m(ID,'P3_E (pinhole)',NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(4,ifrq)/WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRP23E
              call hbook1m(ID,'P23_E (pinhole)',NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=SQRT
     &            (WSTOKESE(3,ifrq)**2+WSTOKESE(4,ifrq)**2)
     &            /WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRG3E
              call hbook1m(ID,'G3_E (pinhole)',NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=WSTOKESE(4,ifrq)**2/WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              ID=IDFRG23E
              call hbook1m(ID,'G23_E (pinhole)',NFREQ,FLOW,FHIG,VMX)
              DO ifrq=1,NFREQ,IHFREQ
                WEIGHT=0.0
                IF (WSTOKESE(1,ifrq).NE.0.0)
     &            WEIGHT=
     &            (WSTOKESE(3,ifrq)**2+WSTOKESE(4,ifrq)**2)
     &            /WSTOKESE(1,ifrq)
                CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
              ENDDO   !NFREQ
              CALL MHROUT(ID,ICYCLE,' ')
               call hdeletm(ID)

              IF (IFOLD.NE.0) THEN

                ID=IDFRS0EF
                call hbook1m(ID,'S0_E (pinhole, folded)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(WSTOKESEF(1,ifrq)))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
                 call hdeletm(ID)

                ID=IDFRS1EF
                call hbook1m(ID,'S1_E  (pinhole, folded)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(WSTOKESEF(2,ifrq)))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
                 call hdeletm(ID)

                ID=IDFRS2EF
                call hbook1m(ID,'S2_E (pinhole, folded)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(WSTOKESEF(3,ifrq)))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
                 call hdeletm(ID)

                ID=IDFRS3EF
                call hbook1m(ID,'S3_E (pinhole, folded)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,
     &              dble(WSTOKESEF(4,ifrq)))
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
                 call hdeletm(ID)

                ID=IDFRPEF
                call hbook1m(ID,'P_E (pinhole, folded)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  WEIGHT=0.0
                  IF (WSTOKESEF(1,ifrq).NE.0.0)
     &              WEIGHT=SQRT
     &              (WSTOKESEF(2,ifrq)**2+WSTOKESEF(3,ifrq)**2
     &              +WSTOKESEF(4,ifrq)**2)
     &              /WSTOKESEF(1,ifrq)
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
                 call hdeletm(ID)

                ID=IDFRP1EF
                call hbook1m(ID,'P1_E (pinhole, folded)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  WEIGHT=0.0
                  IF (WSTOKESEF(1,ifrq).NE.0.0)
     &              WEIGHT=WSTOKESEF(2,ifrq)/WSTOKESEF(1,ifrq)
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
                 call hdeletm(ID)


                ID=IDFRP2EF
                call hbook1m(ID,'P2_E (pinhole, folded)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  WEIGHT=0.0
                  IF (WSTOKESEF(1,ifrq).NE.0.0)
     &              WEIGHT=WSTOKESEF(3,ifrq)/WSTOKESEF(1,ifrq)
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
                 call hdeletm(ID)

                ID=IDFRP3EF
                call hbook1m(ID,'P3_E (pinhole, folded)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  WEIGHT=0.0
                  IF (WSTOKESEF(1,ifrq).NE.0.0)
     &              WEIGHT=WSTOKESEF(4,ifrq)/WSTOKESEF(1,ifrq)
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
                 call hdeletm(ID)

                ID=IDFRP23EF
                call hbook1m(ID,'P23_E (pinhole, folded)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  WEIGHT=0.0
                  IF (WSTOKESEF(1,ifrq).NE.0.0)
     &              WEIGHT=SQRT
     &              (WSTOKESEF(3,ifrq)**2+WSTOKESEF(4,ifrq)**2)
     &              /WSTOKESEF(1,ifrq)
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
                 call hdeletm(ID)

                ID=IDFRG3EF
                call hbook1m(ID,'G3_E (pinhole, folded)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  WEIGHT=0.0
                  IF (WSTOKESEF(1,ifrq).NE.0.0)
     &              WEIGHT=WSTOKESEF(4,ifrq)**2/WSTOKESEF(1,ifrq)
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
                 call hdeletm(ID)

                ID=IDFRG23EF
                call hbook1m(ID,'G23_E (pinhole, folded)'
     &            ,NFREQ,FLOW,FHIG,VMX)
                DO ifrq=1,NFREQ,IHFREQ
                  WEIGHT=0.0
                  IF (WSTOKESEF(1,ifrq).NE.0.0)
     &              WEIGHT=(WSTOKESEF(3,ifrq)**2+WSTOKESEF(4,ifrq)**2)
     &              /WSTOKESEF(1,ifrq)
                  CALL hfillm(ID,SNGL(FREQ(ifrq)),0.,weight)
                ENDDO   !NFREQ
                CALL MHROUT(ID,ICYCLE,' ')
                 call hdeletm(ID)

              ENDIF   !IFOLD

            ENDIF   !IEFOLD

          ENDIF   !ISTOKES

        ENDIF !IPIN

      ENDIF !ifreq2P

C--- NTUPLE

100   CONTINUE

      CALL HFREQC

      IF (IPIN.NE.0) THEN
        DO IOBSV=1,NOBSV
          FILL(IOBSV)=0.0d0
        ENDDO
        TIT='DIST. IN PINHOLE'
        CALL HSPEC2(IDSPEC,TIT)
        TIT='HORIZ. CUT OF DIST. IN PINH.'
        CALL HSPEC1(IDSPEC-1,TIT,1)
        TIT='VERT. CUT OF DIST. IN PINH.'
        CALL HSPEC1(IDSPEC-2,TIT,2)
        IF (IPHASE.NE.0) THEN
          TIT='DIST. IN SOURCE PLANE'
          CALL HPHASE2(IDPHASE,TIT,PHFILL)
        ENDIF
      ENDIF

      IF (I47.EQ.1) THEN

        if (iroottrees.ge.0) then
          CALL hcdirm(OLDDIR,'R')
        endif

        FILE47='3700_'//FILEHB(1:123)

        if (iroottrees.ge.0) then
          CALL hropenm(47,'SPEC',FILE47,'NQ',1024,ISTAT)
          CALL hcdirm('//SPEC',' ')
        endif

        CALL MHROUT(IDCODE,ICYCLE,' ')

        CALL MHROUT(ICFREQ,ICYCLE,' ')

        CALL MHROUT(IDFREQ,ICYCLE,' ')

        CALL MHROUT(IDSPEC,ICYCLE,' ')
        CALL MHROUT(IDSPEC-1,ICYCLE,' ')
        CALL MHROUT(IDSPEC-2,ICYCLE,' ')
        call hdeletm(idspec)
        call hdeletm(idspec-1)
        call hdeletm(idspec-2)

        CALL hbookm(NIDSPEC,'ARRAYS SPECT, REAIMA',31
     &    ,'//SPEC',nobsv*nfreq*nsource,CHSPEC)
        if (mpinr.ne.0) then
          CALL hbookm(NIDSPECRPHI,'ARRAYS SPECT AND SPECPOW, REAIMARPHI',33
     &      ,'//SPEC',nobsv*nfreq*nsource,CHSPECRPHI)
        endif
      ELSE !I47

          CALL hbookm(NIDSPEC,'ARRAYS SPECT, REAIMA',31
     &    ,'//WAVE',nobsv*nfreq*nsource,CHSPEC)
        if (mpinr.ne.0) then
          CALL hbookm(NIDSPECRPHI,'ARRAYS SPECT, REAIMARPHI',33
     &      ,'//WAVE',nobsv*nfreq*nsource,CHSPECRPHI)
          endif

       ENDIF !I47

      smax=0.0d0
      do ifrq=1,nfreq
        DO iobsv=1,nobsv
          iobfr=iobsv+nobsv*(ifrq-1)
          if (spec(iobfr).gt.smax) then
            smax=spec(iobfr)
            reanor=
     &        reaima(1,1,iobfr)**2+reaima(1,2,iobfr)**2+
     &        reaima(2,1,iobfr)**2+reaima(2,2,iobfr)**2+
     &        reaima(3,1,iobfr)**2+reaima(3,2,iobfr)**2
          endif
        enddo
      enddo

      reanor=sqrt(smax/reanor)

      DO ISOUR=1,NSOURCE

        if (ispecdip.le.0) then
          censoux=(min(sourceeo(1,1,isour),xiend)
     &      +max(sourceao(1,1,isour),xianf))/2.d0
          censouy=sourceeo(2,1,isour)
          censouz=sourceeo(3,1,isour)
        else
          censoux=x0dip(isour)
          censouy=y0dip(isour)
          censouz=z0dip(isour)
        endif

        dist0=sqrt(
     &    ((pincen(3)-censouz)**2+
     &    (pincen(2)-censouy)**2)+
     &    (pincen(1)-censoux)**2)

        DO IOBSV=1,NOBSV

          IF (IPIN.NE.0) THEN
            IOBSVY=(IOBSV-1)/NOBSVZ+1
            IOBSVZ=IOBSV-NOBSVZ*(IOBSVY-1)
          ELSE
            IOBSVY=0
            IOBSVZ=0
          ENDIF
          DO ifrq=1,NFREQ,IHFREQ
            FSPEC(1)=ISOUR
            FSPEC(2)=IOBSV
            FSPEC(3)=OBSV(1,IOBSV)
            FSPEC(4)=OBSV(2,IOBSV)
            FSPEC(5)=OBSV(3,IOBSV)
            FSPEC(6)=FREQ(ifrq)
            FSPEC(7)=SPEC(ISOUR+NSOURCE*(IOBSV-1+NOBSV*(ifrq-1)))
            FSPEC(8)=IOBSVZ
            FSPEC(9)=IOBSVY
            FSPEC(10)=ifrq
            IOBFR=IOBSV+NOBSV*(ifrq-1)
c            IF (ISPECMODE.EQ.3) THEN
              FSPEC(11)=reanor*reaIMA(1,1,IOBFR)
              FSPEC(12)=reanor*reaIMA(1,2,IOBFR)
              FSPEC(13)=reanor*reaIMA(2,1,IOBFR)
              FSPEC(14)=reanor*reaIMA(2,2,IOBFR)
              FSPEC(15)=reanor*reaIMA(3,1,IOBFR)
              FSPEC(16)=reanor*reaIMA(3,2,IOBFR)
              FSPEC(17)=reanor*reaIMA(4,1,IOBFR)
              FSPEC(18)=reanor*reaIMA(4,2,IOBFR)
              FSPEC(19)=reanor*reaIMA(5,1,IOBFR)
              FSPEC(20)=reanor*reaIMA(5,2,IOBFR)
              FSPEC(21)=reanor*reaIMA(6,1,IOBFR)
              FSPEC(22)=reanor*reaIMA(6,2,IOBFR)
              FSPEC(23)=reanor*reaIMA(7,1,IOBFR)
              FSPEC(24)=reanor*reaIMA(7,2,IOBFR)
              FSPEC(25)=reanor*reaIMA(8,1,IOBFR)
              FSPEC(26)=reanor*reaIMA(8,2,IOBFR)
              FSPEC(27)=reanor*reaIMA(9,1,IOBFR)
              FSPEC(28)=reanor*reaIMA(9,2,IOBFR)
              FSPEC(29)=reanor*reaIMA(10,1,IOBFR)
              FSPEC(30)=reanor*reaIMA(10,2,IOBFR)

              dist=sqrt(
     &          ((obsv(3,iobsv)-censouz)**2+
     &          (obsv(2,iobsv)-censouy)**2)+
     &          (obsv(1,iobsv)-censoux)**2)

              ddist=dist-dist0

              wlen=clight1*hbarev1*twopi1/freq(ifrq)
              waves=ddist/wlen
              dphase=waves*twopi1

              FSPEC(31)=dphase

              CALL hfm(NIDSPEC,FSPEC)

          ENDDO   !NFREQ
        ENDDO   !IOBSV
      ENDDO   !ISOUR

      IF (MPINR.NE.0) THEN
        DO ISOUR=1,NSOURCE
          DO IOBSV=1,NOBSVRPHI
            IF (IPIN.NE.0) THEN
              IOBSVPHI=(IOBSV-1)/NOBSVR+1
              IOBSVR=IOBSV-NOBSVR*(IOBSVPHI-1)
            ELSE
              IOBSVR=0
              IOBSVPHI=0
            ENDIF
            DO ifrq=1,NFREQ,IHFREQ
              FSPEC(1)=ISOUR
              FSPEC(2)=IOBSV
              FSPEC(3)=OBSVRPHI(1,IOBSV)
              FSPEC(4)=OBSVRPHI(2,IOBSV)*SIN(OBSVRPHI(3,IOBSV))
              FSPEC(5)=OBSVRPHI(2,IOBSV)*COS(OBSVRPHI(3,IOBSV))
              FSPEC(6)=OBSVRPHI(2,IOBSV)
              FSPEC(7)=OBSVRPHI(3,IOBSV)
              FSPEC(8)=FREQ(ifrq)
              FSPEC(9)=SPECRPHI(ISOUR+NSOURCE*(IOBSV-1+NOBSVRPHI*(ifrq-1)))
              FSPEC(10)=IOBSVR
              FSPEC(11)=IOBSVPHI
              FSPEC(12)=ifrq
              IOBFR=IOBSV+NOBSVRPHI*(ifrq-1)
              FSPEC(13)=reanor*reaIMARPHI(1,1,IOBFR)
              FSPEC(14)=reanor*reaIMARPHI(1,2,IOBFR)
              FSPEC(15)=reanor*reaIMARPHI(2,1,IOBFR)
              FSPEC(16)=reanor*reaIMARPHI(2,2,IOBFR)
              FSPEC(17)=reanor*reaIMARPHI(3,1,IOBFR)
              FSPEC(18)=reanor*reaIMARPHI(3,2,IOBFR)
              FSPEC(19)=reanor*reaIMARPHI(4,1,IOBFR)
              FSPEC(20)=reanor*reaIMARPHI(4,2,IOBFR)
              FSPEC(21)=reanor*reaIMARPHI(5,1,IOBFR)
              FSPEC(22)=reanor*reaIMARPHI(5,2,IOBFR)

              FSPEC(23)=reanor*reaIMARPHI(6,1,IOBFR)
              FSPEC(24)=reanor*reaIMARPHI(6,2,IOBFR)
              FSPEC(25)=reanor*reaIMARPHI(7,1,IOBFR)
              FSPEC(26)=reanor*reaIMARPHI(7,2,IOBFR)
              FSPEC(27)=reanor*reaIMARPHI(8,1,IOBFR)
              FSPEC(28)=reanor*reaIMARPHI(8,2,IOBFR)
              FSPEC(29)=reanor*reaIMARPHI(9,1,IOBFR)
              FSPEC(30)=reanor*reaIMARPHI(9,2,IOBFR)
              FSPEC(31)=reanor*reaIMARPHI(10,1,IOBFR)
              FSPEC(32)=reanor*reaIMARPHI(10,2,IOBFR)

              h2=(obsvr(iobsvr)/dist0)**2

              if (h2.lt.0.01) then
                ddist=dist0*(h2/2.0d0-h2**2/8.0d0)
              else
                ddist=dist0*(sqrt(h2)-1.0d0)
              endif

              dphase=ddist/freq(ifrq)*wtoe1*1.0d9*twopi1

              FSPEC(33)=dphase

              CALL hfm(NIDSPECRPHI,FSPEC)

            ENDDO   !NFREQ
          ENDDO   !IOBSV
        ENDDO   !ISOUR
      ENDIF !MPINR

      IF (I47.EQ.1) THEN

        CALL MHROUT(NIDSPEC,ICYCLE,' ')
        if (mpinr.ne.0) then
          CALL MHROUT(NIDSPECRPHI,ICYCLE,' ')
        endif

        if (iroottrees.ge.0) then
          CALL hrendm('SPEC')
        endif
        CLOSE(47)

        if (iroottrees.ge.0) then
          CALL hcdirm(OLDDIR,' ')
        endif

      ENDIF !I47

      CALL hbookm(NIDSPEC+2,'BRILLIANCE',17
     &  ,'//WAVE',nobsv*nfreq*nsource,CHBRILL)

C BRILLIANCE
      DO ifrq=1,NFREQ,IHFREQ
        FSPEC(1)=FREQ(ifrq)
        DO I=2,16
          FSPEC(I)=0.
        ENDDO
        IF (IBRILL.NE.0) THEN
          FSPEC(2)=BRILLC(1,ifrq)
          FSPEC(3)=BRILLC(2,ifrq)
          FSPEC(4)=BRILLC(3,ifrq)
          FSPEC(5)=BRILLC(4,ifrq)
          IF (IFOLD.NE.0) THEN
            FSPEC(6)=BRILLCF(1,ifrq)
            FSPEC(7)=BRILLCF(2,ifrq)
            FSPEC(8)=BRILLCF(3,ifrq)
            FSPEC(9)=BRILLCF(4,ifrq)
          ENDIF
          IF (IEFOLD.NE.0) THEN
            FSPEC(10)= BRILLCE(1,ifrq)
            FSPEC(11)=BRILLCE(2,ifrq)
            FSPEC(12)=BRILLCE(3,ifrq)
            FSPEC(13)=BRILLCE(4,ifrq)
          ENDIF
          IF (IEFOLD.NE.0.AND.IFOLD.NE.0) THEN
            FSPEC(14)= BRILLCEF(1,ifrq)
            FSPEC(15)=BRILLCEF(2,ifrq)
            FSPEC(16)=BRILLCEF(3,ifrq)
            FSPEC(17)=BRILLCEF(4,ifrq)
          ENDIF
        ENDIF  !IBRILL
        CALL hfm(NIDSPEC+2,FSPEC)
      ENDDO   !NFREQ

      IF (ISPECINT.NE.0) THEN

        CALL hbookm(NIDPOW-1,'POWER DENSITY FROM SPECTRUM',8
     &    ,'//WAVE',nobsv*nsource,CHPOW)
        DO ISOUR=1,NSOURCE
          DO IOBSV=1,NOBSV

            IF (IPIN.NE.0) THEN
              IOBSVY=(IOBSV-1)/NOBSVZ+1
              IOBSVZ=IOBSV-NOBSVZ*(IOBSVY-1)
            ELSE
              IOBSVY=1
              IOBSVZ=1
            ENDIF

            FSPEC(1)=OBSV(1,IOBSV)
            FSPEC(2)=OBSV(2,IOBSV)
            FSPEC(3)=OBSV(3,IOBSV)
            FSPEC(4)=SPECI(ISOUR+NSOURCE*(IOBSV-1))
            FSPEC(5)=IOBSVZ
            FSPEC(6)=IOBSVY
            FSPEC(7)=IOBSV
            FSPEC(8)=ISOUR

            CALL hfm(NIDPOW-1,FSPEC)

          ENDDO   !IOBSV
        ENDDO   !ISOUR

        CALL hbookm(NIDPOW-2,'HORIZ. POWER DENSITY FROM SPECTRUM(VERT. INT.)',5
     &    ,'//WAVE',nobsv*nsource,CHPOWV)
        DO ISOUR=1,NSOURCE
          DO IOBSVZ=1,NOBSVZ

            FSPEC(1)=OBSV(1,IOBSVZ)
            FSPEC(2)=OBSV(3,IOBSVZ)
            FSPEC(3)=SPECIV(ISOUR+NSOURCE*(IOBSVZ-1))
            FSPEC(4)=IOBSVZ
            FSPEC(5)=ISOUR

            CALL hfm(NIDPOW-2,FSPEC)

          ENDDO   !IOBSV
        ENDDO   !ISOUR

        IF (IFOLD.NE.0) THEN

          CALL hbookm(NIDPOW-10,'POWER DENSITY FROM SPECTRUM (FOLDED)',8
     &      ,'//WAVE',nobsv*nsource,CHPOW)

          DO ISOUR=1,NSOURCE
            DO IOBSV=1,NOBSV

              IF (IPIN.NE.0) THEN
                IOBSVY=(IOBSV-1)/NOBSVZ+1
                IOBSVZ=IOBSV-NOBSVZ*(IOBSVY-1)
              ELSE
                IOBSVY=1
                IOBSVZ=1
              ENDIF

              FSPEC(1)=OBSV(1,IOBSV)
              FSPEC(2)=OBSV(2,IOBSV)
              FSPEC(3)=OBSV(3,IOBSV)
              FSPEC(4)=SPECIF(ISOUR+NSOURCE*(IOBSV-1))
              FSPEC(5)=IOBSVZ
              FSPEC(6)=IOBSVY
              FSPEC(7)=IOBSV
              FSPEC(8)=ISOUR
              CALL hfm(NIDPOW-10,FSPEC)

            ENDDO   !IOBSV
          ENDDO   !ISOUR

        ENDIF  !IFOLD

      ENDIF !ISPECINT

      CALL hbookm(NIDPOW,'POWER DENSITY',8
     &  ,'//WAVE',nobsv*nsource,CHPOWF)

      DO ISOUR=1,NSOURCE
        DO IOBSV=1,NOBSV

          IF (IPIN.NE.0) THEN
            IOBSVY=(IOBSV-1)/NOBSVZ+1
            IOBSVZ=IOBSV-NOBSVZ*(IOBSVY-1)
          ELSE
            IOBSVY=1
            IOBSVZ=1
          ENDIF

          FSPEC(1)=OBSV(1,IOBSV)
          FSPEC(2)=OBSV(2,IOBSV)
          FSPEC(3)=OBSV(3,IOBSV)
          FSPEC(4)=SPECPOW(ISOUR+NSOURCE*(IOBSV-1))
          if (ifold.ne.0) then
            FSPEC(5)=SPECPOWf(ISOUR+NSOURCE*(IOBSV-1))
          else
            FSPEC(5)=0.0d0
          endif
          FSPEC(6)=IOBSVZ
          FSPEC(7)=IOBSVY
          FSPEC(8)=IOBSV
          FSPEC(9)=ISOUR
          CALL hfm(NIDPOW,FSPEC)

        ENDDO   !IOBSV
      ENDDO   !ISOUR

      CALL hbookm(NIDPOW+1,'HORIZ. POWER DENSITY (VERT. INT.)',5
     &  ,'//WAVE',nobsv*nsource,CHPOWV)

      DO ISOUR=1,NSOURCE
        DO IOBSVZ=1,NOBSVZ

          FSPEC(1)=OBSV(1,IOBSVZ)
          FSPEC(2)=OBSV(3,IOBSVZ)
          FSPEC(3)=SPECPOWV(ISOUR+NSOURCE*(IOBSVZ-1))
          FSPEC(4)=IOBSVZ
          FSPEC(5)=ISOUR
          CALL hfm(NIDPOW+1,FSPEC)

        ENDDO   !IOBSV
      ENDDO   !ISOUR

      IF(IPIN.EQ.0) THEN

        ND=NIDFREQ
        CALL hbookm(ND,'PHOTON FLUX DENSITY',5,
     &    '//WAVE',nobsv*nfreq,CHTAGS)
        DO IOBSV=1,NOBSV
          DO ifrq=1,NFREQ,IHFREQ
            FSTUPLE(1)=OBSV(1,IOBSV)
            FSTUPLE(2)=OBSV(2,IOBSV)
            FSTUPLE(3)=OBSV(3,IOBSV)
            FSTUPLE(4)=FREQ(ifrq)
            FSTUPLE(5)=SPECTOT(IOBSV+NOBSV*(ifrq-1))
            CALL hfm(ND,FSTUPLE)
          ENDDO   !NFREQ
        ENDDO !IOBSV

      ELSE  !IPIN

        CALL hbookm(NIDFREQP,'PHOTON FLUX THROUGH PINHOLE',20,
     &      '//WAVE',nfreq,CHTAGSf)
          fstuple=0.0
          DO ifrq=1,NFREQ,IHFREQ
            FSTUPLE(1)=ifrq
            FSTUPLE(2)=FREQ(ifrq)
            FSTUPLE(3)=WFLUXT(ifrq)
            if (ifold.ne.0) FSTUPLE(4)=WFLUXTF(ifrq)
            if (istokes.ne.0) then
              FSTUPLE(5)=wstokes(1,ifrq)
              FSTUPLE(6)=wstokes(2,ifrq)
              FSTUPLE(7)=wstokes(3,ifrq)
              FSTUPLE(8)=wstokes(4,ifrq)
              if (ifold.ne.0) then
                FSTUPLE(9)=wstokesf(1,ifrq)
                FSTUPLE(10)=wstokesf(2,ifrq)
                FSTUPLE(11)=wstokesf(3,ifrq)
                FSTUPLE(12)=wstokesf(4,ifrq)
              endif
              if (iefold.ne.0) then
                FSTUPLE(13)=wstokese(1,ifrq)
                FSTUPLE(14)=wstokese(2,ifrq)
                FSTUPLE(15)=wstokese(3,ifrq)
                FSTUPLE(16)=wstokese(4,ifrq)
              endif
              if (ifold*iefold.ne.0) then
                FSTUPLE(17)=wstokesef(1,ifrq)
                FSTUPLE(18)=wstokesef(2,ifrq)
                FSTUPLE(19)=wstokesef(3,ifrq)
                FSTUPLE(20)=wstokesef(4,ifrq)
              endif
            endif !istokes
            CALL hfm(NIDFREQP,FSTUPLE)
          ENDDO   !NFREQ

        ENDIF !IPIN

        CALL hbookm(NIDFREQP+1,'Photon flux-density for selected point',36,
     &    '//WAVE',nfreq,CHTAGSfd)
        fstuple=0.0
        DO ifrq=1,NFREQ,IHFREQ
          FSTUPLE(1)=ifrq
          FSTUPLE(2)=FREQ(ifrq)
          FSTUPLE(3)=SPECTOT(ICBRILL+NOBSV*(ifrq-1))
          if (ifold.ne.0) FSTUPLE(4)=SPECTOTF(ICBRILL+NOBSV*(ifrq-1))
          if (istokes.ne.0) then
            FSTUPLE(5)=stokec(1,ifrq)
            FSTUPLE(6)=stokec(2,ifrq)
            FSTUPLE(7)=stokec(3,ifrq)
            FSTUPLE(8)=stokec(4,ifrq)
            if (ifold.ne.0) then
              FSTUPLE(9)=stokecf(1,ifrq)
              FSTUPLE(10)=stokecf(2,ifrq)
              FSTUPLE(11)=stokecf(3,ifrq)
              FSTUPLE(12)=stokecf(4,ifrq)
            endif
            if (iefold.ne.0) then
              FSTUPLE(13)=stokece(1,ifrq)
              FSTUPLE(14)=stokece(2,ifrq)
              FSTUPLE(15)=stokece(3,ifrq)
              FSTUPLE(16)=stokece(4,ifrq)
            endif
            if (ifold*iefold.ne.0) then
              FSTUPLE(17)=stokecef(1,ifrq)
              FSTUPLE(18)=stokecef(2,ifrq)
              FSTUPLE(19)=stokecef(3,ifrq)
              FSTUPLE(20)=stokecef(4,ifrq)
            endif
            if (ibrill.ne.0) then
              FSTUPLE(21)=brillc(1,ifrq)
              FSTUPLE(22)=brillc(2,ifrq)
              FSTUPLE(23)=brillc(3,ifrq)
              FSTUPLE(24)=brillc(4,ifrq)
              if (ifold.ne.0) then
                FSTUPLE(25)=brillcf(1,ifrq)
                FSTUPLE(26)=brillcf(2,ifrq)
                FSTUPLE(27)=brillcf(3,ifrq)
                FSTUPLE(28)=brillcf(4,ifrq)
              endif
              if (iefold.ne.0) then
                FSTUPLE(29)=brillce(1,ifrq)
                FSTUPLE(30)=brillce(2,ifrq)
                FSTUPLE(31)=brillce(3,ifrq)
                FSTUPLE(32)=brillce(4,ifrq)
              endif
              if (ifold*iefold.ne.0) then
                FSTUPLE(33)=brillcef(1,ifrq)
                FSTUPLE(34)=brillcef(2,ifrq)
                FSTUPLE(35)=brillcef(3,ifrq)
                FSTUPLE(36)=brillcef(4,ifrq)
              endif
            endif !ibrill
          endif !istokes
          CALL hfm(NIDFREQP+1,FSTUPLE)
        ENDDO   !NFREQ

        IF (IHFIL.NE.0) THEN
          chtags(2)='muph'
          CALL hbookm(NIDFIL,'PHOTON ABSORPTION COEFF. [M**2/KG]',2,
     &      '//WAVE',1000,CHTAGS)
          chtags(2)='muen'
          CALL hbookm(NIDMUEN,'ENERGY ABSORPTION COEFF. [m**2/kg]'
     &      ,2,'//WAVE',1000,CHTAGS)

          DO ifrq=1,NFREQ,IHFREQ
            FSTUPLE(1)=FREQ(ifrq)
            IF (IFILMUL.EQ.0) THEN
              FSTUPLE(2)=ABSMU(ifrq)
            ELSE
              FSTUPLE(2)=ABSMUTOT(ifrq)
            ENDIF
            CALL hfm(NIDFIL,FSTUPLE)
          ENDDO   !NFREQ

          DO ifrq=1,NFREQ,IHFREQ
            FSTUPLE(1)=FREQ(ifrq)
            FSTUPLE(2)=ABSMUEN(ifrq)
            CALL hfm(NIDMUEN,FSTUPLE)
          ENDDO   !NFREQ

        ENDIF !IHFIL

        IF (IFOLD.NE.0) THEN

          IF (I47.EQ.1) THEN

            if (iroottrees.ge.0) then
              CALL hcdirm(OLDDIR,'R')
            endif

            FILE47='3701_'//FILEHB(1:123)

            if (iroottrees.ge.0) then
              CALL hropenm(47,'SPECF',FILE47,'NQ',1024,ISTAT)
              CALL hcdirm('//SPECF',' ')
            endif

            CALL MHROUT(IDCODE,ICYCLE,' ')

            CALL MHROUT(ICFREQF,ICYCLE,' ')

            CALL MHROUT(IDFREQF,ICYCLE,' ')

            CALL MHROUT(IDSPEC,ICYCLE,' ')
            CALL MHROUT(IDSPEC-1,ICYCLE,' ')
            CALL MHROUT(IDSPEC-2,ICYCLE,' ')
            call hdeletm(idspec)
            call hdeletm(idspec-1)
            call hdeletm(idspec-2)

            CALL hbookm(NIDSPECF,'ARRAYS SPECF',18
     &        ,'//SPECF',nobsv*nfreq*nsource,CHSPECF)

          ELSE !I47

            CALL hbookm(NIDSPECF,'ARRAYS SPECF',18
     &        ,'//WAVE',nobsv*nfreq*nsource,CHSPECF)
          ENDIF !I47

          DO ISOUR=1,NSOURCE
            DO IOBSV=1,NOBSV
              IF (IPIN.NE.0) THEN
                IOBSVY=(IOBSV-1)/NOBSVZ+1
                IOBSVZ=IOBSV-NOBSVZ*(IOBSVY-1)
              ELSE
                IOBSVY=1
                IOBSVZ=1
              ENDIF
              DO ifrq=1,NFREQ,IHFREQ
                FSPEC(1)=ISOUR
                FSPEC(2)=IOBSV
                FSPEC(3)=OBSV(1,IOBSV)
                FSPEC(4)=OBSV(2,IOBSV)
                FSPEC(5)=OBSV(3,IOBSV)
                FSPEC(6)=FREQ(ifrq)
                FSPEC(7)=SPECF(ISOUR+NSOURCE*(IOBSV-1+NOBSV*(ifrq-1)))
                FSPEC(8)=IOBSVZ
                FSPEC(9)=IOBSVY
                FSPEC(10)=ifrq
                IOBFR=IOBSV+NOBSV*(ifrq-1)
                FSPEC(11)=reanor*reaIMA(4,1,IOBFR)
                FSPEC(12)=reanor*reaIMA(4,2,IOBFR)
                FSPEC(13)=reanor*reaIMA(5,1,IOBFR)
                FSPEC(14)=reanor*reaIMA(5,2,IOBFR)
                FSPEC(15)=reanor*reaIMA(6,1,IOBFR)
                FSPEC(16)=reanor*reaIMA(6,2,IOBFR)
                FSPEC(17)=reanor*reaIMA(7,1,IOBFR)
                FSPEC(18)=reanor*reaIMA(7,2,IOBFR)
                FSPEC(19)=reanor*reaIMA(8,1,IOBFR)
                FSPEC(20)=reanor*reaIMA(8,2,IOBFR)
                FSPEC(21)=reanor*reaIMA(9,1,IOBFR)
                FSPEC(22)=reanor*reaIMA(9,2,IOBFR)
                FSPEC(23)=reanor*reaIMA(10,1,IOBFR)
                FSPEC(24)=reanor*reaIMA(10,2,IOBFR)
                CALL hfm(NIDSPECF,FSPEC)
              ENDDO   !NFREQ
            ENDDO   !IOBSV
        ENDDO   !ISOUR

        IF (I47.EQ.1) THEN
          CALL MHROUT(NIDSPECF,ICYCLE,' ')
          if (iroottrees.ge.0) then
            CALL hrendm('SPECF')
          endif
          CLOSE(47)
          if (iroottrees.ge.0) then
            CALL hcdirm(OLDDIR,' ')
          endif
        ENDIF !I47

      ENDIF !IFOLD

      IF (ISTOKES.NE.0) THEN

        IF (I47.EQ.1) THEN

          if (iroottrees.ge.0) then
            CALL hcdirm(OLDDIR,'R')
          endif

          FILE47='4700_'//FILEHB(1:123)

          if (iroottrees.ge.0) then
            CALL hropenm(47,'STOKES',FILE47,'NQ',1024,ISTAT)
            CALL hcdirm('//STOKES',' ')
          endif

          CALL MHROUT(IDCODE,ICYCLE,' ')

          CALL MHROUT(ICFRS0,ICYCLE,' ')
          CALL MHROUT(ICFRS1,ICYCLE,' ')
          CALL MHROUT(ICFRS2,ICYCLE,' ')
          CALL MHROUT(ICFRS3,ICYCLE,' ')

          CALL MHROUT(ICFRP,ICYCLE,' ')
          CALL MHROUT(ICFRP1,ICYCLE,' ')
          CALL MHROUT(ICFRP2,ICYCLE,' ')
          CALL MHROUT(ICFRP3,ICYCLE,' ')
          CALL MHROUT(ICFRP23,ICYCLE,' ')

          CALL MHROUT(ICFRG3,ICYCLE,' ')
          CALL MHROUT(ICFRG23,ICYCLE,' ')

          IF (IBRILL.NE.0) THEN
            CALL MHROUT(ICFRB0,ICYCLE,' ')
            CALL MHROUT(ICFRB1,ICYCLE,' ')
            CALL MHROUT(ICFRB2,ICYCLE,' ')
            CALL MHROUT(ICFRB3,ICYCLE,' ')
          ENDIF

          CALL MHROUT(IDFRS0,ICYCLE,' ')
          CALL MHROUT(IDFRS1,ICYCLE,' ')
          CALL MHROUT(IDFRS2,ICYCLE,' ')
          CALL MHROUT(IDFRS3,ICYCLE,' ')

          CALL MHROUT(IDFRP,ICYCLE,' ')
          CALL MHROUT(IDFRP1,ICYCLE,' ')
          CALL MHROUT(IDFRP2,ICYCLE,' ')
          CALL MHROUT(IDFRP3,ICYCLE,' ')
          CALL MHROUT(IDFRP23,ICYCLE,' ')

          CALL MHROUT(IDFRG3,ICYCLE,' ')
          CALL MHROUT(IDFRG23,ICYCLE,' ')

          CALL MHROUT(IDSPEC,ICYCLE,' ')
          CALL MHROUT(IDSPEC-1,ICYCLE,' ')
          CALL MHROUT(IDSPEC-2,ICYCLE,' ')
          call hdeletm(idspec)
          call hdeletm(idspec-1)
          call hdeletm(idspec-2)

          CALL hbookm(NIDSTOK,'STOKES ARRAYS',12
     &      ,'//STOKES',nobsv*nfreq*nsource,CHSTOK)

        ELSE !I47

          CALL hbookm(NIDSTOK,'STOKES ARRAYS',12
     &      ,'//WAVE',nobsv*nfreq*nsource,CHSTOK)
        ENDIF !I47

        DO IOBSV=1,NOBSV
          IF (IPIN.NE.0) THEN
            IOBSVY=(IOBSV-1)/NOBSVZ+1
            IOBSVZ=IOBSV-NOBSVZ*(IOBSVY-1)
          ELSE
            IOBSVY=1
            IOBSVZ=1
          ENDIF
          DO ifrq=1,NFREQ,IHFREQ
            FSPEC(1)=IOBSV
            FSPEC(2)=OBSV(1,IOBSV)
            FSPEC(3)=OBSV(2,IOBSV)
            FSPEC(4)=OBSV(3,IOBSV)
            FSPEC(5)=FREQ(ifrq)
            IOBFR=IOBSV+NOBSV*(ifrq-1)
            FSPEC(6)=STOKES(1,IOBFR)
            FSPEC(7)=STOKES(2,IOBFR)
            FSPEC(8)=STOKES(3,IOBFR)
            FSPEC(9)=STOKES(4,IOBFR)
            FSPEC(10)=IOBSVZ
            FSPEC(11)=IOBSVY
            FSPEC(12)=ifrq
            CALL hfm(NIDSTOK,FSPEC)
            ENDDO   !NFREQ
          ENDDO   !IOBSV

          IF (I47.EQ.1) THEN

            CALL MHROUT(NIDSTOK,ICYCLE,' ')

            if (iroottrees.ge.0) then
              CALL hrendm('STOKES')
            endif
            CLOSE(47)

            if (iroottrees.ge.0) then
              CALL hcdirm(OLDDIR,' ')
            endif

          ENDIF !I47

        ENDIF  !ISTOKES

        IF (ISTOKES.NE.0.AND.IFOLD.EQ.1) THEN

          IF (I47.EQ.1) THEN

            if (iroottrees.ge.0) then
              CALL hcdirm(OLDDIR,'R')
            endif

            FILE47='4701_'//FILEHB(1:123)

            if (iroottrees.ge.0) then
              CALL hropenm(47,'STOKESF',FILE47,'NQ',1024,ISTAT)
              CALL hcdirm('//STOKESF',' ')
            endif

            CALL MHROUT(IDCODE,ICYCLE,' ')

            CALL MHROUT(ICFRS0F,ICYCLE,' ')
            CALL MHROUT(ICFRS1F,ICYCLE,' ')
            CALL MHROUT(ICFRS2F,ICYCLE,' ')
            CALL MHROUT(ICFRS3F,ICYCLE,' ')

            CALL MHROUT(ICFRPF,ICYCLE,' ')
            CALL MHROUT(ICFRP1F,ICYCLE,' ')
            CALL MHROUT(ICFRP2F,ICYCLE,' ')
            CALL MHROUT(ICFRP3F,ICYCLE,' ')
            CALL MHROUT(ICFRP23F,ICYCLE,' ')

            CALL MHROUT(ICFRG3F,ICYCLE,' ')
            CALL MHROUT(ICFRG23F,ICYCLE,' ')

            IF (IBRILL.NE.0) THEN
              CALL MHROUT(ICFRB0F,ICYCLE,' ')
              CALL MHROUT(ICFRB1F,ICYCLE,' ')
              CALL MHROUT(ICFRB2F,ICYCLE,' ')
              CALL MHROUT(ICFRB3F,ICYCLE,' ')
            ENDIF

            CALL MHROUT(IDFRS0F,ICYCLE,' ')
            CALL MHROUT(IDFRS1F,ICYCLE,' ')
            CALL MHROUT(IDFRS2F,ICYCLE,' ')
            CALL MHROUT(IDFRS3F,ICYCLE,' ')

            CALL MHROUT(IDFRPF,ICYCLE,' ')
            CALL MHROUT(IDFRP1F,ICYCLE,' ')
            CALL MHROUT(IDFRP2F,ICYCLE,' ')
            CALL MHROUT(IDFRP3F,ICYCLE,' ')
            CALL MHROUT(IDFRP23F,ICYCLE,' ')

            CALL MHROUT(IDFRG3F,ICYCLE,' ')
            CALL MHROUT(IDFRG23F,ICYCLE,' ')

            CALL MHROUT(IDSPEC,ICYCLE,' ')
            CALL MHROUT(IDSPEC-1,ICYCLE,' ')
            CALL MHROUT(IDSPEC-2,ICYCLE,' ')
            call hdeletm(idspec)
            call hdeletm(idspec-1)
            call hdeletm(idspec-2)

            CALL hbookm(NIDSTOKF,'STOKES ARRAYS (FOLDED)',12
     &        ,'//STOKESF',nobsv*nfreq*nsource,CHSTOK)

          ELSE !I47

            CALL hbookm(NIDSTOKF,'STOKES ARRAYS (FOLDED)',12
     &        ,'//WAVE',nobsv*nfreq*nsource,CHSTOK)
          ENDIF !I47

          DO IOBSV=1,NOBSV
            IF (IPIN.NE.0) THEN
              IOBSVY=(IOBSV-1)/NOBSVZ+1
              IOBSVZ=IOBSV-NOBSVZ*(IOBSVY-1)
            ELSE
              IOBSVY=1
              IOBSVZ=1
            ENDIF
            DO ifrq=1,NFREQ,IHFREQ
              FSPEC(1)=IOBSV
              FSPEC(2)=OBSV(1,IOBSV)
              FSPEC(3)=OBSV(2,IOBSV)
              FSPEC(4)=OBSV(3,IOBSV)
              FSPEC(5)=FREQ(ifrq)
              IOBFR=IOBSV+NOBSV*(ifrq-1)
              FSPEC(6)=STOKESF(1,IOBFR)
              FSPEC(7)=STOKESF(2,IOBFR)
              FSPEC(8)=STOKESF(3,IOBFR)
              FSPEC(9)=STOKESF(4,IOBFR)
              FSPEC(10)=IOBSVZ
              FSPEC(11)=IOBSVY
              FSPEC(12)=ifrq
              CALL hfm(NIDSTOKF,FSPEC)
            ENDDO   !NFREQ
          ENDDO   !IOBSV

          IF (I47.EQ.1) THEN

            CALL MHROUT(NIDSTOKF,ICYCLE,' ')

            if (iroottrees.ge.0) then
              CALL hrendm('STOKESF')
            endif
            CLOSE(47)

            if (iroottrees.ge.0) then
              CALL hcdirm(OLDDIR,' ')
            endif

        ENDIF !I47

        ENDIF  !ISTOKES,FOLD

        IF (ISTOKES.NE.0.AND.IEFOLD.ne.0) THEN

          IF (I47.EQ.1) THEN

            if (iroottrees.ge.0) then
              CALL hcdirm(OLDDIR,'R')
            endif

            FILE47='4702_'//FILEHB(1:123)

            if (iroottrees.ge.0) then
              CALL hropenm(47,'STOKESE',FILE47,'NQ',1024,ISTAT)
              CALL hcdirm('//STOKESE',' ')
            endif

            CALL MHROUT(IDCODE,ICYCLE,' ')

            CALL MHROUT(ICFRS0E,ICYCLE,' ')
            CALL MHROUT(ICFRS1E,ICYCLE,' ')
            CALL MHROUT(ICFRS2E,ICYCLE,' ')
            CALL MHROUT(ICFRS3E,ICYCLE,' ')

            CALL MHROUT(ICFRPE,ICYCLE,' ')
            CALL MHROUT(ICFRP1E,ICYCLE,' ')
            CALL MHROUT(ICFRP2E,ICYCLE,' ')
            CALL MHROUT(ICFRP3E,ICYCLE,' ')
            CALL MHROUT(ICFRP23E,ICYCLE,' ')

            CALL MHROUT(ICFRG3E,ICYCLE,' ')
            CALL MHROUT(ICFRG23E,ICYCLE,' ')

            IF (IBRILL.NE.0) THEN
              CALL MHROUT(ICFRB0E,ICYCLE,' ')
              CALL MHROUT(ICFRB1E,ICYCLE,' ')
              CALL MHROUT(ICFRB2E,ICYCLE,' ')
              CALL MHROUT(ICFRB3E,ICYCLE,' ')
            ENDIF

            CALL MHROUT(IDFRS0E,ICYCLE,' ')
            CALL MHROUT(IDFRS1E,ICYCLE,' ')
            CALL MHROUT(IDFRS2E,ICYCLE,' ')
            CALL MHROUT(IDFRS3E,ICYCLE,' ')

            CALL MHROUT(IDFRPE,ICYCLE,' ')
            CALL MHROUT(IDFRP1E,ICYCLE,' ')
            CALL MHROUT(IDFRP2E,ICYCLE,' ')
            CALL MHROUT(IDFRP3E,ICYCLE,' ')
            CALL MHROUT(IDFRP23E,ICYCLE,' ')

            CALL MHROUT(IDFRG3E,ICYCLE,' ')
            CALL MHROUT(IDFRG23E,ICYCLE,' ')

            CALL MHROUT(IDSPEC,ICYCLE,' ')
            CALL MHROUT(IDSPEC-1,ICYCLE,' ')
            CALL MHROUT(IDSPEC-2,ICYCLE,' ')
            call hdeletm(idspec)
            call hdeletm(idspec-1)
            call hdeletm(idspec-2)

            CALL hbookm(NIDSTOKE,'STOKES ARRAYS (E-FOLDED)',12
     &        ,'//STOKESE',nobsv*nfreq*nsource,CHSTOK)

          ELSE !I47

            CALL hbookm(NIDSTOKE,'STOKES ARRAYS (E-FOLDED)',12
     &        ,'//WAVE',nobsv*nfreq*nsource,CHSTOK)
          ENDIF !I47

          DO IOBSV=1,NOBSV
            IF (IPIN.NE.0) THEN
              IOBSVY=(IOBSV-1)/NOBSVZ+1
              IOBSVZ=IOBSV-NOBSVZ*(IOBSVY-1)
            ELSE
              IOBSVY=1
              IOBSVZ=1
            ENDIF
            DO ifrq=1,NFREQ,IHFREQ
              FSPEC(1)=IOBSV
              FSPEC(2)=OBSV(1,IOBSV)
              FSPEC(3)=OBSV(2,IOBSV)
              FSPEC(4)=OBSV(3,IOBSV)
              FSPEC(5)=FREQ(ifrq)
              IOBFR=IOBSV+NOBSV*(ifrq-1)
              FSPEC(6)=STOKESE(1,IOBFR)
              FSPEC(7)=STOKESE(2,IOBFR)
              FSPEC(8)=STOKESE(3,IOBFR)
              FSPEC(9)=STOKESE(4,IOBFR)
              FSPEC(10)=IOBSVZ
              FSPEC(11)=IOBSVY
              FSPEC(12)=ifrq
              CALL hfm(NIDSTOKE,FSPEC)
            ENDDO   !NFREQ
          ENDDO   !IOBSV

          IF (I47.EQ.1) THEN

            CALL MHROUT(NIDSTOKE,ICYCLE,' ')

            if (iroottrees.ge.0) then
              CALL hrendm('STOKESE')
            endif
            CLOSE(47)

            if (iroottrees.ge.0) then
              CALL hcdirm(OLDDIR,' ')
            endif

          ENDIF !I47

        ENDIF  !ISTOKES,EFOLD

        IF (ISTOKES.NE.0.AND.IEFOLD.ne.0.AND.IFOLD.EQ.1) THEN

          IF (I47.EQ.1) THEN

            if (iroottrees.ge.0) then
              CALL hcdirm(OLDDIR,'R')
            endif

            FILE47='4703_'//FILEHB(1:123)

            if (iroottrees.ge.0) then
              CALL hropenm(47,'STOKESEF',FILE47,'NQ',1024,ISTAT)
              CALL hcdirm('//STOKESEF',' ')
            endif

            CALL MHROUT(IDCODE,ICYCLE,' ')

            CALL MHROUT(ICFRS0EF,ICYCLE,' ')
            CALL MHROUT(ICFRS1EF,ICYCLE,' ')
            CALL MHROUT(ICFRS2EF,ICYCLE,' ')
            CALL MHROUT(ICFRS3EF,ICYCLE,' ')

            CALL MHROUT(ICFRPEF,ICYCLE,' ')
            CALL MHROUT(ICFRP1EF,ICYCLE,' ')
            CALL MHROUT(ICFRP2EF,ICYCLE,' ')
            CALL MHROUT(ICFRP3EF,ICYCLE,' ')
            CALL MHROUT(ICFRP23EF,ICYCLE,' ')

            CALL MHROUT(ICFRG3EF,ICYCLE,' ')
            CALL MHROUT(ICFRG23EF,ICYCLE,' ')

            IF (IBRILL.NE.0) THEN
              CALL MHROUT(ICFRB0EF,ICYCLE,' ')
              CALL MHROUT(ICFRB1EF,ICYCLE,' ')
              CALL MHROUT(ICFRB2EF,ICYCLE,' ')
              CALL MHROUT(ICFRB3EF,ICYCLE,' ')
            ENDIF

            CALL MHROUT(IDFRS0EF,ICYCLE,' ')
            CALL MHROUT(IDFRS1EF,ICYCLE,' ')
            CALL MHROUT(IDFRS2EF,ICYCLE,' ')
            CALL MHROUT(IDFRS3EF,ICYCLE,' ')

            CALL MHROUT(IDFRPEF,ICYCLE,' ')
            CALL MHROUT(IDFRP1EF,ICYCLE,' ')
            CALL MHROUT(IDFRP2EF,ICYCLE,' ')
            CALL MHROUT(IDFRP3EF,ICYCLE,' ')
            CALL MHROUT(IDFRP23EF,ICYCLE,' ')

            CALL MHROUT(IDFRG3EF,ICYCLE,' ')
            CALL MHROUT(IDFRG23EF,ICYCLE,' ')

            CALL MHROUT(IDSPEC,ICYCLE,' ')
            CALL MHROUT(IDSPEC-1,ICYCLE,' ')
            CALL MHROUT(IDSPEC-2,ICYCLE,' ')
            call hdeletm(idspec)
            call hdeletm(idspec-1)
            call hdeletm(idspec-2)

            CALL hbookm(NIDSTOKEF,'STOKES ARRAYS (EMIT, E-FOLDED)',12
     &        ,'//STOKESEF',nobsv*nfreq*nsource,CHSTOK)

          ELSE !I47

            CALL hbookm(NIDSTOKEF,'STOKES ARRAYS (EMIT, E-FOLDED)',12
     &        ,'//WAVE',nobsv*nfreq*nsource,CHSTOK)
          ENDIF !I47

          DO IOBSV=1,NOBSV
            IF (IPIN.NE.0) THEN
              IOBSVY=(IOBSV-1)/NOBSVZ+1
              IOBSVZ=IOBSV-NOBSVZ*(IOBSVY-1)
            ELSE
              IOBSVY=1
              IOBSVZ=1
            ENDIF
            DO ifrq=1,NFREQ,IHFREQ
              FSPEC(1)=IOBSV
              FSPEC(2)=OBSV(1,IOBSV)
              FSPEC(3)=OBSV(2,IOBSV)
              FSPEC(4)=OBSV(3,IOBSV)
              FSPEC(5)=FREQ(ifrq)
              IOBFR=IOBSV+NOBSV*(ifrq-1)
              FSPEC(6)=STOKESEF(1,IOBFR)
              FSPEC(7)=STOKESEF(2,IOBFR)
              FSPEC(8)=STOKESEF(3,IOBFR)
              FSPEC(9)=STOKESEF(4,IOBFR)
              FSPEC(10)=IOBSVZ
              FSPEC(11)=IOBSVY
              FSPEC(12)=ifrq
              CALL hfm(NIDSTOKEF,FSPEC)
            ENDDO   !NFREQ
          ENDDO   !IOBSV

          IF (I47.EQ.1) THEN

            CALL MHROUT(NIDSTOKEF,ICYCLE,' ')

            if (iroottrees.ge.0) then
              CALL hrendm('STOKESEF')
            endif
            CLOSE(47)

            if (iroottrees.ge.0) then
              CALL hcdirm(OLDDIR,' ')
            endif

          ENDIF !I47

        ENDIF  !ISTOKES,EFOLD,IFOLD

        deallocate(phfill)

        if(ibunch.ne.0.and.icluster.gt.0) call wpampntup

        RETURN
      END
