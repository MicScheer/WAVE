*CMZ :  4.00/17 04/10/2022  08.10.22  by  Michael Scheer
*CMZ :  4.00/16 22/07/2022  08.40.59  by  Michael Scheer
*CMZ :  4.00/15 28/04/2022  15.43.36  by  Michael Scheer
*CMZ :  4.00/13 09/11/2021  09.50.16  by  Michael Scheer
*CMZ :  4.00/11 17/05/2021  12.32.15  by  Michael Scheer
*CMZ :  4.00/09 12/08/2020  12.58.53  by  Michael Scheer
*CMZ :  4.00/07 09/07/2020  16.53.44  by  Michael Scheer
*CMZ :  4.00/04 17/05/2019  14.17.20  by  Michael Scheer
*CMZ :  4.00/03 07/05/2019  14.19.31  by  Michael Scheer
*CMZ :  3.07/01 29/03/2019  10.40.58  by  Michael Scheer
*CMZ :  3.05/10 13/08/2018  14.40.26  by  Michael Scheer
*CMZ :  3.05/03 16/05/2018  15.26.02  by  Michael Scheer
*CMZ :  3.05/00 26/04/2018  11.52.54  by  Michael Scheer
*CMZ :  3.03/04 29/11/2017  10.16.03  by  Michael Scheer
*CMZ :  3.03/02 08/01/2016  19.14.53  by  Michael Scheer
*CMZ :  3.02/03 04/11/2014  12.27.30  by  Michael Scheer
*CMZ :  3.01/03 07/03/2014  13.20.05  by  Michael Scheer
*CMZ :  2.70/12 18/09/2013  12.33.23  by  Michael Scheer
*CMZ :  2.68/03 03/08/2012  09.40.49  by  Michael Scheer
*CMZ :  2.68/02 31/07/2012  14.28.27  by  Michael Scheer
*CMZ :  2.67/02 03/05/2012  09.16.43  by  Michael Scheer
*CMZ :  2.66/20 22/11/2011  10.35.21  by  Michael Scheer
*CMZ :  2.66/07 09/12/2009  10.50.24  by  Michael Scheer
*CMZ :  2.66/06 26/11/2009  19.35.32  by  Michael Scheer
*CMZ :  2.64/01 20/08/2009  11.50.48  by  Michael Scheer
*CMZ :  2.63/05 22/07/2009  08.28.26  by  Michael Scheer
*CMZ :  2.63/02 07/03/2008  10.34.54  by  Michael Scheer
*CMZ :  2.61/05 11/04/2007  11.58.07  by  Michael Scheer
*CMZ :  2.59/01 15/03/2007  11.13.54  by  Michael Scheer
*CMZ :  2.57/05 09/01/2007  16.55.37  by  Michael Scheer
*CMZ :  2.56/02 21/10/2005  16.31.31  by  Michael Scheer
*CMZ :  2.54/05 19/05/2005  09.11.03  by  Michael Scheer
*CMZ :  2.53/05 16/02/2005  14.45.59  by  Michael Scheer
*CMZ :  2.52/13 16/12/2004  18.11.37  by  Michael Scheer
*CMZ :  2.47/23 17/02/2004  10.36.15  by  Michael Scheer
*CMZ :  2.47/08 15/05/2003  15.38.12  by  Michael Scheer
*CMZ :  2.46/01 18/12/2002  11.40.26  by  Michael Scheer
*CMZ :  2.46/00 17/12/2002  15.37.28  by  Michael Scheer
*CMZ :  2.45/03 17/12/2002  14.53.11  by  Michael Scheer
*CMZ :  2.45/02 16/12/2002  14.32.25  by  Michael Scheer
*CMZ :  2.44/01 11/12/2002  11.12.28  by  Michael Scheer
*CMZ :  2.44/00 06/11/2002  11.28.41  by  Michael Scheer
*CMZ :  2.41/05 17/04/2002  15.14.11  by  Michael Scheer
*CMZ :  2.15/00 15/05/2000  16.34.53  by  Michael Scheer
*CMZ :  2.13/08 29/02/2000  15.51.27  by  Michael Scheer
*CMZ :  2.13/00 03/12/99  16.04.43  by  Michael Scheer
*CMZ :  2.12/04 27/08/99  13.24.54  by  Michael Scheer
*CMZ :  2.11/00 12/05/99  11.47.07  by  Michael Scheer
*CMZ :  2.02/00 05/02/99  15.05.53  by  Michael Scheer
*CMZ :  1.02/03 09/01/98  19.39.53  by  Michael Scheer
*CMZ :  1.02/00 06/01/98  15.13.36  by  Michael Scheer
*CMZ :  1.00/00 26/06/97  10.31.19  by  Michael Scheer
*CMZ : 00.02/04 18/02/97  16.35.49  by  Michael Scheer
*CMZ : 00.02/03 24/01/97  14.20.47  by  Michael Scheer
*CMZ : 00.02/00 21/11/96  14.21.30  by  Michael Scheer
*CMZ : 00.01/10 04/06/96  18.05.02  by  Michael Scheer
*CMZ : 00.01/09 06/05/96  14.23.34  by  Michael Scheer
*CMZ : 00.01/08 22/06/95  09.51.54  by  Michael Scheer
*CMZ : 00.01/07 16/03/95  14.22.58  by  Michael Scheer
*CMZ : 00.01/03 28/11/94  11.33.22  by  Michael Scheer
*CMZ : 00.00/05 29/04/94  19.28.03  by  Michael Scheer
*CMZ : 00.00/00 28/04/94  16.12.55  by  Michael Scheer
*-- Author : Michael Scheer
C*******************************************************************************
      Subroutine MYBFELD(XIII,YIII,ZIII,BX,BY,BZ,AX,AY,AZ)
C*******************************************************************************

*KEEP,gplhint.
!******************************************************************************
!
!      Copyright 2013 Helmholtz-Zentrum Berlin (HZB)
!      Hahn-Meitner-Platz 1
!      D-14109 Berlin
!      Germany
!
!      Author Michael Scheer, Michael.Scheer@Helmholtz-Berlin.de
!
! -----------------------------------------------------------------------
!
!    This program is free software: you can redistribute it and/or modify
!    it under the terms of the GNU General Public License as published by
!    the Free Software Foundation, either version 3 of the License, or
!    (at your option) any later version.
!
!    This program is distributed in the hope that it will be useful,
!    but WITHOUT ANY WARRANTY; without even the implied warranty of
!    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
!    GNU General Public License for more details.
!
!    You should have received a copy (wave_gpl.txt) of the GNU General Public
!    License along with this program.
!    If not, see <http://www.gnu.org/licenses/>.
!
!    Dieses Programm ist Freie Software: Sie koennen es unter den Bedingungen
!    der GNU General Public License, wie von der Free Software Foundation,
!    Version 3 der Lizenz oder (nach Ihrer Option) jeder spaeteren
!    veroeffentlichten Version, weiterverbreiten und/oder modifizieren.
!
!    Dieses Programm wird in der Hoffnung, dass es nuetzlich sein wird, aber
!    OHNE JEDE GEWAEHRLEISTUNG, bereitgestellt; sogar ohne die implizite
!    Gewaehrleistung der MARKTFAEHIGKEIT oder EIGNUNG FueR EINEN BESTIMMTEN ZWECK.
!    Siehe die GNU General Public License fuer weitere Details.
!
!    Sie sollten eine Kopie (wave_gpl.txt) der GNU General Public License
!    zusammen mit diesem Programm erhalten haben. Wenn nicht,
!    siehe <http://www.gnu.org/licenses/>.
!
!******************************************************************************
*KEND.
      IMPLICIT NONE

*KEEP,contrl.
      include 'contrl.cmn'
*KEEP,b0scglob.
      include 'b0scglob.cmn'
*KEEP,efield.
      include 'efield.cmn'
*KEEP,track.
      include 'track.cmn'
*KEEP,undumagc.
      include 'undumagc.cmn'
*KEEP,debugwave.
      include 'debugwave.cmn'
*KEND.

      DOUBLE PRECISION XII,YII,ZII,SIGX,SIGY,SIGZ,DMODFULL,DMODHALF,PERHALF
      DOUBLE PRECISION XI,YI,ZI,X,Y,Z,BX,BY,BZ,AX,AY,AZ,BZD,BYD,AZD,AYD,ZD
     &                  ,YD,BB,PERQUAD,PER3QUAD,DMODQUAD,XIII,YIII,ZIII

      DOUBLE PRECISION BXM,BYM,BZM,BXE,BYE,BZE,AXE,AYE,AZE
      DOUBLE PRECISION BXSUPER,BYSUPER,BZSUPER,AXSUPER,AYSUPER,AZSUPER
     &  ,BMASK(3,10000),BXX,dum,xr,yr,zr

      real g(3)
      INTEGER ICAL,NBMASK,I,IWARN,ifail,iwarnu

      DATA ICAL/0/,IWARN/0/,iwarnu/0/

      if (kampli.gt.0) then
        CALL BELLIP(Xiii,Yiii,Ziii,BX,BY,BZ,AX,AY,AZ)
        return
      endif

      iwarnmyb=0

      XII=XIII
      YII=YIII
      ZII=ZIII

      if (iefield.ne.0) then
        call efield(xii,yii,zii,efieldx,efieldy,efieldz)
      endif

      IF (IMAGSPLN.EQ.-999) THEN !FIELD TO BE CALCULATED BY SPLINE INTERPOLATION
        CALL BMAGSPLN(XII,YII,ZII,BX,BY,BZ)
        if (ibmasksp.ge.0) return
      ENDIF !IMAGSPLN

      IF (ICAL.EQ.0) THEN
        PERHALF=PERIODG/2.D0
        PERQUAD=PERHALF/2.D0
        PER3QUAD=PERHALF+PERQUAD
        IF (DABS(CROTD**2+SROTD**2-1.D0).GT.1.D-10) THEN
          WRITE(LUNGFO,*)
     &      '*** ERROR IN MYBFELD: CALLED BEFORE CALL TO GFINIT'
          WRITE(6,*)
     &      '*** ERROR IN MYBFELD: CALLED BEFORE CALL TO GFINIT'
          STOP
        ENDIF
      ENDIF

      IF (IMAGSPLN.GT.0.OR.IMAGSPLN.EQ.-1111) THEN !FIELD TO BE CALCULATED BY SPLINE INTERPOLATION
        CALL BMAGSPLN(XII,YII,ZII,BX,BY,BZ)
        GOTO 1000
      ENDIF !IMAGSPLN

      XII=XIII+XSHIFT
      YII=YIII+VSHIFT
      ZII=ZIII+HSHIFT

      ZD= CROTD*ZII-SROTD*YII
      YD= SROTD*ZII+CROTD*YII
      ZII=ZD
      YII=YD

      XI=XII
      YI=YII
      ZI=ZII

      SIGX=1.D0
      SIGY=1.D0
      SIGZ=1.D0

      IF (IPERIODG.GT.0) THEN
C OLD MODE, KEPT FOR COMPATIBILITY
        DMODFULL=DMOD(XII-PEROFFG,PERIODG)
        IF (DMODFULL.LT.0.0D0) DMODFULL=DMODFULL+PERIODG
        IF(SIGNG.GE.0.D0) THEN
          SIGX=SIGNG
          SIGY=SIGNG
          SIGZ=SIGNG
          XI=PEROFFG+DMODFULL
        ELSE
          IF (DMODFULL.GT.PERHALF) THEN
            XI=PEROFFG+DMODFULL-PERHALF
            SIGX=SIGNG
            SIGY=SIGNG
            SIGZ=SIGNG
          ELSE
            SIGX=-SIGNG
            SIGY=-SIGNG
            SIGZ=-SIGNG
            XI=PEROFFG+DMODFULL
          ENDIF
        ENDIF   !SIGNG

        IF(SIGNG2.NE.0.0D0) THEN

          DMODFULL=DMOD(XII-PEROFFG,2.0d0*PERIODG)
          IF (DMODFULL.LT.0.0D0) DMODFULL=DMODFULL+2.0d0*PERIODG

          IF (DMODFULL.Ge.PERIODG) then
            SIGX=SIGX*SIGNG2
            SIGY=SIGY*SIGNG2
            SIGZ=SIGZ*SIGNG2
          else
            SIGX=-SIGX*SIGNG2
            SIGY=-SIGY*SIGNG2
            SIGZ=-SIGZ*SIGNG2
          ENDIF !(DMODFULL.GT.PERIODG) THEN

          DMODFULL=DMOD(XII-PEROFFG,PERIODG)
          IF (DMODFULL.LT.0.0D0) DMODFULL=DMODFULL+PERIODG
          XI=PEROFFG+DMODFULL

        ENDIF   !SIGN2

      ELSE IF (IPERIODG.EQ.-1) THEN
c FULL PERIOD
        IF(XII.GE.XPERWMN.AND.XII.LE.XPERWMX) THEN
          DMODFULL=DMOD(XII-PEROFFG,PERIODG)
          IF (DMODFULL.LT.0.0D0) DMODFULL=DMODFULL+PERIODG
          XI=PEROFFG+DMODFULL
        else if(XII.GT.XPERWMX) THEN
          XI=XII-(XPERWMX-XPERWMN)
        ENDIF
      else if (IPERIODG.EQ.-2) THEN
c HALF PERIOD
        IF(XII.GE.XPERWMN.AND.XII.LE.XPERWMX) THEN
          DMODFULL=DMOD(XII-PEROFFG,PERIODG)
          IF (DMODFULL.LT.0.0D0) DMODFULL=DMODFULL+PERIODG
          DMODHALF=DMOD(DMODFULL,PERHALF)
          XI=PEROFFG+DMODHALF
          IF (DMODFULL.GT.PERHALF) THEN
            SIGX=-1.D0
            SIGY=-1.D0
            SIGZ=-1.D0
          ENDIF
        else if(XII.GT.XPERWMX) THEN
          XI=XII-(XPERWMX-XPERWMN)
        ENDIF
      else if (IPERIODG.EQ.-3) THEN
c QUARTER PERIOD, COSINE-LIKE
        IF(XII.GE.XPERWMN.AND.XII.LE.XPERWMX) THEN
          DMODFULL=DMOD(XII-PEROFFG,PERIODG)
          IF (DMODFULL.LT.0.0D0) DMODFULL=DMODFULL+PERIODG
          DMODHALF=DMOD(DMODFULL,PERHALF)
          DMODQUAD=DMOD(DMODHALF,PERQUAD)
          XI=PEROFFG+DMODFULL
          IF(DMODFULL.GE.PER3QUAD) THEN
            XI=PEROFFG+PERQUAD-DMODQUAD
            SIGX=-1.D0
          else if(DMODFULL.GE.PERHALF) THEN
            XI=PEROFFG+DMODQUAD
            SIGX=-1.D0
            SIGY=-1.D0
            SIGZ=-1.D0
          else if(DMODFULL.GE.PERQUAD) THEN
            XI=PEROFFG+PERQUAD-DMODQUAD
            SIGY=-1.D0
            SIGZ=-1.D0
          ENDIF
        else if(XII.GT.XPERWMX) THEN
          XI=XII-(XPERWMX-XPERWMN)
        ENDIF
      else if (IPERIODG.EQ.-4) THEN
c QUARTER PERIOD, SINE-LIKE
        IF(XII.GE.XPERWMN.AND.XII.LE.XPERWMX) THEN
          DMODFULL=DMOD(XII-PEROFFG,PERIODG)
          IF (DMODFULL.LT.0.0D0) DMODFULL=DMODFULL+PERIODG
          DMODHALF=DMOD(DMODFULL,PERHALF)
          DMODQUAD=DMOD(DMODHALF,PERQUAD)
          XI=PEROFFG+DMODFULL
          IF(DMODFULL.GE.PER3QUAD) THEN
            XI=PEROFFG+PERQUAD-DMODQUAD
            SIGY=-1.D0
            SIGZ=-1.D0
          ELSE IF(DMODFULL.GE.PERHALF) THEN
            XI=PEROFFG+DMODQUAD
            SIGX=-1.D0
            SIGY=-1.D0
            SIGZ=-1.D0
          ELSE IF(DMODFULL.GE.PERQUAD) THEN
            XI=PEROFFG+PERQUAD-DMODQUAD
            SIGX=-1.D0
          ENDIF
        else if(XII.GT.XPERWMX) THEN
          XI=XII-(XPERWMX-XPERWMN)
        ENDIF
      ENDIF !IPERIOD

      IF(IBSYM.NE.0) THEN
        X=ABS(XI-XBSYM)
      ELSE
        X=XI
      ENDIF

      IF(IBSYMY.NE.0) THEN
        Y=ABS(YI)
      ELSE
        Y=YI
      ENDIF

      IF(IBSYMZ.NE.0) THEN
        Z=ABS(ZI)
      ELSE
        Z=ZI
      ENDIF

      BX=0.0d0
      BY=0.0d0
      BZ=0.0d0

      AX=0.0d0
      AY=0.0d0
      AZ=0.0d0

      IF (ibmasksp.lt.0) THEN
        CALL BFELD(BXM,BYM,BZM,X,Y,Z)
        bx=bx+bxm
        by=by+bym
        bz=bz+bzm
        IF (KMAGSEQ.lt.0) THEN
          CALL BMAGSEQ(X,Y,Z,BXm,BYm,BZm,dum,dum,dum)
          bx=bx+bxm
          by=by+bym
          bz=bz+bzm
        endif
        goto 100
      ENDIF !(IBMASKSP.NE.0)

      x=x+xbshift

      IF (IBSUPER.EQ.0) THEN

          IF (KHALBA.NE.0) THEN
            CALL BHALBA(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (Kundugap.NE.0) THEN
            CALL Bundugap(X,Y,Z,BX,BY,BZ,AX,AY,AZ,0)
          ELSE IF (KHALBASY.NE.0) THEN
            CALL BHALBASY(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (IRFILF.EQ.1) THEN
            CALL BFOUR(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (IFOURBTABZY.EQ.1) THEN
            CALL BFOURtabzy(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (IRBTAB.ne.0) THEN
            CALL BTAB(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (IRBTABZY.ne.0) THEN
            CALL BTABZY(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (IRBTABXYZ.ne.0) THEN
            CALL BTABXYZ(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (KBEXTERN.EQ.1) THEN
            CALL BEXTERN(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (KUCROSS.EQ.1) THEN
            CALL BUCROSS(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (KELLIP.EQ.1) THEN
            CALL BELLIP(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (KELLANA.EQ.1) THEN
            CALL BELLANA(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (KBREC.EQ.1) THEN
            CALL BREC(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (kbundumag.EQ.1.or.kbundumag.eq.3) THEN
            CALL undumagwav(X,Y,Z,BX,BY,BZ,ifail)
          ELSE IF (KBPOLYMAG.GT.0) THEN
            CALL BPOLYEDER(X,Y,Z,BX,BY,BZ)
          ELSE IF (KMAGSEQ.ne.0) THEN
            CALL BMAGSEQ(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (KBPOLYH.EQ.1) THEN
            CALL BPOLYHARM(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (KBPOLY3D.EQ.1) THEN
            CALL BPOLY3D(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (KBPOLY2DH.EQ.1) THEN
            CALL BPOLY2DH(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (KBPHARM.EQ.1) THEN
            CALL BPHARM(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (IWSECTMAGS.LT.0) THEN
            CALL BSECTMAGS(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
          ELSE IF (KBFELD.EQ.1) THEN
            CALL BFELD( BX, BY, BZ,X,Y,Z)
          ELSE IF (IRFILB0.NE.0 .OR. IRFILB.EQ.1) THEN
            CALL BMESS(X,Y,Z,BX,BY,BZ)
            if (iwarnbmap.ne.0) then
              bx=0.0d0
              by=0.0d0
              bz=0.0d0
c              iwarnmyb=1
            endif
          ELSE IF (IRFILP.EQ.1.AND.ISPLINE.EQ.1) THEN
            CALL BPAND(X,Y,Z,BX,BY,BZ)
          ELSE IF (IRFILP.EQ.1.AND.ISPLINE.NE.1) THEN
            CALL BPANDOLD(X,Y,Z,BX,BY,BZ)
          ELSE IF (KBAMWLS.NE.0) THEN
            CALL BBAMWLS(X,Y,Z,BX,BY,BZ)

          ELSE IF (IBHELM.EQ.1) THEN
            CALL BHELM(X,Y,Z,BX,BY,BZ)

          ELSE IF (KBGENESIS.NE.0) THEN
            CALL BGENESIS(X,Y,Z,BX,BY,BZ,AX,AY,AZ)

          ELSE IF (ibmasksp.NE.0) THEN

          ELSE

            STOP '*** SR MYBFELD: NO MAGNETIC FIELD DEFINED ***'

          ENDIF

        ELSE   !IBSUPER

          BXSUPER=0.D0
          BYSUPER=0.D0
          BZSUPER=0.D0

          AXSUPER=0.D0
          AYSUPER=0.D0
          AZSUPER=0.D0

          IF (KHALBA.NE.0) THEN
            CALL BHALBA(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KHALBASY.NE.0) THEN
            CALL BHALBASY(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (kundugap.NE.0) THEN
            CALL Bundugap(X,Y,Z,BX,BY,BZ,AX,AY,AZ,0)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (IRFILF.EQ.1) THEN
            CALL BFOUR(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (IRBTAB.ne.0) THEN
            CALL BTAB(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (IRBTABZY.ne.0) THEN
            CALL BTABZY(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (IfourBTABZY.ne.0) THEN
            CALL BfourTABZY(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (IRBTABXYZ.ne.0) THEN
            CALL BTABXYZ(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KBEXTERN.EQ.1) THEN
            CALL BEXTERN(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KUCROSS.EQ.1) THEN
            CALL BUCROSS(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KELLIP.EQ.1) THEN
            CALL BELLIP(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KELLANA.EQ.1) THEN
            CALL BELLANA(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (kbundumag.EQ.1.or.kbundumag.eq.3) THEN
            CALL undumagwav(X,Y,Z,BX,BY,BZ,ifail)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
          endif

          IF (KBREC.EQ.1) THEN
            CALL BREC(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KBPOLYMAG.GT.0) THEN
            CALL BPOLYEDER(X,Y,Z,BX,BY,BZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KMAGSEQ.ne.0) THEN
            CALL BMAGSEQ(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KBPOLYH.EQ.1) THEN
            CALL BPOLYHARM(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KBPOLY3D.EQ.1) THEN
            CALL BPOLY3D(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KBPOLY2DH.EQ.1) THEN
            CALL BPOLY2DH(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KBPHARM.EQ.1) THEN
            CALL BPHARM(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KBFELD.EQ.1) THEN
            CALL BFELD( BX, BY, BZ,X,Y,Z)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (KBAMWLS.NE.0) THEN
            CALL BBAMWLS(X,Y,Z,BX,BY,BZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
          ENDIF

          IF (IWSECTMAGS.LT.0) THEN
            CALL BSECTMAGS(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (IRFILB0.NE.0 .OR. IRFILB.EQ.1) THEN
            CALL BMESS(X,Y,Z,BX,BY,BZ)
            if (iwarnbmap.ne.0) then
              bx=0.0d0
              by=0.0d0
              bz=0.0d0
c              iwarnmyb=1
            endif
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (IRFILP.EQ.1.AND.ISPLINE.EQ.1) THEN
            CALL BPAND(X,Y,Z,BX,BY,BZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (IRFILP.EQ.2.AND.ISPLINE.NE.1) THEN
            CALL BPANDOLD(X,Y,Z,BX,BY,BZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          IF (IBHELM.EQ.1) THEN
            CALL BHELM(X,Y,Z,BX,BY,BZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF


          IF (KBGENESIS.NE.0) THEN
            CALL BGENESIS(X,Y,Z,BX,BY,BZ,AX,AY,AZ)
            BXSUPER=BXSUPER+BX
            BYSUPER=BYSUPER+BY
            BZSUPER=BZSUPER+BZ
            AXSUPER=AXSUPER+AX
            AYSUPER=AYSUPER+AY
            AZSUPER=AZSUPER+AZ
          ENDIF

          BX=BXSUPER
          BY=BYSUPER
          BZ=BZSUPER

          AX=AXSUPER
          AY=AYSUPER
          AZ=AZSUPER

        ENDIF  !IBSUPER

        AX=SIGX*AX
        AY=SIGY*AY
        AZ=SIGZ*AZ

        BXNERR=BX
        BYNERR=BY
        BZNERR=BZ
        AXNERR=AX
        AYNERR=AY
        AZNERR=AZ

        IF (IBERROR.NE.0) THEN
          CALL BERROR(X,Y,Z,BXE,BYE,BZE,AXE,AYE,AZE)
          BX=BX+BXE
          BY=BY+BYE
          BZ=BZ+BZE
          AX=AX+AXE
          AY=AY+AYE
          AZ=AZ+AZE
        ENDIF  !IBERROR

        IF (IBMASK.EQ.100) THEN

          IF (ICAL.EQ.0) THEN
            OPEN(UNIT=99,FILE='wave.bmask',STATUS='OLD')
            NBMASK=0
1           READ(99,*,END=9)BXX
            NBMASK=NBMASK+1
            IF (NBMASK.GT.10000) STOP '*** ERROR FOR BMASK: DIMENSION EXCEEDED'
            GOTO 1
9           REWIND(99)
            DO I=1,NBMASK
              READ(99,*)BMASK(1,I),BMASK(2,I),BMASK(3,I)
            ENDDO
            CLOSE(99)
            WRITE(LUNGFO,*)
            WRITE(LUNGFO,*)'      BMASK:'
            WRITE(LUNGFO,*)
            DO I=1,NBMASK
              WRITE(LUNGFO,*)BMASK(1,I),BMASK(2,I),BMASK(3,I)
            ENDDO
            WRITE(LUNGFO,*)
            DO I=1,NBMASK-1
              IF(BMASK(2,I).GT.BMASK(1,I+1)) THEN
                PRINT*,'*** WARNING FOR BMASK: OVERLAPPING INTERVALS'
                WRITE(LUNGFO,*)'*** WARNING FOR BMASK: OVERLAPPING INTERVALS'
              ENDIF
            ENDDO
          ENDIF !ICAL

          DO I=1,NBMASK
            IF (X.GE.BMASK(1,I).AND.X.LE.BMASK(2,I)) THEN
              BX=BX*BMASK(3,I)
              BY=BY*BMASK(3,I)
              BZ=BZ*BMASK(3,I)
            ENDIF
          ENDDO

        ELSE IF (IBMASK.eq.-100) THEN

          call ubmask(x,y,z,bxm,bym,bzm)

          BX=BX*BxM
          BY=BY*ByM
          BZ=BZ*BzM

        ELSE IF (IBMASK.eq.-200) THEN

          call ubmask(x,y,z,bxm,bym,bzm)

          BX=BX+BxM
          BY=BY+ByM
          BZ=BZ+BzM

        ELSE IF (IBMASK.LT.0) THEN

          CALL BFELD(BXM,BYM,BZM,X,Y,Z)
C MASK IS BYM! (BXM, BZM ARE ZERO)
          BY=BY+BYM

        ELSE IF (IBMASK.eq.10) THEN

          CALL BTAP(X,Y,Z,BXm,BYm,BZm,dum,dum,dum)

          Bx=Bx*BYM
          BY=BY*BYM
          Bz=Bz*BYM

        ELSE IF (IBMASK.gt.0) THEN

          CALL BFELD(BXM,BYM,BZM,X,Y,Z)
          Bx=Bx*BYM
          BY=BY*BYM
          Bz=Bz*BYM

        ELSE IF (ibmasksp.ne.0) THEN

          CALL BFELD(BXM,BYM,BZM,X,Y,Z)
          bx=bx+bxm
          by=by+bym
          bz=bz+bzm
          IF (KMAGSEQ.lt.0) THEN
            CALL BMAGSEQ(X,Y,Z,BXm,BYm,BZm,dum,dum,dum)
            bx=bx+bxm
            by=by+bym
            bz=bz+bzm
          endif
        ENDIF  !(IBMASK.NE.0)

100     BX=SIGX*BX
        BY=SIGY*BY+BYGOFF
        BZ=SIGZ*BZ+BZGOFF

C CHANGES HERE ACCORDING TO BFOUR (TAKE CARE OF DIFFERENT COORD.SYST.){



        AZ=AZ-BYGOFF*X
        AZ=AZ-BZGOFF*X
        IF (ICAL.EQ.0.AND.BZGOFF.NE.0.) THEN
          WRITE(LUNGFO,*)
     &      '*** WARNING IN MYBFELD: BZGOFF NOT ZERO'
          WRITE(LUNGFO,*)
     &      '*** NOT YET TESTED FOR THIS VECTOR-POTENTIAL ***'
          WRITE(LUNGFO,*)
     &      '*** SEE MYBFELD FOR DETAILS'
          WRITE(6,*)
     &      '*** WARNING IN MYBFELD: BZGOFF NOT ZERO'
          WRITE(6,*)
     &      '*** NOT YET TESTED FOR THIS VECTOR-POTENTIAL ***'
          WRITE(6,*)
     &      '*** SEE MYBFELD FOR DETAILS'
        ENDIF


C CHANGES HERE ACCORDING TO BFOUR }

        BX=BX*B0SCGLOB
        BY=BY*B0SCGLOB*B0SCGLOBY
        BZ=BZ*B0SCGLOB*B0SCGLOBZ

        AX=AX*A0SCGLOB
        AY=AY*A0SCGLOB*B0SCGLOBY
        AZ=AZ*A0SCGLOB*B0SCGLOBZ

        IF(IBSYM.NE.0.AND.(XI-XBSYM).LT.0.0) THEN
          AX= AX
          AY=-AY
          AZ=-AZ
          BX=-BX
          BY= BY
          BZ= BZ
        ENDIF

        IF(IBSYMY.NE.0.AND.YI.LT.0.0) THEN
          AX=-AX
          AY= AY
          AZ=-AZ
          BX= BX
          BY=-BY
          BZ= BZ
        ENDIF

        IF(IBSYMZ.NE.0.AND.ZI.LT.0.0) THEN
          AX=-AX
          AY=-AY
          AZ= AZ
          BX= BX
          BY= BY
          BZ=-BZ
        ENDIF

        IF(IBSYM.LT.0.AND.XI.LT.0.0) THEN
          AX=-AX
          AY=-AY
          AZ=-AZ
          BX=-BX
          BY=-BY
          BZ=-BZ
        ENDIF

        IF(IBSYMY.LT.0.AND.YI.LT.0.0) THEN
          AX=-AX
          AY=-AY
          AZ=-AZ
          BX=-BX
          BY=-BY
          BZ=-BZ
        ENDIF

        IF(IBSYMZ.LT.0.AND.ZI.LT.0.0) THEN
          AX=-AX
          AY=-AY
          AZ=-AZ
          BX=-BX
          BY=-BY
          BZ=-BZ
        ENDIF

1000  continue

      IF (JBMASK.EQ.100) THEN

        x=xiii

        IF (ICAL.EQ.0) THEN
          OPEN(UNIT=99,FILE='wave.bmask',STATUS='OLD')
          NBMASK=0
11        READ(99,*,END=91)BXX
          NBMASK=NBMASK+1
          IF (NBMASK.GT.10000) STOP '*** ERROR FOR BMASK: DIMENSION EXCEEDED'
          GOTO 11
91        REWIND(99)
          DO I=1,NBMASK
            READ(99,*)BMASK(1,I),BMASK(2,I),BMASK(3,I)
          ENDDO
          CLOSE(99)
          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'      BMASK:'
          WRITE(LUNGFO,*)
          DO I=1,NBMASK
            WRITE(LUNGFO,*)BMASK(1,I),BMASK(2,I),BMASK(3,I)
          ENDDO
          WRITE(LUNGFO,*)
          DO I=1,NBMASK-1
            IF(BMASK(2,I).GT.BMASK(1,I+1)) THEN
              PRINT*,'*** WARNING FOR BMASK: OVERLAPPING INTERVALS'
              WRITE(LUNGFO,*)'*** WARNING FOR BMASK: OVERLAPPING INTERVALS'
            ENDIF
          ENDDO
        ENDIF !ICAL

        DO I=1,NBMASK
          IF (X.GE.BMASK(1,I).AND.X.LE.BMASK(2,I)) THEN
            BX=BX*BMASK(3,I)
            BY=BY*BMASK(3,I)
            BZ=BZ*BMASK(3,I)
          ENDIF
        ENDDO

      ELSE IF (JBMASK.eq.-100) THEN

        call ubmask(x,y,z,bxm,bym,bzm)

        BX=BX*BxM
        BY=BY*ByM
        BZ=BZ*BzM

      ELSE IF (JBMASK.eq.-200) THEN

        call ubmask(x,y,z,bxm,bym,bzm)

        BX=BX+BxM
        BY=BY+ByM
        BZ=BZ+BzM

      ELSE IF (JBMASK.LT.0) THEN

        CALL BFELD(BXM,BYM,BZM,X,Y,Z)
C MASK IS BYM! (BXM, BZM ARE ZERO)
        BY=BY+BYM

      ELSE IF (ibmasksp.ne.0) THEN

        CALL BFELD(BXM,BYM,BZM,X,Y,Z)
        bx=bx+bxm
        by=by+bym
        bz=bz+bzm
        IF (KMAGSEQ.lt.0) THEN
          CALL BMAGSEQ(X,Y,Z,BXm,BYm,BZm,dum,dum,dum)
          bx=bx+bxm
          by=by+bym
          bz=bz+bzm
        endif
      ENDIF !(JBMASK.NE.0)

      ZD= CROTD*Z+SROTD*Y
      YD=-SROTD*Z+CROTD*Y
      Z=ZD
      Y=YD

      BZD= CROTD*BZ+SROTD*BY
      BYD=-SROTD*BZ+CROTD*BY
      BZ=BZD
      BY=BYD

      AZD= CROTD*AZ+SROTD*AY
      AYD=-SROTD*AZ+CROTD*AY
      AZ=AZD
      AY=AYD

      by=by*(1.0d0+btaperv*(xiii-xtaper))
      bz=bz*(1.0d0+btaperh*(xiii-xtaper))
      ay=ay*(1.0d0+btaperv*(xiii-xtaper))
      az=az*(1.0d0+btaperh*(xiii-xtaper))

      BB=BX*BX+BY*BY+BZ*BZ

      IF (BB.GT.BMAXGL2) THEN
        XBMAXGL=XIII
        YBMAXGL=YIII
        ZBMAXGL=ZIII
        BMAXGL2=BB
      ENDIF

      ICAL=1

      IF (IWARN.EQ.0) THEN
        IF (ABS(BX).GT.100.0D0
     &      .OR.
     &      ABS(BY).GT.100.0D0
     &      .OR.
     &      ABS(BZ).GT.100.0D0) THEN
          WRITE(6,*)
          WRITE(6,*)'*** WARNING IN MYBFELD:'
          WRITE(6,*)'MAGNETIC FIELD ABOVE 100 TESLA FOUND!'
          WRITE(6,*)'X:',XIII
          WRITE(6,*)'Y:',YIII
          WRITE(6,*)'Z:',ZIII
          WRITE(6,*)'BX:',BX
          WRITE(6,*)'BY:',BY
          WRITE(6,*)'BZ:',BZ
          WRITE(6,*)
          WRITE(6,*)'Tracking position and velocity vector:'
          WRITE(6,*)
          WRITE(6,*)'STEP:',ITRACK
          WRITE(6,*)'XTRACK:',XTRACK
          WRITE(6,*)'YTRACK:',YTRACK
          WRITE(6,*)'ZTRACK:',ZTRACK
          WRITE(6,*)'VXTRACK:',VXTRACK
          WRITE(6,*)'VYTRACK:',VYTRACK
          WRITE(6,*)'VZTRACK:',VZTRACK
          WRITE(6,*)'YPTRACK:',VYTRACK/VXTRACK
          WRITE(6,*)'ZPTRACK:',VZTRACK/VXTRACK
          WRITE(6,*)

          WRITE(LUNGFO,*)
          WRITE(LUNGFO,*)'*** WARNING IN MYBFELD:'
          WRITE(LUNGFO,*)'MAGNETIC FIELD ABOVE 100 TESLA FOUND!'
          WRITE(LUNGFO,*)'X:',XIII
          WRITE(LUNGFO,*)'Y:',YIII
          WRITE(LUNGFO,*)'Z:',ZIII
          WRITE(LUNGFO,*)'BX:',BX
          WRITE(LUNGFO,*)'BY:',BY
          WRITE(LUNGFO,*)'BZ:',BZ
          WRITE(LUNGFO,*)
          IWARN=1
        ENDIF
      ENDIF

      RETURN
      END
